import { round, isNumber } from 'lodash-es';
import { SECONDS } from '../app/constants/seconds';
import { parseDuration } from './parse-duration';
export function duration(time, options) {
    options = options || {};
    if (typeof options === 'string') {
        options = {
            seconds: !!options.match(/second/),
            minutes: !!options.match(/minute/),
            hours: !!options.match(/hour/),
            days: !!options.match(/day/),
            months: !!options.match(/month/),
            years: !!options.match(/year/),
        };
    }
    if (!isNumber(time)) {
        let parsedResult;
        parseDuration(time).subscribe((result) => {
            parsedResult = result;
        });
        if (parsedResult && parsedResult.error || !parsedResult.time) {
            return 'error';
        }
        else {
            time = parsedResult.time;
        }
        options.unit = 'seconds';
    }
    options = Object.assign({}, options);
    options.unit = options.unit === undefined ? 'seconds' : options.unit;
    options.abr = options.abr === undefined ? true : options.abr;
    options.suffix = options.suffix === true ? (time > 0 ? ' ago' : ' from now') : '';
    options.pad = options.pad === undefined ? false : options.pad;
    options.thousandsSeperator = options.thousandsSeperator === undefined ? true : options.thousandsSeperator;
    if (!options.seconds && !options.minutes && !options.hours && !options.days && !options.months && !options.years) {
        options.seconds = true;
        options.minutes = false;
        options.hours = false;
        options.days = false;
        options.months = false;
        options.years = false;
    }
    else {
        options.seconds = options.seconds === undefined ? false : options.seconds;
        options.minutes = options.minutes === undefined ? false : options.minutes;
        options.hours = options.hours === undefined ? false : options.hours;
        options.days = options.days === undefined ? false : options.days;
        options.months = options.months === undefined ? false : options.months;
        options.years = options.years === undefined ? false : options.years;
    }
    if (options.unit === 'minutes') {
        time = time * 60;
    }
    else if (options.unit === 'hours') {
        time = Math.round(time * 60 * 60);
    }
    time = Math.abs(parseInt(time));
    const units = {
        years: { abr: 'Y', single: 'year', plural: 'years', seconds: SECONDS.YEAR, next: 'months' },
        months: { abr: 'M', single: 'month', plural: 'months', seconds: SECONDS.MONTH, next: 'days' },
        days: { abr: 'd', single: 'day', plural: 'days', seconds: SECONDS.DAY, next: 'hours' },
        hours: { abr: 'h', single: 'hour', plural: 'hours', seconds: SECONDS.HOUR, next: 'months' },
        minutes: { abr: 'm', single: 'minute', plural: 'minutes', seconds: SECONDS.MINUTE, next: 'seconds' },
        seconds: { abr: 's', single: 'second', plural: 'seconds', seconds: 1, next: null },
    };
    const pieces = {
        years: 0,
        months: 0,
        days: 0,
        hours: 0,
        minutes: 0,
        seconds: 0
    };
    let remainder = time;
    if (options.years) {
        const years = remainder / SECONDS.YEAR;
        if (years >= 1) {
            if (!options.months && !options.days && !options.hours && !options.minutes && !options.seconds) {
                pieces.years = Math.round(years);
            }
            else {
                pieces.years = Math.floor(years);
            }
            remainder = remainder - (pieces.years * SECONDS.YEAR);
        }
    }
    if (options.months) {
        const months = remainder / SECONDS.MONTH;
        if (months >= 1) {
            if (!options.days && !options.hours && !options.minutes && !options.seconds) {
                pieces.months = Math.round(months);
            }
            else {
                pieces.months = Math.floor(months);
            }
            remainder = remainder - (pieces.months * SECONDS.MONTH);
        }
    }
    if (options.days) {
        const days = remainder / SECONDS.DAY;
        if (days >= 1) {
            if (!options.hours && !options.minutes && !options.seconds) {
                pieces.days = Math.round(days);
            }
            else {
                pieces.days = Math.floor(days);
            }
            remainder = remainder - (pieces.days * SECONDS.DAY);
        }
    }
    if (options.hours) {
        const hours = remainder / SECONDS.HOUR;
        if (hours >= 1) {
            if (!options.minutes && !options.seconds) {
                pieces.hours = Math.round(hours);
            }
            else {
                pieces.hours = Math.floor(hours);
            }
            remainder = remainder - (pieces.hours * SECONDS.HOUR);
        }
    }
    if (options.minutes) {
        const minutes = remainder / 60;
        if (minutes >= 1) {
            if (!options.seconds) {
                pieces.minutes = Math.round(minutes);
            }
            else {
                pieces.minutes = Math.floor(minutes);
            }
            remainder = remainder - (pieces.minutes * SECONDS.MINUTE);
        }
    }
    pieces.seconds = Math.round(remainder);
    const enabled = [];
    let totalSeconds = 0;
    for (const name in units) {
        if (units.hasOwnProperty(name)) {
            if (options[name]) {
                enabled.push(name);
            }
            totalSeconds += pieces[name] * units[name].seconds;
        }
    }
    let output = [];
    if (enabled.length === 1) {
        options.precision = options.precision === undefined ? 1 : options.precision;
        const name = enabled.join('');
        const value = numberFormat(totalSeconds / units[name]['seconds'], options);
        output.push(value + (options.abr ? units[name].abr : ' ' + (value == 1 ? units[name].single : units[name].plural)));
    }
    else {
        options.precision = options.precision === undefined ? enabled.length : options.precision;
        for (const name in units) {
            if (units.hasOwnProperty(name)) {
                if (options.precision && output.length >= options.precision) {
                    continue;
                }
                if (options[name]) {
                    let value = pieces[name];
                    if (value) {
                        output.push(numberFormat(value, options) + (options.abr ? units[name].abr : ' ' + (value == 1 ? units[name].single : units[name].plural)));
                    }
                }
            }
        }
    }
    // there are no values so show zero of the smallest unit (i.e. "0s")
    if (output.length === 0) {
        for (const name in units) {
            if (units.hasOwnProperty(name)) {
                if (options[name]) {
                    output = [numberFormat(0, options) + (options.abr ? units[name].abr : ' ' + (units[name] == 1 ? units[name].single : units[name].plural))];
                }
            }
        }
    }
    // to cut off output depends on maxOutput value
    if (options.maxOutputs && options.maxOutputs < output.length) {
        output = output.splice(0, options.maxOutputs);
    }
    // add suffix if required
    if (options.suffix) {
        output.push(options.suffix);
    }
    return output.join(' ');
}
function numberFormat(number, options = {}) {
    const precision = options.precision === undefined ? -1 : options.precision;
    const pad = options.pad === undefined ? false : options.pad;
    const thousandsSeperator = options.thousandsSeperator === undefined ? true : options.thousandsSeperator;
    if (thousandsSeperator) {
        if (precision >= 0) {
            number = round(number, precision);
        }
        return number.toLocaleString('en-US', { minimumFractionDigits: pad ? precision : 0 });
    }
    if (precision >= 0 && pad) {
        return number.toFixed(precision);
    }
    if (precision >= 0) {
        return round(number, precision);
    }
    return number;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHVyYXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGlicy9kdXJhdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUM1QyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpELE1BQU0sVUFBVSxRQUFRLENBQUMsSUFBUyxFQUFFLE9BQVE7SUFDeEMsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7SUFDeEIsSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLEVBQUU7UUFDL0IsT0FBTyxHQUFHO1lBQ1IsT0FBTyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQztZQUNsQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDO1lBQ2xDLEtBQUssRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFDOUIsSUFBSSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztZQUM1QixNQUFNLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO1lBQ2hDLEtBQUssRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7U0FDL0IsQ0FBQztLQUNIO0lBRUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUNuQixJQUFJLFlBQVksQ0FBQztRQUVqQixhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUU7WUFDNUMsWUFBWSxHQUFHLE1BQU0sQ0FBQztRQUN4QixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksWUFBWSxJQUFJLFlBQVksQ0FBQyxLQUFLLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFO1lBQzVELE9BQU8sT0FBTyxDQUFDO1NBQ2hCO2FBQU07WUFDTCxJQUFJLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztTQUMxQjtRQUNELE9BQU8sQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDO0tBQzFCO0lBRUQsT0FBTyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3JDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztJQUNyRSxPQUFPLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDN0QsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDbEYsT0FBTyxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDO0lBQzlELE9BQU8sQ0FBQyxrQkFBa0IsR0FBRyxPQUFPLENBQUMsa0JBQWtCLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsQ0FBQztJQUUxRyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFO1FBQ2hILE9BQU8sQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLE9BQU8sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3hCLE9BQU8sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ3RCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLE9BQU8sQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLE9BQU8sQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0tBQ3ZCO1NBQU07UUFDTCxPQUFPLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQyxPQUFPLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7UUFDMUUsT0FBTyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDO1FBQzFFLE9BQU8sQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztRQUNwRSxPQUFPLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDakUsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ3ZFLE9BQU8sQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMs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WUFDbEIsTUFBTSxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7U0FDbkM7UUFFRCxPQUFPLE1BQU0sQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLEVBQUUscUJBQXFCLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDdkY7SUFFRCxJQUFJLFNBQVMsSUFBSSxDQUFDLElBQUksR0FBRyxFQUFFO1FBQ3pCLE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUNsQztJQUVELElBQUksU0FBUyxJQUFJLENBQUMsRUFBRTtRQUNsQixPQUFPLEtBQUssQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUM7S0FDakM7SUFFRCxPQUFPLE1BQU0sQ0FBQztBQUNoQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcm91bmQsIGlzTnVtYmVyIH0gZnJvbSAnbG9kYXNoLWVzJztcbmltcG9ydCB7IFNFQ09ORFMgfSBmcm9tICcuLi9hcHAvY29uc3RhbnRzL3NlY29uZHMnO1xuaW1wb3J0IHsgcGFyc2VEdXJhdGlvbiB9IGZyb20gJy4vcGFyc2UtZHVyYXRpb24nO1xuXG5leHBvcnQgZnVuY3Rpb24gZHVyYXRpb24odGltZTogYW55LCBvcHRpb25zPykge1xuICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9O1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIG9wdGlvbnMgPSB7XG4gICAgICAgIHNlY29uZHM6ICEhb3B0aW9ucy5tYXRjaCgvc2Vjb25kLyksXG4gICAgICAgIG1pbnV0ZXM6ICEhb3B0aW9ucy5tYXRjaCgvbWludXRlLyksXG4gICAgICAgIGhvdXJzOiAhIW9wdGlvbnMubWF0Y2goL2hvdXIvKSxcbiAgICAgICAgZGF5czogISFvcHRpb25zLm1hdGNoKC9kYXkvKSxcbiAgICAgICAgbW9udGhzOiAhIW9wdGlvbnMubWF0Y2goL21vbnRoLyksXG4gICAgICAgIHllYXJzOiAhIW9wdGlvbnMubWF0Y2goL3llYXIvKSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgaWYgKCFpc051bWJlcih0aW1lKSkge1xuICAgICAgbGV0IHBhcnNlZFJlc3VsdDtcblxuICAgICAgcGFyc2VEdXJhdGlvbih0aW1lKS5zdWJzY3JpYmUoKHJlc3VsdDogYW55KSA9PiB7XG4gICAgICAgIHBhcnNlZFJlc3VsdCA9IHJlc3VsdDtcbiAgICAgIH0pO1xuXG4gICAgICBpZiAocGFyc2VkUmVzdWx0ICYmIHBhcnNlZFJlc3VsdC5lcnJvciB8fCAhcGFyc2VkUmVzdWx0LnRpbWUpIHtcbiAgICAgICAgcmV0dXJuICdlcnJvcic7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aW1lID0gcGFyc2VkUmVzdWx0LnRpbWU7XG4gICAgICB9XG4gICAgICBvcHRpb25zLnVuaXQgPSAnc2Vjb25kcyc7XG4gICAgfVxuXG4gICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMpO1xuICAgIG9wdGlvbnMudW5pdCA9IG9wdGlvbnMudW5pdCA9PT0gdW5kZWZpbmVkID8gJ3NlY29uZHMnIDogb3B0aW9ucy51bml0O1xuICAgIG9wdGlvbnMuYWJyID0gb3B0aW9ucy5hYnIgPT09IHVuZGVmaW5lZCA/IHRydWUgOiBvcHRpb25zLmFicjtcbiAgICBvcHRpb25zLnN1ZmZpeCA9IG9wdGlvbnMuc3VmZml4ID09PSB0cnVlID8gKHRpbWUgPiAwID8gJyBhZ28nIDogJyBmcm9tIG5vdycpIDogJyc7XG4gICAgb3B0aW9ucy5wYWQgPSBvcHRpb25zLnBhZCA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBvcHRpb25zLnBhZDtcbiAgICBvcHRpb25zLnRob3VzYW5kc1NlcGVyYXRvciA9IG9wdGlvbnMudGhvdXNhbmRzU2VwZXJhdG9yID09PSB1bmRlZmluZWQgPyB0cnVlIDogb3B0aW9ucy50aG91c2FuZHNTZXBlcmF0b3I7XG5cbiAgICBpZiAoIW9wdGlvbnMuc2Vjb25kcyAmJiAhb3B0aW9ucy5taW51dGVzICYmICFvcHRpb25zLmhvdXJzICYmICFvcHRpb25zLmRheXMgJiYgIW9wdGlvbnMubW9udGhzICYmICFvcHRpb25zLnllYXJzKSB7XG4gICAgICBvcHRpb25zLnNlY29uZHMgPSB0cnVlO1xuICAgICAgb3B0aW9ucy5taW51dGVzID0gZmFsc2U7XG4gICAgICBvcHRpb25zLmhvdXJzID0gZmFsc2U7XG4gICAgICBvcHRpb25zLmRheXMgPSBmYWxzZTtcbiAgICAgIG9wdGlvbnMubW9udGhzID0gZmFsc2U7XG4gICAgICBvcHRpb25zLnllYXJzID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIG9wdGlvbnMuc2Vjb25kcyA9IG9wdGlvbnMuc2Vjb25kcyA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBvcHRpb25zLnNlY29uZHM7XG4gICAgICBvcHRpb25zLm1pbnV0ZXMgPSBvcHRpb25zLm1pbnV0ZXMgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogb3B0aW9ucy5taW51dGVzO1xuICAgICAgb3B0aW9ucy5ob3VycyA9IG9wdGlvbnMuaG91cnMgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogb3B0aW9ucy5ob3VycztcbiAgICAgIG9wdGlvbnMuZGF5cyA9IG9wdGlvbnMuZGF5cyA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBvcHRpb25zLmRheXM7XG4gICAgICBvcHRpb25zLm1vbnRocyA9IG9wdGlvbnMubW9udGhzID09PSB1bmRlZmluZWQgPyBmYWxzZSA6IG9wdGlvbnMubW9udGhzO1xuICAgICAgb3B0aW9ucy55ZWFycyA9IG9wdGlvbnMueWVhcnMgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogb3B0aW9ucy55ZWFycztcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy51bml0ID09PSAnbWludXRlcycpIHtcbiAgICAgICAgdGltZSA9IHRpbWUgKiA2MDtcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMudW5pdCA9PT0gJ2hvdXJzJykge1xuICAgICAgICB0aW1lID0gTWF0aC5yb3VuZCh0aW1lICogNjAgKiA2MCk7XG4gICAgfVxuXG4gICAgdGltZSA9IE1hdGguYWJzKHBhcnNlSW50KHRpbWUpKTtcblxuICAgIGNvbnN0IHVuaXRzID0ge1xuICAgICAgICB5ZWFyczogICAgICB7IGFicjogJ1knLCBzaW5nbGU6ICd5ZWFyJywgcGx1cmFsOiAneWVhcnMnLCBzZWNvbmRzOiBTRUNPTkRTLllFQVIsIG5leHQ6ICdtb250aHMnIH0sXG4gICAgICAgIG1vbnRoczogICAgIHsgYWJyOiAnTScsIHNpbmdsZTogJ21vbnRoJywgcGx1cmFsOiAnbW9udGhzJywgc2Vjb25kczogU0VDT05EUy5NT05USCwgbmV4dDogJ2RheXMnIH0sXG4gICAgICAgIGRheXM6ICAgICAgIHsgYWJyOiAnZCcsIHNpbmdsZTogJ2RheScsIHBsdXJhbDogJ2RheXMnLCBzZWNvbmRzOiBTRUNPTkRTLkRBWSwgbmV4dDogJ2hvdXJzJyB9LFxuICAgICAgICBob3VyczogICAgICB7IGFicjogJ2gnLCBzaW5nbGU6ICdob3VyJywgcGx1cmFsOiAnaG91cnMnLCBzZWNvbmRzOiBTRUNPTkRTLkhPVVIsIG5leHQ6ICdtb250aHMnIH0sXG4gICAgICAgIG1pbnV0ZXM6ICAgIHsgYWJyOiAnbScsIHNpbmdsZTogJ21pbnV0ZScsIHBsdXJhbDogJ21pbnV0ZXMnLCBzZWNvbmRzOiBTRUNPTkRTLk1JTlVURSwgbmV4dDogJ3NlY29uZHMnIH0sXG4gICAgICAgIHNlY29uZHM6ICAgIHsgYWJyOiAncycsIHNpbmdsZTogJ3NlY29uZCcsIHBsdXJhbDogJ3NlY29uZHMnLCBzZWNvbmRzOiAxLCBuZXh0OiBudWxsIH0sXG4gICAgfTtcblxuICAgIGNvbnN0IHBpZWNlcyA9IHtcbiAgICAgICAgeWVhcnM6IDAsXG4gICAgICAgIG1vbnRoczogMCxcbiAgICAgICAgZGF5czogMCxcbiAgICAgICAgaG91cnM6IDAsXG4gICAgICAgIG1pbnV0ZXM6IDAsXG4gICAgICAgIHNlY29uZHM6IDBcbiAgICB9O1xuXG4gICAgbGV0IHJlbWFpbmRlciA9IHRpbWU7XG5cbiAgICBpZiAob3B0aW9ucy55ZWFycykge1xuICAgICAgY29uc3QgeWVhcnMgPSByZW1haW5kZXIgLyBTRUNPTkRTLllFQVI7XG4gICAgICBpZiAoeWVhcnMgPj0gMSkge1xuICAgICAgICBpZiAoIW9wdGlvbnMubW9udGhzICYmICFvcHRpb25zLmRheXMgJiYgIW9wdGlvbnMuaG91cnMgJiYgIW9wdGlvbnMubWludXRlcyAmJiAhb3B0aW9ucy5zZWNvbmRzKSB7XG4gICAgICAgICAgcGllY2VzLnllYXJzID0gTWF0aC5yb3VuZCh5ZWFycyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcGllY2VzLnllYXJzID0gTWF0aC5mbG9vcih5ZWFycyk7XG4gICAgICAgIH1cbiAgICAgICAgcmVtYWluZGVyID0gcmVtYWluZGVyIC0gKHBpZWNlcy55ZWFycyAqIFNFQ09ORFMuWUVBUik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMubW9udGhzKSB7XG4gICAgICBjb25zdCBtb250aHMgPSByZW1haW5kZXIgLyBTRUNPTkRTLk1PTlRIO1xuICAgICAgaWYgKG1vbnRocyA+PSAxKSB7XG4gICAgICAgIGlmICghb3B0aW9ucy5kYXlzICYmICFvcHRpb25zLmhvdXJzICYmICFvcHRpb25zLm1pbnV0ZXMgJiYgIW9wdGlvbnMuc2Vjb25kcykge1xuICAgICAgICAgIHBpZWNlcy5tb250aHMgPSBNYXRoLnJvdW5kKG1vbnRocyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcGllY2VzLm1vbnRocyA9IE1hdGguZmxvb3IobW9udGhzKTtcbiAgICAgICAgfVxuICAgICAgICByZW1haW5kZXIgPSByZW1haW5kZXIgLSAocGllY2VzLm1vbnRocyAqIFNFQ09ORFMuTU9OVEgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmRheXMpIHtcbiAgICAgIGNvbnN0IGRheXMgPSByZW1haW5kZXIgLyBTRUNPTkRTLkRBWTtcbiAgICAgIGlmIChkYXlzID49IDEpIHtcbiAgICAgICAgaWYgKCFvcHRpb25zLmhvdXJzICYmICFvcHRpb25zLm1pbnV0ZXMgJiYgIW9wdGlvbnMuc2Vjb25kcykge1xuICAgICAgICAgIHBpZWNlcy5kYXlzID0gTWF0aC5yb3VuZChkYXlzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwaWVjZXMuZGF5cyA9IE1hdGguZmxvb3IoZGF5cyk7XG4gICAgICAgIH1cbiAgICAgICAgcmVtYWluZGVyID0gcmVtYWluZGVyIC0gKHBpZWNlcy5kYXlzICogU0VDT05EUy5EQVkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmhvdXJzKSB7XG4gICAgICBjb25zdCBob3VycyA9IHJlbWFpbmRlciAvIFNFQ09ORFMuSE9VUjtcbiAgICAgIGlmIChob3VycyA+PSAxKSB7XG4gICAgICAgIGlmICghb3B0aW9ucy5taW51dGVzICYmICFvcHRpb25zLnNlY29uZHMpIHtcbiAgICAgICAgICBwaWVjZXMuaG91cnMgPSBNYXRoLnJvdW5kKGhvdXJzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBwaWVjZXMuaG91cnMgPSBNYXRoLmZsb29yKGhvdXJzKTtcbiAgICAgICAgfVxuICAgICAgICByZW1haW5kZXIgPSByZW1haW5kZXIgLSAocGllY2VzLmhvdXJzICogU0VDT05EUy5IT1VSKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5taW51dGVzKSB7XG4gICAgICBjb25zdCBtaW51dGVzID0gcmVtYWluZGVyIC8gNjA7XG4gICAgICBpZiAobWludXRlcyA+PSAxKSB7XG4gICAgICAgIGlmICghb3B0aW9ucy5zZWNvbmRzKSB7XG4gICAgICAgICAgcGllY2VzLm1pbnV0ZXMgPSBNYXRoLnJvdW5kKG1pbnV0ZXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHBpZWNlcy5taW51dGVzID0gTWF0aC5mbG9vcihtaW51dGVzKTtcbiAgICAgICAgfVxuICAgICAgICByZW1haW5kZXIgPSByZW1haW5kZXIgLSAocGllY2VzLm1pbnV0ZXMgKiBTRUNPTkRTLk1JTlVURSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcGllY2VzLnNlY29uZHMgPSBNYXRoLnJvdW5kKHJlbWFpbmRlcik7XG5cbiAgICBjb25zdCBlbmFibGVkID0gW107XG4gICAgbGV0IHRvdGFsU2Vjb25kcyA9IDA7XG4gICAgZm9yIChjb25zdCBuYW1lIGluIHVuaXRzKSB7XG4gICAgICBpZiAodW5pdHMuaGFzT3duUHJvcGVydHkobmFtZSkpIHtcbiAgICAgICAgaWYgKG9wdGlvbnNbbmFtZV0pIHtcbiAgICAgICAgICBlbmFibGVkLnB1c2gobmFtZSk7XG4gICAgICAgIH1cbiAgICAgICAgdG90YWxTZWNvbmRzICs9IHBpZWNlc1tuYW1lXSAqIHVuaXRzW25hbWVdLnNlY29uZHM7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IG91dHB1dCA9IFtdO1xuXG4gICAgaWYgKGVuYWJsZWQubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIG9wdGlvbnMucHJlY2lzaW9uID0gb3B0aW9ucy5wcmVjaXNpb24gPT09IHVuZGVmaW5lZCA/IDEgOiBvcHRpb25zLnByZWNpc2lvbjtcbiAgICAgICAgY29uc3QgbmFtZSA9IGVuYWJsZWQuam9pbignJyk7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gbnVtYmVyRm9ybWF0KHRvdGFsU2Vjb25kcyAvIHVuaXRzW25hbWVdWydzZWNvbmRzJ10sIG9wdGlvbnMpO1xuICAgICAgICBvdXRwdXQucHVzaCh2YWx1ZSArIChvcHRpb25zLmFiciA/IHVuaXRzW25hbWVdLmFiciA6ICAnICcgKyAodmFsdWUgPT0gMSA/IHVuaXRzW25hbWVdLnNpbmdsZSA6IHVuaXRzW25hbWVdLnBsdXJhbCkpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBvcHRpb25zLnByZWNpc2lvbiA9IG9wdGlvbnMucHJlY2lzaW9uID09PSB1bmRlZmluZWQgPyBlbmFibGVkLmxlbmd0aCA6IG9wdGlvbnMucHJlY2lzaW9uO1xuXG4gICAgICAgIGZvciAoY29uc3QgbmFtZSBpbiB1bml0cykge1xuICAgICAgICAgIGlmICh1bml0cy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMucHJlY2lzaW9uICYmIG91dHB1dC5sZW5ndGggPj0gb3B0aW9ucy5wcmVjaXNpb24pIHtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChvcHRpb25zW25hbWVdKSB7XG4gICAgICAgICAgICAgIGxldCB2YWx1ZSA9IHBpZWNlc1tuYW1lXTtcbiAgICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaChudW1iZXJGb3JtYXQodmFsdWUsIG9wdGlvbnMpICsgKG9wdGlvbnMuYWJyID8gdW5pdHNbbmFtZV0uYWJyIDogICcgJyArICh2YWx1ZSA9PSAxID8gdW5pdHNbbmFtZV0uc2luZ2xlIDogdW5pdHNbbmFtZV0ucGx1cmFsKSkpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gdGhlcmUgYXJlIG5vIHZhbHVlcyBzbyBzaG93IHplcm8gb2YgdGhlIHNtYWxsZXN0IHVuaXQgKGkuZS4gXCIwc1wiKVxuICAgIGlmIChvdXRwdXQubGVuZ3RoID09PSAwKSB7XG4gICAgICBmb3IgKGNvbnN0IG5hbWUgaW4gdW5pdHMpIHtcbiAgICAgICAgaWYgKHVuaXRzLmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgICAgaWYgKG9wdGlvbnNbbmFtZV0pIHtcbiAgICAgICAgICAgIG91dHB1dCA9IFsgbnVtYmVyRm9ybWF0KDAsIG9wdGlvbnMpICsgKG9wdGlvbnMuYWJyID8gdW5pdHNbbmFtZV0uYWJyIDogICcgJyArICh1bml0c1tuYW1lXSA9PSAxID8gdW5pdHNbbmFtZV0uc2luZ2xlIDogdW5pdHNbbmFtZV0ucGx1cmFsKSkgXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB0byBjdXQgb2ZmIG91dHB1dCBkZXBlbmRzIG9uIG1heE91dHB1dCB2YWx1ZVxuICAgIGlmIChvcHRpb25zLm1heE91dHB1dHMgJiYgb3B0aW9ucy5tYXhPdXRwdXRzIDwgb3V0cHV0Lmxlbmd0aCkge1xuICAgICAgb3V0cHV0ID0gb3V0cHV0LnNwbGljZSgwLCBvcHRpb25zLm1heE91dHB1dHMpO1xuICAgIH1cblxuICAgIC8vIGFkZCBzdWZmaXggaWYgcmVxdWlyZWRcbiAgICBpZiAob3B0aW9ucy5zdWZmaXgpIHtcbiAgICAgIG91dHB1dC5wdXNoKG9wdGlvbnMuc3VmZml4KTtcbiAgICB9XG5cbiAgICByZXR1cm4gb3V0cHV0LmpvaW4oJyAnKTtcbn1cblxuXG5mdW5jdGlvbiBudW1iZXJGb3JtYXQobnVtYmVyLCBvcHRpb25zOiBhbnkgPSB7fSkge1xuICBjb25zdCBwcmVjaXNpb24gPSBvcHRpb25zLnByZWNpc2lvbiA9PT0gdW5kZWZpbmVkID8gLTEgOiBvcHRpb25zLnByZWNpc2lvbjtcbiAgY29uc3QgcGFkID0gb3B0aW9ucy5wYWQgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogb3B0aW9ucy5wYWQ7XG4gIGNvbnN0IHRob3VzYW5kc1NlcGVyYXRvciA9IG9wdGlvbnMudGhvdXNhbmRzU2VwZXJhdG9yID09PSB1bmRlZmluZWQgPyB0cnVlIDogb3B0aW9ucy50aG91c2FuZHNTZXBlcmF0b3I7XG5cbiAgaWYodGhvdXNhbmRzU2VwZXJhdG9yKSB7XG4gICAgaWYgKHByZWNpc2lvbiA+PSAwKSB7XG4gICAgICBudW1iZXIgPSByb3VuZChudW1iZXIsIHByZWNpc2lvbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bWJlci50b0xvY2FsZVN0cmluZygnZW4tVVMnLCB7IG1pbmltdW1GcmFjdGlvbkRpZ2l0czogcGFkID8gcHJlY2lzaW9uIDogMCB9KTtcbiAgfVxuXG4gIGlmIChwcmVjaXNpb24gPj0gMCAmJiBwYWQpIHtcbiAgICByZXR1cm4gbnVtYmVyLnRvRml4ZWQocHJlY2lzaW9uKTtcbiAgfVxuXG4gIGlmIChwcmVjaXNpb24gPj0gMCkge1xuICAgIHJldHVybiByb3VuZChudW1iZXIsIHByZWNpc2lvbik7XG4gIH1cblxuICByZXR1cm4gbnVtYmVyO1xufVxuIl19