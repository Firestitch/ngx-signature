import { ChangeDetectionStrategy, ChangeDetectorRef, Component, ElementRef, Input, } from '@angular/core';
import { interval, Subject } from 'rxjs';
import { takeWhile, takeUntil } from 'rxjs/operators';
import { differenceInSeconds } from 'date-fns';
import { ago, duration as fsDuration, format as fsFormat, parse } from '../../../libs';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/tooltip";
export class FsDateAgoComponent {
    constructor(elementRef, _cd) {
        this.elementRef = elementRef;
        this._cd = _cd;
        this.showTime = false;
        this.format = 'date';
        this.showTooltip = true;
        this.tooltipDateFormat = null;
        this.formattedDate = null;
        this.tooltip = null;
        this._period = 60;
        this._destroy$ = new Subject();
        this._date = null;
    }
    set date(value) {
        this._date = parse(value);
    }
    get date() {
        return this._date;
    }
    ngOnInit() {
        this._init();
    }
    ngOnChanges() {
        this._init();
    }
    ngOnDestroy() {
        this._destroy$.next();
        this._destroy$.complete();
    }
    updateFormatted() {
        this.formattedDate = ago(this.date, this.format);
        if (this.showTooltip) {
            const tooltipFormat = this.getTooltipFormat();
            const tooltipAgo = this.getTooltipAgo();
            this.tooltip = fsFormat(this.date, tooltipFormat) + ' · ' + tooltipAgo;
        }
        this._cd.markForCheck();
    }
    /**
     * Setting format w/o year if year is the same
     */
    getTooltipFormat() {
        if (this.tooltipDateFormat) {
            return this.tooltipDateFormat;
        }
        let format = 'date-time';
        const todayYear = new Date().getFullYear();
        const dateYear = new Date(this.date).getFullYear();
        if (todayYear === dateYear) {
            format = 'date-time-yearless';
        }
        return format;
    }
    /**
     * Forming second part of the tooltip
     */
    getTooltipAgo() {
        let tooltip = 'now';
        if (!this.date) {
            return '';
        }
        const dateDifference = this._difference(this.date);
        const options = {
            maxOutputs: 1,
            suffix: true,
            years: true,
            months: true,
            days: true,
            hours: true,
            minutes: true
        };
        // if difference more than 1 minute
        if (dateDifference > 59 || dateDifference < 0) {
            tooltip = fsDuration(dateDifference, options);
        }
        return tooltip;
    }
    _init() {
        this.updateFormatted();
        if (this._updateWhile(this.date) && !this._timer$) {
            this._timerInit();
        }
    }
    _timerInit() {
        this._timer$ = interval(this._period * 1000)
            .pipe(takeWhile((v, index) => this._updateWhile(this.date)), takeUntil(this._destroy$));
        this._timer$
            .subscribe({
            next: () => {
                this.updateFormatted();
            },
            complete: () => {
                this._timer$ = null;
            },
        });
    }
    _difference(date) {
        return differenceInSeconds(new Date(), date);
    }
    _updateWhile(date) {
        return Math.abs(this._difference(date)) <= (86400 + this._period);
    }
}
FsDateAgoComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDateAgoComponent, deps: [{ token: i0.ElementRef }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component });
FsDateAgoComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: FsDateAgoComponent, selector: "fs-date-ago", inputs: { date: "date", showTime: "showTime", format: "format", showTooltip: "showTooltip", tooltipDateFormat: "tooltipDateFormat" }, usesOnChanges: true, ngImport: i0, template: "<span [matTooltip]=\"tooltip\">{{ formattedDate }}</span>\n", directives: [{ type: i1.MatTooltip, selector: "[matTooltip]", exportAs: ["matTooltip"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDateAgoComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'fs-date-ago',
                    templateUrl: './date-ago.component.html',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.ChangeDetectorRef }]; }, propDecorators: { date: [{
                type: Input
            }], showTime: [{
                type: Input
            }], format: [{
                type: Input
            }], showTooltip: [{
                type: Input
            }], tooltipDateFormat: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1hZ28uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9jb21wb25lbnRzL2RhdGUtYWdvL2RhdGUtYWdvLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3NyYy9hcHAvY29tcG9uZW50cy9kYXRlLWFnby9kYXRlLWFnby5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLEtBQUssR0FJTixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQWMsUUFBUSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNyRCxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXRELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUUvQyxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsSUFBSSxVQUFVLEVBQUUsTUFBTSxJQUFJLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUM7OztBQVF2RixNQUFNLE9BQU8sa0JBQWtCO0lBd0I3QixZQUNTLFVBQXNCLEVBQ3JCLEdBQXNCO1FBRHZCLGVBQVUsR0FBVixVQUFVLENBQVk7UUFDckIsUUFBRyxHQUFILEdBQUcsQ0FBbUI7UUFqQmhCLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDakIsV0FBTSxHQUFHLE1BQU0sQ0FBQztRQUNoQixnQkFBVyxHQUFHLElBQUksQ0FBQztRQUVuQixzQkFBaUIsR0FBVyxJQUFJLENBQUM7UUFFMUMsa0JBQWEsR0FBVyxJQUFJLENBQUM7UUFDN0IsWUFBTyxHQUFXLElBQUksQ0FBQztRQUV0QixZQUFPLEdBQUcsRUFBRSxDQUFDO1FBR2IsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFDMUIsVUFBSyxHQUFTLElBQUksQ0FBQztJQUt2QixDQUFDO0lBekJMLElBQ1csSUFBSSxDQUFDLEtBQUs7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUNELElBQVcsSUFBSTtRQUNiLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBcUJNLFFBQVE7UUFDYixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRU0sV0FBVztRQUNoQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRU0sV0FBVztRQUNoQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDNUIsQ0FBQztJQUVPLGVBQWU7UUFDckIsSUFBSSxDQUFDLGFBQWEsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFakQsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ3BCLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQzlDLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUV4QyxJQUFJLENBQUMsT0FBTyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxHQUFHLEtBQUssR0FBRyxVQUFVLENBQUM7U0FDeEU7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNLLGdCQUFnQjtRQUV0QixJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUMxQixPQUFPLElBQUksQ0FBQyxpQkFBaUIsQ0FBQztTQUMvQjtRQUVELElBQUksTUFBTSxHQUFHLFdBQVcsQ0FBQztRQUN6QixNQUFNLFNBQVMsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzNDLE1BQU0sUUFBUSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUVuRCxJQUFJLFNBQVMsS0FBSyxRQUFRLEVBQUU7WUFDMUIsTUFBTSxHQUFHLG9CQUFvQixDQUFDO1NBQy9CO1FBRUQsT0FBTyxNQUFNLENBQUE7SUFDZixDQUFDO0lBRUQ7O09BRUc7SUFDSyxhQUFhO1FBQ25CLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztRQUVwQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNkLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFFRCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVuRCxNQUFNLE9BQU8sR0FBRztZQUNkLFVBQVUsRUFBRSxDQUFDO1lBQ2IsTUFBTSxFQUFFLElBQUk7WUFDWixLQUFLLEVBQUUsSUFBSTtZQUNYLE1BQU0sRUFBRSxJQUFJO1lBQ1osSUFBSSxFQUFFLElBQUk7WUFDVixLQUFLLEVBQUUsSUFBSTtZQUNYLE9BQU8sRUFBRSxJQUFJO1NBQ2QsQ0FBQztRQUVGLG1DQUFtQztRQUNuQyxJQUFJLGNBQWMsR0FBRyxFQUFFLElBQUksY0FBYyxHQUFHLENBQUMsRUFBRTtZQUM3QyxPQUFPLEdBQUcsVUFBVSxDQUFDLGNBQWMsRUFBRSxPQUFPLENBQUMsQ0FBQTtTQUM5QztRQUVELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFTyxLQUFLO1FBQ1gsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3ZCLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2pELElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUNuQjtJQUNILENBQUM7SUFFTyxVQUFVO1FBQ2hCLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO2FBQ3pDLElBQUksQ0FDSCxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUNyRCxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUMxQixDQUFDO1FBRUosSUFBSSxDQUFDLE9BQU87YUFDVCxTQUFTLENBQUM7WUFDVCxJQUFJLEVBQUUsR0FBRyxFQUFFO2dCQUNULElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN6QixDQUFDO1lBQ0QsUUFBUSxFQUNOLEdBQUcsRUFBRTtnQkFDSCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztZQUN0QixDQUFDO1NBQ0osQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVPLFdBQVcsQ0FBQyxJQUFVO1FBQzVCLE9BQU8sbUJBQW1CLENBQUMsSUFBSSxJQUFJLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRU8sWUFBWSxDQUFDLElBQVU7UUFDN0IsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDcEUsQ0FBQzs7Z0hBeElVLGtCQUFrQjtvR0FBbEIsa0JBQWtCLDhNQ3hCL0IsNkRBQ0E7NEZEdUJhLGtCQUFrQjtrQkFMOUIsU0FBUzttQkFBQztvQkFDVCxRQUFRLEVBQUUsYUFBYTtvQkFDdkIsV0FBVyxFQUFFLDJCQUEyQjtvQkFDeEMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07aUJBQ2hEO2lJQUlZLElBQUk7c0JBRGQsS0FBSztnQkFPVSxRQUFRO3NCQUF2QixLQUFLO2dCQUNVLE1BQU07c0JBQXJCLEtBQUs7Z0JBQ1UsV0FBVztzQkFBMUIsS0FBSztnQkFFVSxpQkFBaUI7c0JBQWhDLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25Jbml0LFxuICBPbkRlc3Ryb3ksXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBpbnRlcnZhbCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFrZVdoaWxlLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IGRpZmZlcmVuY2VJblNlY29uZHMgfSBmcm9tICdkYXRlLWZucyc7XG5cbmltcG9ydCB7IGFnbywgZHVyYXRpb24gYXMgZnNEdXJhdGlvbiwgZm9ybWF0IGFzIGZzRm9ybWF0LCBwYXJzZSB9IGZyb20gJy4uLy4uLy4uL2xpYnMnO1xuXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2ZzLWRhdGUtYWdvJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2RhdGUtYWdvLmNvbXBvbmVudC5odG1sJyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIEZzRGF0ZUFnb0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBzZXQgZGF0ZSh2YWx1ZSkge1xuICAgIHRoaXMuX2RhdGUgPSBwYXJzZSh2YWx1ZSk7XG4gIH1cbiAgcHVibGljIGdldCBkYXRlKCk6IERhdGUge1xuICAgIHJldHVybiB0aGlzLl9kYXRlO1xuICB9XG4gIEBJbnB1dCgpIHB1YmxpYyBzaG93VGltZSA9IGZhbHNlO1xuICBASW5wdXQoKSBwdWJsaWMgZm9ybWF0ID0gJ2RhdGUnO1xuICBASW5wdXQoKSBwdWJsaWMgc2hvd1Rvb2x0aXAgPSB0cnVlO1xuXG4gIEBJbnB1dCgpIHB1YmxpYyB0b29sdGlwRGF0ZUZvcm1hdDogc3RyaW5nID0gbnVsbDtcblxuICBwdWJsaWMgZm9ybWF0dGVkRGF0ZTogc3RyaW5nID0gbnVsbDtcbiAgcHVibGljIHRvb2x0aXA6IHN0cmluZyA9IG51bGw7XG5cbiAgcHJpdmF0ZSBfcGVyaW9kID0gNjA7XG4gIHByaXZhdGUgX3RpbWVyJDogT2JzZXJ2YWJsZTxudW1iZXI+O1xuXG4gIHByaXZhdGUgX2Rlc3Ryb3kkID0gbmV3IFN1YmplY3QoKTtcbiAgcHJpdmF0ZSBfZGF0ZTogRGF0ZSA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBfY2Q6IENoYW5nZURldGVjdG9yUmVmLFxuICApIHsgfVxuXG4gIHB1YmxpYyBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLl9pbml0KCk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkNoYW5nZXMoKSB7XG4gICAgdGhpcy5faW5pdCgpO1xuICB9XG5cbiAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX2Rlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLl9kZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVGb3JtYXR0ZWQoKSB7XG4gICAgdGhpcy5mb3JtYXR0ZWREYXRlID0gYWdvKHRoaXMuZGF0ZSwgdGhpcy5mb3JtYXQpO1xuXG4gICAgaWYgKHRoaXMuc2hvd1Rvb2x0aXApIHtcbiAgICAgIGNvbnN0IHRvb2x0aXBGb3JtYXQgPSB0aGlzLmdldFRvb2x0aXBGb3JtYXQoKTtcbiAgICAgIGNvbnN0IHRvb2x0aXBBZ28gPSB0aGlzLmdldFRvb2x0aXBBZ28oKTtcblxuICAgICAgdGhpcy50b29sdGlwID0gZnNGb3JtYXQodGhpcy5kYXRlLCB0b29sdGlwRm9ybWF0KSArICcgwrcgJyArIHRvb2x0aXBBZ287XG4gICAgfVxuICAgIHRoaXMuX2NkLm1hcmtGb3JDaGVjaygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHRpbmcgZm9ybWF0IHcvbyB5ZWFyIGlmIHllYXIgaXMgdGhlIHNhbWVcbiAgICovXG4gIHByaXZhdGUgZ2V0VG9vbHRpcEZvcm1hdCgpOiBzdHJpbmcge1xuXG4gICAgaWYgKHRoaXMudG9vbHRpcERhdGVGb3JtYXQpIHtcbiAgICAgIHJldHVybiB0aGlzLnRvb2x0aXBEYXRlRm9ybWF0O1xuICAgIH1cblxuICAgIGxldCBmb3JtYXQgPSAnZGF0ZS10aW1lJztcbiAgICBjb25zdCB0b2RheVllYXIgPSBuZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCk7XG4gICAgY29uc3QgZGF0ZVllYXIgPSBuZXcgRGF0ZSh0aGlzLmRhdGUpLmdldEZ1bGxZZWFyKCk7XG5cbiAgICBpZiAodG9kYXlZZWFyID09PSBkYXRlWWVhcikge1xuICAgICAgZm9ybWF0ID0gJ2RhdGUtdGltZS15ZWFybGVzcyc7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZvcm1hdFxuICB9XG5cbiAgLyoqXG4gICAqIEZvcm1pbmcgc2Vjb25kIHBhcnQgb2YgdGhlIHRvb2x0aXBcbiAgICovXG4gIHByaXZhdGUgZ2V0VG9vbHRpcEFnbygpOiBzdHJpbmcge1xuICAgIGxldCB0b29sdGlwID0gJ25vdyc7XG5cbiAgICBpZiAoIXRoaXMuZGF0ZSkge1xuICAgICAgcmV0dXJuICcnO1xuICAgIH1cblxuICAgIGNvbnN0IGRhdGVEaWZmZXJlbmNlID0gdGhpcy5fZGlmZmVyZW5jZSh0aGlzLmRhdGUpO1xuXG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIG1heE91dHB1dHM6IDEsXG4gICAgICBzdWZmaXg6IHRydWUsXG4gICAgICB5ZWFyczogdHJ1ZSxcbiAgICAgIG1vbnRoczogdHJ1ZSxcbiAgICAgIGRheXM6IHRydWUsXG4gICAgICBob3VyczogdHJ1ZSxcbiAgICAgIG1pbnV0ZXM6IHRydWVcbiAgICB9O1xuXG4gICAgLy8gaWYgZGlmZmVyZW5jZSBtb3JlIHRoYW4gMSBtaW51dGVcbiAgICBpZiAoZGF0ZURpZmZlcmVuY2UgPiA1OSB8fCBkYXRlRGlmZmVyZW5jZSA8IDApIHtcbiAgICAgIHRvb2x0aXAgPSBmc0R1cmF0aW9uKGRhdGVEaWZmZXJlbmNlLCBvcHRpb25zKVxuICAgIH1cblxuICAgIHJldHVybiB0b29sdGlwO1xuICB9XG5cbiAgcHJpdmF0ZSBfaW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLnVwZGF0ZUZvcm1hdHRlZCgpO1xuICAgIGlmICh0aGlzLl91cGRhdGVXaGlsZSh0aGlzLmRhdGUpICYmICF0aGlzLl90aW1lciQpIHtcbiAgICAgIHRoaXMuX3RpbWVySW5pdCgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgX3RpbWVySW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLl90aW1lciQgPSBpbnRlcnZhbCh0aGlzLl9wZXJpb2QgKiAxMDAwKVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2VXaGlsZSgodiwgaW5kZXgpID0+IHRoaXMuX3VwZGF0ZVdoaWxlKHRoaXMuZGF0ZSkpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgICAgKTtcblxuICAgIHRoaXMuX3RpbWVyJFxuICAgICAgLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6ICgpID0+IHtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUZvcm1hdHRlZCgpO1xuICAgICAgICB9LFxuICAgICAgICBjb21wbGV0ZTpcbiAgICAgICAgICAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLl90aW1lciQgPSBudWxsO1xuICAgICAgICAgIH0sXG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX2RpZmZlcmVuY2UoZGF0ZTogRGF0ZSk6IG51bWJlciB7XG4gICAgcmV0dXJuIGRpZmZlcmVuY2VJblNlY29uZHMobmV3IERhdGUoKSwgZGF0ZSk7XG4gIH1cblxuICBwcml2YXRlIF91cGRhdGVXaGlsZShkYXRlOiBEYXRlKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIE1hdGguYWJzKHRoaXMuX2RpZmZlcmVuY2UoZGF0ZSkpIDw9ICg4NjQwMCArIHRoaXMuX3BlcmlvZCk7XG4gIH1cblxufVxuIiwiPHNwYW4gW21hdFRvb2x0aXBdPVwidG9vbHRpcFwiPnt7IGZvcm1hdHRlZERhdGUgfX08L3NwYW4+XG4iXX0=