import { ChangeDetectionStrategy, ChangeDetectorRef, Component, ContentChild, ElementRef, forwardRef, HostBinding, Input, TemplateRef, ViewChild } from '@angular/core';
import { fromEvent, merge, Subject } from 'rxjs';
import { filter, takeUntil, tap } from 'rxjs/operators';
import { NG_VALUE_ACCESSOR } from '@angular/forms';
import { ScrollPickerTemplateComponent } from '../../directives/scroll-picker-template.directive';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export class ScrollPickerComponent {
    constructor(_cdRef) {
        this._cdRef = _cdRef;
        this.values = [];
        this.displayValues = [];
        this.hideCursor = false;
        this._wheelDelta = 0;
        this._touchDelta = 0;
        this._mouseDelta = 0;
        this._touchY = 0;
        this._mouseY = 0;
        this._destroy$ = new Subject();
        this._onTouched = () => { };
        this._onChange = (value) => { };
    }
    ngOnInit() {
        this.valuesEl = this.scrollContainer.nativeElement.querySelector('.values');
        this.updateValues();
        fromEvent(this.scrollContainer.nativeElement, 'wheel')
            .pipe(tap((event) => {
            event.preventDefault();
            event.stopPropagation();
        }), filter((event) => {
            this._wheelDelta += Math.abs(event.wheelDeltaY);
            return this._wheelDelta > ScrollPickerComponent.maxDelta;
        }), takeUntil(this._destroy$))
            .subscribe((event) => {
            this._wheelDelta = 0;
            this.scroll(event);
        });
        merge(fromEvent(this.scrollContainer.nativeElement, 'touchstart'))
            .pipe(takeUntil(this._destroy$))
            .subscribe((event) => {
            this.touchStart(event);
        });
        merge(fromEvent(this.scrollContainer.nativeElement, 'mousedown'))
            .pipe(takeUntil(this._destroy$))
            .subscribe((event) => {
            this.mouseStart(event);
        });
    }
    ngOnChanges(changes) {
        var _a, _b;
        if (((_a = changes.valuesMin) === null || _a === void 0 ? void 0 : _a.firstChange) === false || ((_b = changes.valuesMax) === null || _b === void 0 ? void 0 : _b.firstChange) === false) {
            if (this.valuesMin !== undefined && this.valuesMax !== undefined) {
                this.updateValues();
                this.updateIndex(this.getValueIndex());
            }
        }
    }
    updateValues() {
        if (this.valuesMin !== undefined && this.valuesMax !== undefined) {
            this.values = [];
            for (let i = this.valuesMin; i <= this.valuesMax; i++) {
                this.values.push({ name: i, value: i });
            }
        }
    }
    writeValue(value) {
        this.value = value;
        let index = this.getValueIndex();
        index = index === -1 ? 0 : index;
        this.updateIndex(index);
    }
    registerOnChange(fn) {
        this._onChange = fn;
    }
    registerOnTouched(fn) {
        this._onTouched = fn;
    }
    touchStart(event) {
        event.preventDefault();
        this._touchY = event.targetTouches[0].pageY;
        this._touchDestroy$ = new Subject();
        merge(fromEvent(document, 'touchmove'))
            .pipe(filter((event) => {
            this._touchDelta += event.targetTouches[0].pageY - this._touchY;
            this._touchY = event.targetTouches[0].pageY;
            return Math.abs(this._touchDelta) > ScrollPickerComponent.maxDelta;
        }), takeUntil(this._touchDestroy$), takeUntil(this._destroy$))
            .subscribe((event) => {
            this.touchMove();
            this._touchDelta = 0;
        });
        merge(fromEvent(document, 'touchend'), fromEvent(document, 'touchcancel'))
            .pipe(takeUntil(this._touchDestroy$), takeUntil(this._destroy$))
            .subscribe(() => {
            this._touchDestroy$.next();
            this._touchDestroy$.complete();
            this._touchDestroy$ = null;
        });
    }
    mouseStart(event) {
        event.preventDefault();
        this._mouseY = event.pageY;
        this._mouseDestroy$ = new Subject();
        merge(fromEvent(document, 'mousemove'))
            .pipe(filter((event) => {
            this._mouseDelta += event.pageY - this._mouseY;
            this._mouseY = event.pageY;
            return Math.abs(this._mouseDelta) > ScrollPickerComponent.maxDelta;
        }), takeUntil(this._mouseDestroy$), takeUntil(this._destroy$))
            .subscribe(() => {
            this.mouseMove();
            this._mouseDelta = 0;
        });
        merge(fromEvent(document, 'mouseup'))
            .pipe(takeUntil(this._mouseDestroy$), takeUntil(this._destroy$))
            .subscribe(() => {
            this._mouseDestroy$.next();
            this._mouseDestroy$.complete();
            this._mouseDestroy$ = null;
        });
    }
    mouseMove() {
        if (this._mouseDelta < 0) {
            this.next();
        }
        else {
            this.prev();
        }
    }
    touchMove() {
        if (this._touchDelta < 0) {
            this.next();
        }
        else {
            this.prev();
        }
    }
    scroll(event) {
        if (event.deltaY > 0) {
            this.next();
        }
        else {
            this.prev();
        }
    }
    prev() {
        let index = this.getValueIndex();
        if (index === 0) {
            index = this.values.length;
        }
        index--;
        this.updateIndex(index);
    }
    next() {
        let index = this.getValueIndex();
        if (index === (this.values.length - 1)) {
            index = -1;
        }
        index++;
        this.updateIndex(index);
    }
    getValueIndex() {
        return this.values.findIndex((item) => {
            return this.value === item.value;
        });
    }
    updateIndex(index) {
        if (!this.values[index]) {
            index = 0;
        }
        this.value = this.values[index] ? this.values[index].value : null;
        this._onChange(this.value);
        let start = index - 3;
        let end = index + 4;
        this.displayValues = [];
        if (start < 0) {
            this.displayValues = [
                ...this.values.slice(start),
                ...this.values.slice(0, end),
            ];
        }
        else if (end > (this.values.length - 1)) {
            end = this.values.length - end;
            this.displayValues = [
                ...this.values.slice(start),
                ...this.values.slice(0, end),
            ];
        }
        else {
            this.displayValues = [
                ...this.values.slice(start, end),
            ];
        }
        this._cdRef.markForCheck();
    }
    valueClick(index) {
        if (index > 0) {
            for (let i = 0; i < Math.abs(index); i++) {
                this.next();
            }
        }
        else {
            for (let i = 0; i < Math.abs(index); i++) {
                this.prev();
            }
        }
    }
    ngOnDestroy() {
        this._destroy$.next();
        this._destroy$.complete();
    }
}
ScrollPickerComponent.maxDelta = 13;
ScrollPickerComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ScrollPickerComponent, deps: [{ token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component });
ScrollPickerComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: ScrollPickerComponent, selector: "fs-scroll-picker", inputs: { values: "values", valuesMin: "valuesMin", valuesMax: "valuesMax", width: "width" }, host: { properties: { "style.width": "this.width" } }, providers: [{
            provide: NG_VALUE_ACCESSOR,
            useExisting: forwardRef(() => ScrollPickerComponent),
            multi: true
        }], queries: [{ propertyName: "template", first: true, predicate: ScrollPickerTemplateComponent, descendants: true, read: TemplateRef }], viewQueries: [{ propertyName: "scrollContainer", first: true, predicate: ["scrollContainer"], descendants: true, static: true }], usesOnChanges: true, ngImport: i0, template: "<div \n    class=\"scroll-container\" \n    #scrollContainer>\n  <div class=\"top\"></div>\n  <div class=\"bottom\"></div>\n  <div class=\"scroller\">\n      <div class=\"values\">\n        <div \n            class=\"value value1\" \n            (click)=\"valueClick(-3)\"\n            [ngStyle]=\"{ transform: 'rotateX(67.5deg) translateZ(90px) translate3d(0px, 0px, 0px)' }\">\n          {{displayValues[0]?.name}}\n        </div>\n        <div \n            class=\"value value1\" \n            (click)=\"valueClick(-2)\"\n            [ngStyle]=\"{ transform: 'rotateX(45deg) translateZ(90px) translate3d(0px, 0px, 0px)' }\">\n          {{displayValues[1]?.name}}\n        </div>\n        <div \n            class=\"value value1\" \n            (click)=\"valueClick(-1)\"\n            [ngStyle]=\"{ transform: 'rotateX(22.5deg) translateZ(90px) translate3d(0px, 0px, 0px)' }\">\n          {{displayValues[2]?.name}}\n        </div>\n        <div \n            class=\"value value1\" \n            [ngStyle]=\"{ transform: 'rotateX(0deg) translateZ(90px) translate3d(0px, 0px, 0px)' }\">\n          {{displayValues[3]?.name}}\n        </div>\n        <div \n            class=\"value value1\" \n            (click)=\"valueClick(1)\"\n            [ngStyle]=\"{ transform: 'rotateX(-22.5deg) translateZ(90px) translate3d(0px, 0px, 0px)' }\">\n          {{displayValues[4]?.name}}\n        </div>\n        <div \n            class=\"value value1\" \n            (click)=\"valueClick(2)\"\n            [ngStyle]=\"{ transform: 'rotateX(-45deg) translateZ(90px) translate3d(0px, 0px, 0px)' }\">\n          {{displayValues[5]?.name}}\n        </div>\n        <div \n            class=\"value value1\" \n            (click)=\"valueClick(3)\"\n            [ngStyle]=\"{ transform: 'rotateX(-67.5deg) translateZ(90px) translate3d(0px, 0px, 0px)' }\">\n          {{displayValues[6]?.name}}\n        </div>\n      </div>\n  </div>\n</div>\n", styles: [".scroll-container,.scroll-container *{box-sizing:border-box}.scroll-container{text-align:center;position:relative;height:180px;line-height:30px;width:100%;font-size:20px;cursor:pointer}.scroller{transition:transform .1s ease;transform:translateZ(-90px) rotateX(0);transform-style:preserve-3d;height:100%;padding:75px 0;position:relative}.scroller .values{position:relative}.scroller .value{position:absolute;backface-visibility:hidden;-webkit-backface-visibility:hidden;width:100%;color:#000;transform-origin:50% 50%;transform-style:preserve-3d;visibility:visible;z-index:0;transition:transform 40ms ease 0s}.top,.bottom{height:75px}.top{top:0;position:absolute;background:rgba(255,255,255,.6);z-index:2;width:100%;transform:translateZ(0);border-bottom:1px solid #e2e2e2;pointer-events:none}.bottom{position:absolute;bottom:0;z-index:2;background:rgba(255,255,255,.6);border-top:1px solid #e2e2e2;width:100%;transform:translateZ(0);pointer-events:none}.beginning{border-top:1px solid black}\n"], directives: [{ type: i1.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: ScrollPickerComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'fs-scroll-picker',
                    templateUrl: './scroll-picker.component.html',
                    styleUrls: ['./scroll-picker.component.scss'],
                    providers: [{
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef(() => ScrollPickerComponent),
                            multi: true
                        }],
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: i0.ChangeDetectorRef }]; }, propDecorators: { template: [{
                type: ContentChild,
                args: [ScrollPickerTemplateComponent, { read: TemplateRef }]
            }], scrollContainer: [{
                type: ViewChild,
                args: ['scrollContainer', { static: true }]
            }], values: [{
                type: Input
            }], valuesMin: [{
                type: Input
            }], valuesMax: [{
                type: Input
            }], width: [{
                type: Input
            }, {
                type: HostBinding,
                args: ['style.width']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsLXBpY2tlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvYXBwL2NvbXBvbmVudHMvc2Nyb2xsLXBpY2tlci9zY3JvbGwtcGlja2VyLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL3NyYy9hcHAvY29tcG9uZW50cy9zY3JvbGwtcGlja2VyL3Njcm9sbC1waWNrZXIuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLHVCQUF1QixFQUFFLGlCQUFpQixFQUMxQyxTQUFTLEVBQ1QsWUFBWSxFQUNaLFVBQVUsRUFDVixVQUFVLEVBQ1YsV0FBVyxFQUNYLEtBQUssRUFLTCxXQUFXLEVBQ1gsU0FBUyxFQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRCxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN4RCxPQUFPLEVBQXdCLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDekUsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sbURBQW1ELENBQUM7OztBQWNsRyxNQUFNLE9BQU8scUJBQXFCO0lBZ0NoQyxZQUFvQixNQUF5QjtRQUF6QixXQUFNLEdBQU4sTUFBTSxDQUFtQjtRQXhCcEMsV0FBTSxHQUFHLEVBQUUsQ0FBQztRQVFkLGtCQUFhLEdBQUcsRUFBRSxDQUFDO1FBR25CLGVBQVUsR0FBRyxLQUFLLENBQUM7UUFFbEIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFDaEIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFDaEIsZ0JBQVcsR0FBRyxDQUFDLENBQUM7UUFDaEIsWUFBTyxHQUFHLENBQUMsQ0FBQztRQUNaLFlBQU8sR0FBRyxDQUFDLENBQUM7UUFHWixjQUFTLEdB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QUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtpQkFDaEQ7d0dBSVEsUUFBUTtzQkFEZCxZQUFZO3VCQUFDLDZCQUE2QixFQUFFLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRTtnQkFJM0QsZUFBZTtzQkFEckIsU0FBUzt1QkFBQyxpQkFBaUIsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7Z0JBR3JDLE1BQU07c0JBQWQsS0FBSztnQkFDRyxTQUFTO3NCQUFqQixLQUFLO2dCQUNHLFNBQVM7c0JBQWpCLEtBQUs7Z0JBRXNCLEtBQUs7c0JBRGhDLEtBQUs7O3NCQUNMLFdBQVc7dUJBQUMsYUFBYSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGQsXG4gIEVsZW1lbnRSZWYsXG4gIGZvcndhcmRSZWYsXG4gIEhvc3RCaW5kaW5nLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdDaGlsZFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IGZyb21FdmVudCwgbWVyZ2UsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb250cm9sVmFsdWVBY2Nlc3NvciwgTkdfVkFMVUVfQUNDRVNTT1IgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBTY3JvbGxQaWNrZXJUZW1wbGF0ZUNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2RpcmVjdGl2ZXMvc2Nyb2xsLXBpY2tlci10ZW1wbGF0ZS5kaXJlY3RpdmUnO1xuXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2ZzLXNjcm9sbC1waWNrZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vc2Nyb2xsLXBpY2tlci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3Njcm9sbC1waWNrZXIuY29tcG9uZW50LnNjc3MnXSxcbiAgcHJvdmlkZXJzOiBbIHtcbiAgICBwcm92aWRlOiBOR19WQUxVRV9BQ0NFU1NPUixcbiAgICB1c2VFeGlzdGluZzogZm9yd2FyZFJlZigoKSA9PiBTY3JvbGxQaWNrZXJDb21wb25lbnQpLFxuICAgIG11bHRpOiB0cnVlXG4gIH0gXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIFNjcm9sbFBpY2tlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBPbkNoYW5nZXMsIENvbnRyb2xWYWx1ZUFjY2Vzc29yIHtcblxuICBAQ29udGVudENoaWxkKFNjcm9sbFBpY2tlclRlbXBsYXRlQ29tcG9uZW50LCB7IHJlYWQ6IFRlbXBsYXRlUmVmIH0pXG4gIHB1YmxpYyB0ZW1wbGF0ZTogVGVtcGxhdGVSZWY8U2Nyb2xsUGlja2VyVGVtcGxhdGVDb21wb25lbnQ+O1xuXG4gIEBWaWV3Q2hpbGQoJ3Njcm9sbENvbnRhaW5lcicsIHsgc3RhdGljOiB0cnVlIH0pIFxuICBwdWJsaWMgc2Nyb2xsQ29udGFpbmVyOiBFbGVtZW50UmVmO1xuXG4gIEBJbnB1dCgpIHZhbHVlcyA9IFtdO1xuICBASW5wdXQoKSB2YWx1ZXNNaW47XG4gIEBJbnB1dCgpIHZhbHVlc01heDtcbiAgQElucHV0KCkgXG4gIEBIb3N0QmluZGluZygnc3R5bGUud2lkdGgnKSB3aWR0aDtcblxuICBzdGF0aWMgcmVhZG9ubHkgbWF4RGVsdGEgPSAxMztcblxuICBwdWJsaWMgZGlzcGxheVZhbHVlcyA9IFtdO1xuICBwdWJsaWMgdmFsdWU7XG4gIHB1YmxpYyB2YWx1ZXNFbDtcbiAgcHVibGljIGhpZGVDdXJzb3IgPSBmYWxzZTtcblxuICBwcml2YXRlIF93aGVlbERlbHRhID0gMDtcbiAgcHJpdmF0ZSBfdG91Y2hEZWx0YSA9IDA7XG4gIHByaXZhdGUgX21vdXNlRGVsdGEgPSAwO1xuICBwcml2YXRlIF90b3VjaFkgPSAwO1xuICBwcml2YXRlIF9tb3VzZVkgPSAwO1xuICBwcml2YXRlIF90b3VjaERlc3Ryb3kkOiBTdWJqZWN0PHZvaWQ+O1xuICBwcml2YXRlIF9tb3VzZURlc3Ryb3kkOiBTdWJqZWN0PHZvaWQ+O1xuICBwcml2YXRlIF9kZXN0cm95JCA9IG5ldyBTdWJqZWN0KCk7XG4gIHByaXZhdGUgX29uVG91Y2hlZCA9ICgpID0+IHt9O1xuICBwcml2YXRlIF9vbkNoYW5nZSA9ICh2YWx1ZTogYW55KSA9PiB7fTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIF9jZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHt9XG5cbiAgcHVibGljIG5nT25Jbml0KCkge1xuICAgIHRoaXMudmFsdWVzRWwgPSB0aGlzLnNjcm9sbENvbnRhaW5lci5uYXRpdmVFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy52YWx1ZXMnKTtcbiAgICB0aGlzLnVwZGF0ZVZhbHVlcygpO1xuXG4gICAgZnJvbUV2ZW50KHRoaXMuc2Nyb2xsQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICd3aGVlbCcpXG4gICAgLnBpcGUoXG4gICAgICB0YXAoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7IFxuICAgICAgfSksXG4gICAgICBmaWx0ZXIoKGV2ZW50OiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5fd2hlZWxEZWx0YSArPSBNYXRoLmFicyhldmVudC53aGVlbERlbHRhWSk7XG4gICAgICAgIHJldHVybiB0aGlzLl93aGVlbERlbHRhID4gU2Nyb2xsUGlja2VyQ29tcG9uZW50Lm1heERlbHRhO1xuICAgICAgfSksIFxuICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICApXG4gICAgLnN1YnNjcmliZSgoZXZlbnQ6IFVJRXZlbnQpID0+IHtcbiAgICAgIHRoaXMuX3doZWVsRGVsdGEgPSAwO1xuICAgICAgdGhpcy5zY3JvbGwoZXZlbnQpO1xuICAgIH0pO1xuXG4gICAgbWVyZ2UoXG4gICAgICBmcm9tRXZlbnQodGhpcy5zY3JvbGxDb250YWluZXIubmF0aXZlRWxlbWVudCwgJ3RvdWNoc3RhcnQnKSxcbiAgICApXG4gICAgLnBpcGUoXG4gICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgIClcbiAgICAuc3Vic2NyaWJlKChldmVudDogVUlFdmVudCkgPT4ge1xuICAgICAgdGhpcy50b3VjaFN0YXJ0KGV2ZW50KTtcbiAgICB9KTtcblxuICAgIG1lcmdlKFxuICAgICAgZnJvbUV2ZW50KHRoaXMuc2Nyb2xsQ29udGFpbmVyLm5hdGl2ZUVsZW1lbnQsICdtb3VzZWRvd24nKVxuICAgIClcbiAgICAucGlwZShcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCksXG4gICAgKVxuICAgIC5zdWJzY3JpYmUoKGV2ZW50OiBVSUV2ZW50KSA9PiB7XG4gICAgICB0aGlzLm1vdXNlU3RhcnQoZXZlbnQpO1xuICAgIH0pOyAgICAgIFxuICB9XG5cbiAgcHVibGljIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZihjaGFuZ2VzLnZhbHVlc01pbj8uZmlyc3RDaGFuZ2UgPT09IGZhbHNlIHx8IGNoYW5nZXMudmFsdWVzTWF4Py5maXJzdENoYW5nZSA9PT0gZmFsc2UpIHtcbiAgICAgIGlmKHRoaXMudmFsdWVzTWluICE9PSB1bmRlZmluZWQgJiYgdGhpcy52YWx1ZXNNYXggIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlcygpO1xuICAgICAgICB0aGlzLnVwZGF0ZUluZGV4KHRoaXMuZ2V0VmFsdWVJbmRleCgpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlVmFsdWVzKCkge1xuICAgIGlmKHRoaXMudmFsdWVzTWluICE9PSB1bmRlZmluZWQgJiYgdGhpcy52YWx1ZXNNYXggIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhpcy52YWx1ZXMgPSBbXTtcbiAgICAgIGZvcihsZXQgaSA9IHRoaXMudmFsdWVzTWluOyBpIDw9IHRoaXMudmFsdWVzTWF4OyBpKyspIHtcbiAgICAgICAgdGhpcy52YWx1ZXMucHVzaCh7IG5hbWU6IGksIHZhbHVlOiBpIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyB3cml0ZVZhbHVlKHZhbHVlOiBhbnkpIHtcbiAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG4gICAgbGV0IGluZGV4ID0gdGhpcy5nZXRWYWx1ZUluZGV4KCk7XG5cbiAgICBpbmRleCA9IGluZGV4ID09PSAtMSA/IDAgOiBpbmRleDtcbiAgICB0aGlzLnVwZGF0ZUluZGV4KGluZGV4KTtcbiAgfVxuICBcbiAgcHVibGljIHJlZ2lzdGVyT25DaGFuZ2UoZm46ICh2YWx1ZTogYW55KSA9PiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLl9vbkNoYW5nZSA9IGZuXG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXJPblRvdWNoZWQoZm46ICgpID0+IGFueSk6IHZvaWQge1xuICAgIHRoaXMuX29uVG91Y2hlZCA9IGZuXG4gIH1cblxuICBwdWJsaWMgdG91Y2hTdGFydChldmVudCkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgdGhpcy5fdG91Y2hZID0gZXZlbnQudGFyZ2V0VG91Y2hlc1swXS5wYWdlWTtcbiAgICB0aGlzLl90b3VjaERlc3Ryb3kkID0gbmV3IFN1YmplY3QoKTtcblxuICAgIG1lcmdlKFxuICAgICAgZnJvbUV2ZW50KGRvY3VtZW50LCAndG91Y2htb3ZlJyksXG4gICAgKVxuICAgIC5waXBlKFxuICAgICAgZmlsdGVyKChldmVudDogYW55KSA9PiB7XG4gICAgICAgIHRoaXMuX3RvdWNoRGVsdGEgKz0gZXZlbnQudGFyZ2V0VG91Y2hlc1swXS5wYWdlWSAtIHRoaXMuX3RvdWNoWTtcbiAgICAgICAgdGhpcy5fdG91Y2hZID0gZXZlbnQudGFyZ2V0VG91Y2hlc1swXS5wYWdlWTtcbiAgICAgICAgcmV0dXJuIE1hdGguYWJzKHRoaXMuX3RvdWNoRGVsdGEpID4gU2Nyb2xsUGlja2VyQ29tcG9uZW50Lm1heERlbHRhO1xuICAgICAgfSksICAgICAgIFxuICAgICAgdGFrZVVudGlsKHRoaXMuX3RvdWNoRGVzdHJveSQpLFxuICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICApXG4gICAgLnN1YnNjcmliZSgoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgdGhpcy50b3VjaE1vdmUoKTtcbiAgICAgIHRoaXMuX3RvdWNoRGVsdGEgPSAwO1xuICAgIH0pOyBcblxuICAgIG1lcmdlKFxuICAgICAgZnJvbUV2ZW50KGRvY3VtZW50LCAndG91Y2hlbmQnKSxcbiAgICAgIGZyb21FdmVudChkb2N1bWVudCwgJ3RvdWNoY2FuY2VsJyksXG4gICAgKVxuICAgIC5waXBlKFxuICAgICAgdGFrZVVudGlsKHRoaXMuX3RvdWNoRGVzdHJveSQpLFxuICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICApXG4gICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLl90b3VjaERlc3Ryb3kkLm5leHQoKTtcbiAgICAgIHRoaXMuX3RvdWNoRGVzdHJveSQuY29tcGxldGUoKTtcbiAgICAgIHRoaXMuX3RvdWNoRGVzdHJveSQgPSBudWxsO1xuICAgIH0pOyAgXG4gIH1cblxuICBwdWJsaWMgbW91c2VTdGFydChldmVudCkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgdGhpcy5fbW91c2VZID0gZXZlbnQucGFnZVk7XG4gICAgdGhpcy5fbW91c2VEZXN0cm95JCA9IG5ldyBTdWJqZWN0KCk7XG5cbiAgICBtZXJnZShcbiAgICAgIGZyb21FdmVudChkb2N1bWVudCwgJ21vdXNlbW92ZScpXG4gICAgKVxuICAgIC5waXBlKFxuICAgICAgZmlsdGVyKChldmVudDogTW91c2VFdmVudCkgPT4ge1xuICAgICAgICB0aGlzLl9tb3VzZURlbHRhICs9IGV2ZW50LnBhZ2VZIC0gdGhpcy5fbW91c2VZO1xuICAgICAgICB0aGlzLl9tb3VzZVkgPSBldmVudC5wYWdlWTtcbiAgICAgICAgcmV0dXJuIE1hdGguYWJzKHRoaXMuX21vdXNlRGVsdGEpID4gU2Nyb2xsUGlja2VyQ29tcG9uZW50Lm1heERlbHRhOyAgICAgICAgICBcbiAgICAgIH0pLCAgICAgICBcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9tb3VzZURlc3Ryb3kkKSxcbiAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCksXG4gICAgKVxuICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5tb3VzZU1vdmUoKTtcbiAgICAgIHRoaXMuX21vdXNlRGVsdGEgPSAwO1xuICAgIH0pOyBcblxuICAgIG1lcmdlKFxuICAgICAgZnJvbUV2ZW50KGRvY3VtZW50LCAnbW91c2V1cCcpXG4gICAgKVxuICAgIC5waXBlKFxuICAgICAgdGFrZVVudGlsKHRoaXMuX21vdXNlRGVzdHJveSQpLFxuICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICApXG4gICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICB0aGlzLl9tb3VzZURlc3Ryb3kkLm5leHQoKTtcbiAgICAgIHRoaXMuX21vdXNlRGVzdHJveSQuY29tcGxldGUoKTtcbiAgICAgIHRoaXMuX21vdXNlRGVzdHJveSQgPSBudWxsO1xuICAgIH0pOyAgXG4gIH1cbiAgXG4gIHB1YmxpYyBtb3VzZU1vdmUoKSB7XG4gICAgaWYodGhpcy5fbW91c2VEZWx0YSA8IDApIHtcbiAgICAgIHRoaXMubmV4dCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnByZXYoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdG91Y2hNb3ZlKCkge1xuICAgIGlmKHRoaXMuX3RvdWNoRGVsdGEgPCAwKSB7XG4gICAgICB0aGlzLm5leHQoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5wcmV2KCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNjcm9sbChldmVudDogYW55KSB7XG4gICAgaWYgKGV2ZW50LmRlbHRhWSA+IDApIHtcbiAgICAgIHRoaXMubmV4dCgpO1xuXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHJldigpO1xuICAgIH0gICAgICAgIFxuICB9XG5cbiAgcHVibGljIHByZXYoKSB7XG4gICAgbGV0IGluZGV4ID0gdGhpcy5nZXRWYWx1ZUluZGV4KCk7XG5cbiAgICBpZihpbmRleCA9PT0gMCkge1xuICAgICAgaW5kZXggPSB0aGlzLnZhbHVlcy5sZW5ndGg7XG4gICAgfVxuXG4gICAgaW5kZXgtLTtcbiAgICB0aGlzLnVwZGF0ZUluZGV4KGluZGV4KTsgICAgXG4gIH1cblxuICBwdWJsaWMgbmV4dCgpIHtcbiAgICBsZXQgaW5kZXggPSB0aGlzLmdldFZhbHVlSW5kZXgoKTtcblxuICAgIGlmKGluZGV4ID09PSAodGhpcy52YWx1ZXMubGVuZ3RoIC0gMSkpIHtcbiAgICAgIGluZGV4ID0gLTE7XG4gICAgfVxuICAgIFxuICAgIGluZGV4Kys7IFxuICAgIFxuICAgIHRoaXMudXBkYXRlSW5kZXgoaW5kZXgpO1xuICB9XG5cbiAgcHVibGljIGdldFZhbHVlSW5kZXgoKSB7XG4gICAgcmV0dXJuIHRoaXMudmFsdWVzLmZpbmRJbmRleCgoaXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMudmFsdWUgPT09IGl0ZW0udmFsdWU7XG4gICAgfSk7IFxuICB9XG5cbiAgcHVibGljIHVwZGF0ZUluZGV4KGluZGV4KSB7XG4gICAgaWYoIXRoaXMudmFsdWVzW2luZGV4XSkge1xuICAgICAgaW5kZXggPSAwO1xuICAgIH1cblxuICAgIHRoaXMudmFsdWUgPSB0aGlzLnZhbHVlc1tpbmRleF0gPyB0aGlzLnZhbHVlc1tpbmRleF0udmFsdWUgOiBudWxsO1xuICAgIHRoaXMuX29uQ2hhbmdlKHRoaXMudmFsdWUpO1xuXG4gICAgbGV0IHN0YXJ0ID0gaW5kZXggLSAzO1xuICAgIGxldCBlbmQgPSBpbmRleCArIDQ7XG4gICAgXG4gICAgdGhpcy5kaXNwbGF5VmFsdWVzID0gW107XG4gICAgaWYoc3RhcnQgPCAwKSB7XG4gICAgICB0aGlzLmRpc3BsYXlWYWx1ZXMgPSBbXG4gICAgICAgIC4uLnRoaXMudmFsdWVzLnNsaWNlKHN0YXJ0KSxcbiAgICAgICAgLi4udGhpcy52YWx1ZXMuc2xpY2UoMCwgZW5kKSxcbiAgICAgIF07XG4gICAgfSBlbHNlIGlmKGVuZCA+ICh0aGlzLnZhbHVlcy5sZW5ndGggLSAxKSkge1xuICAgICAgZW5kID0gdGhpcy52YWx1ZXMubGVuZ3RoIC0gZW5kO1xuICAgICAgdGhpcy5kaXNwbGF5VmFsdWVzID0gW1xuICAgICAgICAuLi50aGlzLnZhbHVlcy5zbGljZShzdGFydCksXG4gICAgICAgIC4uLnRoaXMudmFsdWVzLnNsaWNlKDAsIGVuZCksXG4gICAgICBdO1xuICAgICAgXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGlzcGxheVZhbHVlcyA9IFtcbiAgICAgICAgLi4udGhpcy52YWx1ZXMuc2xpY2Uoc3RhcnQsIGVuZCksXG4gICAgICBdO1xuICAgIH1cblxuICAgIHRoaXMuX2NkUmVmLm1hcmtGb3JDaGVjaygpO1xuICB9XG5cbiAgcHVibGljIHZhbHVlQ2xpY2soaW5kZXgpOiB2b2lkIHtcbiAgICBpZihpbmRleCA+IDApIHtcbiAgICAgIGZvcihsZXQgaT0wOyBpIDwgTWF0aC5hYnMoaW5kZXgpO2krKykge1xuICAgICAgICB0aGlzLm5leHQoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgZm9yKGxldCBpPTA7IGkgPCBNYXRoLmFicyhpbmRleCk7aSsrKSB7XG4gICAgICAgIHRoaXMucHJldigpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLl9kZXN0cm95JC5uZXh0KCk7XG4gICAgdGhpcy5fZGVzdHJveSQuY29tcGxldGUoKTtcbiAgfVxufVxuIiwiPGRpdiBcbiAgICBjbGFzcz1cInNjcm9sbC1jb250YWluZXJcIiBcbiAgICAjc2Nyb2xsQ29udGFpbmVyPlxuICA8ZGl2IGNsYXNzPVwidG9wXCI+PC9kaXY+XG4gIDxkaXYgY2xhc3M9XCJib3R0b21cIj48L2Rpdj5cbiAgPGRpdiBjbGFzcz1cInNjcm9sbGVyXCI+XG4gICAgICA8ZGl2IGNsYXNzPVwidmFsdWVzXCI+XG4gICAgICAgIDxkaXYgXG4gICAgICAgICAgICBjbGFzcz1cInZhbHVlIHZhbHVlMVwiIFxuICAgICAgICAgICAgKGNsaWNrKT1cInZhbHVlQ2xpY2soLTMpXCJcbiAgICAgICAgICAgIFtuZ1N0eWxlXT1cInsgdHJhbnNmb3JtOiAncm90YXRlWCg2Ny41ZGVnKSB0cmFuc2xhdGVaKDkwcHgpIHRyYW5zbGF0ZTNkKDBweCwgMHB4LCAwcHgpJyB9XCI+XG4gICAgICAgICAge3tkaXNwbGF5VmFsdWVzWzBdPy5uYW1lfX1cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgXG4gICAgICAgICAgICBjbGFzcz1cInZhbHVlIHZhbHVlMVwiIFxuICAgICAgICAgICAgKGNsaWNrKT1cInZhbHVlQ2xpY2soLTIpXCJcbiAgICAgICAgICAgIFtuZ1N0eWxlXT1cInsgdHJhbnNmb3JtOiAncm90YXRlWCg0NWRlZykgdHJhbnNsYXRlWig5MHB4KSB0cmFuc2xhdGUzZCgwcHgsIDBweCwgMHB4KScgfVwiPlxuICAgICAgICAgIHt7ZGlzcGxheVZhbHVlc1sxXT8ubmFtZX19XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IFxuICAgICAgICAgICAgY2xhc3M9XCJ2YWx1ZSB2YWx1ZTFcIiBcbiAgICAgICAgICAgIChjbGljayk9XCJ2YWx1ZUNsaWNrKC0xKVwiXG4gICAgICAgICAgICBbbmdTdHlsZV09XCJ7IHRyYW5zZm9ybTogJ3JvdGF0ZVgoMjIuNWRlZykgdHJhbnNsYXRlWig5MHB4KSB0cmFuc2xhdGUzZCgwcHgsIDBweCwgMHB4KScgfVwiPlxuICAgICAgICAgIHt7ZGlzcGxheVZhbHVlc1syXT8ubmFtZX19XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IFxuICAgICAgICAgICAgY2xhc3M9XCJ2YWx1ZSB2YWx1ZTFcIiBcbiAgICAgICAgICAgIFtuZ1N0eWxlXT1cInsgdHJhbnNmb3JtOiAncm90YXRlWCgwZGVnKSB0cmFuc2xhdGVaKDkwcHgpIHRyYW5zbGF0ZTNkKDBweCwgMHB4LCAwcHgpJyB9XCI+XG4gICAgICAgICAge3tkaXNwbGF5VmFsdWVzWzNdPy5uYW1lfX1cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgXG4gICAgICAgICAgICBjbGFzcz1cInZhbHVlIHZhbHVlMVwiIFxuICAgICAgICAgICAgKGNsaWNrKT1cInZhbHVlQ2xpY2soMSlcIlxuICAgICAgICAgICAgW25nU3R5bGVdPVwieyB0cmFuc2Zvcm06ICdyb3RhdGVYKC0yMi41ZGVnKSB0cmFuc2xhdGVaKDkwcHgpIHRyYW5zbGF0ZTNkKDBweCwgMHB4LCAwcHgpJyB9XCI+XG4gICAgICAgICAge3tkaXNwbGF5VmFsdWVzWzRdPy5uYW1lfX1cbiAgICAgICAgPC9kaXY+XG4gICAgICAgIDxkaXYgXG4gICAgICAgICAgICBjbGFzcz1cInZhbHVlIHZhbHVlMVwiIFxuICAgICAgICAgICAgKGNsaWNrKT1cInZhbHVlQ2xpY2soMilcIlxuICAgICAgICAgICAgW25nU3R5bGVdPVwieyB0cmFuc2Zvcm06ICdyb3RhdGVYKC00NWRlZykgdHJhbnNsYXRlWig5MHB4KSB0cmFuc2xhdGUzZCgwcHgsIDBweCwgMHB4KScgfVwiPlxuICAgICAgICAgIHt7ZGlzcGxheVZhbHVlc1s1XT8ubmFtZX19XG4gICAgICAgIDwvZGl2PlxuICAgICAgICA8ZGl2IFxuICAgICAgICAgICAgY2xhc3M9XCJ2YWx1ZSB2YWx1ZTFcIiBcbiAgICAgICAgICAgIChjbGljayk9XCJ2YWx1ZUNsaWNrKDMpXCJcbiAgICAgICAgICAgIFtuZ1N0eWxlXT1cInsgdHJhbnNmb3JtOiAncm90YXRlWCgtNjcuNWRlZykgdHJhbnNsYXRlWig5MHB4KSB0cmFuc2xhdGUzZCgwcHgsIDBweCwgMHB4KScgfVwiPlxuICAgICAgICAgIHt7ZGlzcGxheVZhbHVlc1s2XT8ubmFtZX19XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG4gIDwvZGl2PlxuPC9kaXY+XG4iXX0=