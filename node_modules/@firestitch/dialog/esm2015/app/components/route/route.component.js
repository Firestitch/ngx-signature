import { __awaiter, __rest } from "tslib";
import { Component, ComponentFactoryResolver, ViewContainerRef } from '@angular/core';
import { ActivatedRoute, NavigationEnd, NavigationStart, Router } from '@angular/router';
import { merge, Subject } from 'rxjs';
import { filter, takeUntil } from 'rxjs/operators';
import { FsDialogRouter } from '../../serivces/fs-dialog-router';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "../../serivces/fs-dialog-router";
export class FsDialogRouteComponent {
    constructor(_route, _router, _dialogRouter, _componentFactory, _viewContainerRef) {
        this._route = _route;
        this._router = _router;
        this._dialogRouter = _dialogRouter;
        this._componentFactory = _componentFactory;
        this._viewContainerRef = _viewContainerRef;
        this._hasActiveNavigation = false;
        this._destroy$ = new Subject();
    }
    ngOnInit() {
        this._listenNavigationEvents();
        this.openDialog();
    }
    ngOnDestroy() {
        this._destroy$.next();
        this._destroy$.complete();
    }
    openDialog() {
        var _a;
        return __awaiter(this, void 0, void 0, function* () {
            const dialogConfig = Object.assign({}, (_a = this._route.snapshot.data) === null || _a === void 0 ? void 0 : _a.fsDialog);
            if (dialogConfig === null || dialogConfig === void 0 ? void 0 : dialogConfig.component) {
                if (dialogConfig.component instanceof Promise) {
                    this._dialog = yield this._openLazyDialog(dialogConfig);
                }
                else {
                    this._dialog = this._openDialog(dialogConfig);
                }
                this._listenDialogClose();
            }
        });
    }
    _listenNavigationEvents() {
        this._router.events
            .pipe(filter((event) => {
            return event instanceof NavigationStart;
        }), takeUntil(this._destroy$))
            .subscribe((event) => {
            this._hasActiveNavigation = true;
        });
        this._router.events
            .pipe(filter((event) => {
            return event instanceof NavigationEnd;
        }), takeUntil(this._destroy$))
            .subscribe((event) => {
            this._hasActiveNavigation = false;
        });
    }
    _listenDialogClose() {
        merge(this._dialog.afterClosed())
            .pipe(filter(() => !this._hasActiveNavigation), takeUntil(this._destroy$))
            .subscribe(() => {
            this._navigateOutFromDialog();
        });
    }
    _navigateOutFromDialog() {
        var _a, _b;
        let stepsBack = 1;
        let route = this._route.parent;
        // we are looking for parent route to navigate from current dialog
        // but we have to skip routes like loadChildren or redirectTo
        // because it does not make sence to do navigation to them
        while (route.routeConfig && (route.routeConfig.redirectTo || route.routeConfig.path === '') && route.parent) {
            stepsBack++;
            if (route.routeConfig.path === '' && ((_a = route.parent) === null || _a === void 0 ? void 0 : _a.routeConfig.loadChildren) && ((_b = route.parent) === null || _b === void 0 ? void 0 : _b.parent)) {
                route = route.parent.parent;
            }
            else {
                route = route.parent;
            }
        }
        // make relative navigation path like '../../../';
        const navigationPath = Array
            .from(Array(stepsBack), () => '../')
            .join('');
        // Do it!
        this._router.navigate([navigationPath], { relativeTo: this._route, queryParamsHandling: 'merge' });
    }
    _openLazyDialog(dialogConfig) {
        return __awaiter(this, void 0, void 0, function* () {
            const loadedComponent = yield dialogConfig.component;
            const componentName = Object.keys(loadedComponent)[0];
            if (!componentName) {
                throw Error('Lazy loading dialog component error! Component not found!');
            }
            const factory = this._componentFactory.resolveComponentFactory(loadedComponent[componentName]);
            dialogConfig.component = factory.componentType;
            return this._openDialog(dialogConfig);
        });
    }
    _openDialog(routeDialogConfig) {
        const { component: dialogComponent } = routeDialogConfig, dialogConfig = __rest(routeDialogConfig, ["component"]);
        dialogConfig.viewContainerRef = this._viewContainerRef;
        return this._dialogRouter.openDialogForRoute(dialogComponent, dialogConfig);
    }
}
FsDialogRouteComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDialogRouteComponent, deps: [{ token: i1.ActivatedRoute }, { token: i1.Router }, { token: i2.FsDialogRouter }, { token: i0.ComponentFactoryResolver }, { token: i0.ViewContainerRef }], target: i0.ɵɵFactoryTarget.Component });
FsDialogRouteComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: FsDialogRouteComponent, selector: "ng-component", ngImport: i0, template: '<router-outlet></router-outlet>', isInline: true, directives: [{ type: i1.RouterOutlet, selector: "router-outlet", outputs: ["activate", "deactivate"], exportAs: ["outlet"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDialogRouteComponent, decorators: [{
            type: Component,
            args: [{
                    template: '<router-outlet></router-outlet>',
                }]
        }], ctorParameters: function () { return [{ type: i1.ActivatedRoute }, { type: i1.Router }, { type: i2.FsDialogRouter }, { type: i0.ComponentFactoryResolver }, { type: i0.ViewContainerRef }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicm91dGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9jb21wb25lbnRzL3JvdXRlL3JvdXRlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSx3QkFBd0IsRUFBcUIsZ0JBQWdCLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekcsT0FBTyxFQUFFLGNBQWMsRUFBRSxhQUFhLEVBQUUsZUFBZSxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBS3pGLE9BQU8sRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlDQUFpQyxDQUFDOzs7O0FBT2pFLE1BQU0sT0FBTyxzQkFBc0I7SUFNakMsWUFDVSxNQUFzQixFQUN0QixPQUFlLEVBQ2YsYUFBNkIsRUFDN0IsaUJBQTJDLEVBQzNDLGlCQUFvQztRQUpwQyxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0QixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2Ysa0JBQWEsR0FBYixhQUFhLENBQWdCO1FBQzdCLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBMEI7UUFDM0Msc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQVJ0Qyx5QkFBb0IsR0FBRyxLQUFLLENBQUM7UUFDN0IsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFRckMsQ0FBQztJQUVHLFFBQVE7UUFDYixJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUMvQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7SUFDcEIsQ0FBQztJQUVNLFdBQVc7UUFDaEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMs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QixvREFGdkIsaUNBQWlDOzRGQUVoQyxzQkFBc0I7a0JBSGxDLFNBQVM7bUJBQUM7b0JBQ1QsUUFBUSxFQUFFLGlDQUFpQztpQkFDNUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgT25EZXN0cm95LCBPbkluaXQsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGl2YXRlZFJvdXRlLCBOYXZpZ2F0aW9uRW5kLCBOYXZpZ2F0aW9uU3RhcnQsIFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XG5cbmltcG9ydCB7IE1hdERpYWxvZ1JlZiwgTWF0RGlhbG9nQ29uZmlnIH0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvZGlhbG9nJztcbmltcG9ydCB7IENvbXBvbmVudFR5cGUgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcblxuaW1wb3J0IHsgbWVyZ2UsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBGc0RpYWxvZ1JvdXRlciB9IGZyb20gJy4uLy4uL3Nlcml2Y2VzL2ZzLWRpYWxvZy1yb3V0ZXInO1xuaW1wb3J0IHsgSUZzRGlhbG9nUm91dGVDb25maWcgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3JvdXRlLWRhdGEuaW50ZXJmYWNlJztcblxuXG5AQ29tcG9uZW50KHtcbiAgdGVtcGxhdGU6ICc8cm91dGVyLW91dGxldD48L3JvdXRlci1vdXRsZXQ+Jyxcbn0pXG5leHBvcnQgY2xhc3MgRnNEaWFsb2dSb3V0ZUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblxuICBwcml2YXRlIF9kaWFsb2c6IE1hdERpYWxvZ1JlZjx1bmtub3duLCB1bmtub3duPjtcbiAgcHJpdmF0ZSBfaGFzQWN0aXZlTmF2aWdhdGlvbiA9IGZhbHNlO1xuICBwcml2YXRlIF9kZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBfcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxuICAgIHByaXZhdGUgX3JvdXRlcjogUm91dGVyLFxuICAgIHByaXZhdGUgX2RpYWxvZ1JvdXRlcjogRnNEaWFsb2dSb3V0ZXIsXG4gICAgcHJpdmF0ZSBfY29tcG9uZW50RmFjdG9yeTogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIHByaXZhdGUgX3ZpZXdDb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmXG4gICkge31cblxuICBwdWJsaWMgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5fbGlzdGVuTmF2aWdhdGlvbkV2ZW50cygpO1xuICAgIHRoaXMub3BlbkRpYWxvZygpO1xuICB9XG5cbiAgcHVibGljIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX2Rlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLl9kZXN0cm95JC5jb21wbGV0ZSgpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIG9wZW5EaWFsb2coKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZGlhbG9nQ29uZmlnOiBJRnNEaWFsb2dSb3V0ZUNvbmZpZyA9IHsgLi4udGhpcy5fcm91dGUuc25hcHNob3QuZGF0YT8uZnNEaWFsb2cgfTtcblxuICAgIGlmIChkaWFsb2dDb25maWc/LmNvbXBvbmVudCkge1xuICAgICAgaWYgKGRpYWxvZ0NvbmZpZy5jb21wb25lbnQgaW5zdGFuY2VvZiBQcm9taXNlKSB7XG4gICAgICAgIHRoaXMuX2RpYWxvZyA9IGF3YWl0IHRoaXMuX29wZW5MYXp5RGlhbG9nKGRpYWxvZ0NvbmZpZyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLl9kaWFsb2cgPSB0aGlzLl9vcGVuRGlhbG9nKGRpYWxvZ0NvbmZpZyk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuX2xpc3RlbkRpYWxvZ0Nsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfbGlzdGVuTmF2aWdhdGlvbkV2ZW50cygpOiB2b2lkIHtcbiAgICB0aGlzLl9yb3V0ZXIuZXZlbnRzXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKChldmVudCkgPT4ge1xuICAgICAgICAgIHJldHVybiBldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25TdGFydFxuICAgICAgICB9KSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKGV2ZW50KSA9PiB7XG4gICAgICAgIHRoaXMuX2hhc0FjdGl2ZU5hdmlnYXRpb24gPSB0cnVlO1xuICAgICAgfSk7XG5cbiAgICB0aGlzLl9yb3V0ZXIuZXZlbnRzXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKChldmVudCkgPT4ge1xuICAgICAgICAgIHJldHVybiBldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25FbmRcbiAgICAgICAgfSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChldmVudCkgPT4ge1xuICAgICAgICB0aGlzLl9oYXNBY3RpdmVOYXZpZ2F0aW9uID0gZmFsc2U7XG4gICAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBfbGlzdGVuRGlhbG9nQ2xvc2UoKTogdm9pZCB7XG4gICAgbWVyZ2UoXG4gICAgICB0aGlzLl9kaWFsb2cuYWZ0ZXJDbG9zZWQoKSxcbiAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKCgpID0+ICF0aGlzLl9oYXNBY3RpdmVOYXZpZ2F0aW9uKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLl9uYXZpZ2F0ZU91dEZyb21EaWFsb2coKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBfbmF2aWdhdGVPdXRGcm9tRGlhbG9nKCk6IHZvaWQge1xuICAgIGxldCBzdGVwc0JhY2sgPSAxO1xuICAgIGxldCByb3V0ZSA9IHRoaXMuX3JvdXRlLnBhcmVudDtcblxuICAgIC8vIHdlIGFyZSBsb29raW5nIGZvciBwYXJlbnQgcm91dGUgdG8gbmF2aWdhdGUgZnJvbSBjdXJyZW50IGRpYWxvZ1xuICAgIC8vIGJ1dCB3ZSBoYXZlIHRvIHNraXAgcm91dGVzIGxpa2UgbG9hZENoaWxkcmVuIG9yIHJlZGlyZWN0VG9cbiAgICAvLyBiZWNhdXNlIGl0IGRvZXMgbm90IG1ha2Ugc2VuY2UgdG8gZG8gbmF2aWdhdGlvbiB0byB0aGVtXG4gICAgd2hpbGUgKHJvdXRlLnJvdXRlQ29uZmlnICYmIChyb3V0ZS5yb3V0ZUNvbmZpZy5yZWRpcmVjdFRvIHx8IHJvdXRlLnJvdXRlQ29uZmlnLnBhdGggPT09ICcnKSAmJiByb3V0ZS5wYXJlbnQpIHtcbiAgICAgIHN0ZXBzQmFjaysrO1xuXG4gICAgICBpZiAocm91dGUucm91dGVDb25maWcucGF0aCA9PT0gJycgJiYgcm91dGUucGFyZW50Py5yb3V0ZUNvbmZpZy5sb2FkQ2hpbGRyZW4gJiYgcm91dGUucGFyZW50Py5wYXJlbnQpIHtcbiAgICAgICAgcm91dGUgPSByb3V0ZS5wYXJlbnQucGFyZW50XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByb3V0ZSA9IHJvdXRlLnBhcmVudDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBtYWtlIHJlbGF0aXZlIG5hdmlnYXRpb24gcGF0aCBsaWtlICcuLi8uLi8uLi8nO1xuICAgIGNvbnN0IG5hdmlnYXRpb25QYXRoID0gQXJyYXlcbiAgICAgIC5mcm9tKEFycmF5KHN0ZXBzQmFjayksICgpID0+ICcuLi8nKVxuICAgICAgLmpvaW4oJycpO1xuXG4gICAgLy8gRG8gaXQhXG4gICAgdGhpcy5fcm91dGVyLm5hdmlnYXRlKFtuYXZpZ2F0aW9uUGF0aF0sIHsgcmVsYXRpdmVUbzogdGhpcy5fcm91dGUsIHF1ZXJ5UGFyYW1zSGFuZGxpbmc6ICdtZXJnZScgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIF9vcGVuTGF6eURpYWxvZyhkaWFsb2dDb25maWc6IElGc0RpYWxvZ1JvdXRlQ29uZmlnKTogUHJvbWlzZTxNYXREaWFsb2dSZWY8dW5rbm93biwgdW5rbm93bj4+IHtcbiAgICBjb25zdCBsb2FkZWRDb21wb25lbnQgPSBhd2FpdCBkaWFsb2dDb25maWcuY29tcG9uZW50O1xuICAgIGNvbnN0IGNvbXBvbmVudE5hbWUgPSBPYmplY3Qua2V5cyhsb2FkZWRDb21wb25lbnQpWzBdO1xuXG4gICAgaWYgKCFjb21wb25lbnROYW1lKSB7XG4gICAgICB0aHJvdyBFcnJvcignTGF6eSBsb2FkaW5nIGRpYWxvZyBjb21wb25lbnQgZXJyb3IhIENvbXBvbmVudCBub3QgZm91bmQhJylcbiAgICB9XG5cbiAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5fY29tcG9uZW50RmFjdG9yeS5yZXNvbHZlQ29tcG9uZW50RmFjdG9yeShsb2FkZWRDb21wb25lbnRbY29tcG9uZW50TmFtZV0pXG4gICAgZGlhbG9nQ29uZmlnLmNvbXBvbmVudCA9IGZhY3RvcnkuY29tcG9uZW50VHlwZTtcblxuICAgIHJldHVybiB0aGlzLl9vcGVuRGlhbG9nKGRpYWxvZ0NvbmZpZyk7XG4gIH1cblxuICBwcml2YXRlIF9vcGVuRGlhbG9nKHJvdXRlRGlhbG9nQ29uZmlnOiBJRnNEaWFsb2dSb3V0ZUNvbmZpZyk6IE1hdERpYWxvZ1JlZjx1bmtub3duLCB1bmtub3duPiB7XG4gICAgY29uc3Qge2NvbXBvbmVudDogZGlhbG9nQ29tcG9uZW50LCAuLi5kaWFsb2dDb25maWd9OlxuICAgICAgeyBjb21wb25lbnQ6IENvbXBvbmVudFR5cGU8dW5rbm93bj4gfSAmIE1hdERpYWxvZ0NvbmZpZzx1bmtub3duPiA9IHJvdXRlRGlhbG9nQ29uZmlnO1xuXG4gICAgZGlhbG9nQ29uZmlnLnZpZXdDb250YWluZXJSZWYgPSB0aGlzLl92aWV3Q29udGFpbmVyUmVmO1xuXG4gICAgcmV0dXJuIHRoaXMuX2RpYWxvZ1JvdXRlci5vcGVuRGlhbG9nRm9yUm91dGUoZGlhbG9nQ29tcG9uZW50LCBkaWFsb2dDb25maWcpO1xuICB9XG5cbn1cbiJdfQ==