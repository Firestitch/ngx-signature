import { Renderer2, HostListener, ElementRef, EventEmitter, Output, HostBinding, Input, ChangeDetectorRef, Directive } from '@angular/core';
import { fromEvent, Subject } from 'rxjs';
import { filter, take, takeUntil, tap } from 'rxjs/operators';
import { Validators } from '@angular/forms';
import { isEqual, isValid } from 'date-fns';
import { zonedTimeToUtc } from 'date-fns-tz';
import { parseDate } from '../helpers/parse-date';
import * as i0 from "@angular/core";
export class FsDatePickerBaseComponent {
    constructor(renderer, elementRef, _cdRef) {
        this._cdRef = _cdRef;
        this.change$ = new EventEmitter();
        this.selected$ = new EventEmitter();
        this.blured$ = new EventEmitter();
        this.disabled = false;
        this.readonly = false;
        this.opened = false;
        this.dialog = null;
        this._destroy$ = new Subject();
        this._onChange = (value) => { };
        this._onTouch = () => { };
        this._validatorOnChange = () => { };
        this._clear = true;
        this._lastValueValid = false;
        /** The form control validator for whether the input parses. */
        this._parseValidator = () => {
            return this._lastValueValid
                ? null
                : { fsDatepickerParse: 'Invalid Date' };
        };
        this._validator = Validators.compose([this._parseValidator]);
        this.renderer = renderer;
        this.elementRef = elementRef;
    }
    set clear(value) {
        this._clear = value;
    }
    set timezone(value) {
        this._timezone = value;
        this.writeValue(this._originValue);
    }
    set readonlyState(isReadonly) {
        this.readonly = !!isReadonly || isReadonly === '';
    }
    registerOnChange(fn) { this._onChange = fn; }
    registerOnTouched(fn) { this._onTouch = fn; }
    registerOnValidatorChange(fn) { this._validatorOnChange = fn; }
    ngOnInit() {
        fromEvent(this.el, 'focus')
            .pipe(takeUntil(this._destroy$))
            .subscribe(() => {
            this.open();
            this.el.focus();
        });
        fromEvent(this.el, 'keydown')
            .pipe(tap(() => this.close()), filter((event) => ['Tab', 'Enter', 'Escape'].includes(event.key)), takeUntil(this._destroy$))
            .subscribe((event) => {
            if (event.key === 'Enter') {
                this.inputChange(this.el.value);
            }
            this.close();
            this.el.blur();
        });
    }
    get el() {
        return this.elementRef.nativeElement;
    }
    get clear() {
        return this._clear;
    }
    get value() {
        return this._value;
    }
    get timezone() {
        return this._timezone;
    }
    set value(value) {
        if (value && this.timezone) {
            value = zonedTimeToUtc(value, this.timezone);
        }
        this._value = value;
        this._lastValueValid = !value || isValid(value);
        this._onChange(this.value);
        this.updateInput(this.value);
        this.change$.emit(this.value);
    }
    writeValue(obj) { }
    get dateDialogRef() {
        return this._dateDialogRef;
    }
    cleared(event) {
        event.stopPropagation();
        event.preventDefault();
        this.value = null;
        this.clearInput();
        this.selected$.next(null);
    }
    ngOnDestroy() {
        if (this.dateDialogRef) {
            this.dateDialogRef.close();
        }
        this._destroy$.next();
        this._destroy$.complete();
    }
    setDisabledState(isDisabled) {
        this.disabled = isDisabled;
        this._cdRef.markForCheck();
    }
    validate(c) {
        return this._validator ? this._validator(c) : null;
    }
    open() {
        this.renderer.addClass(document.body, 'fs-date-picker-open');
        this.opened = true;
        this._dateDialogRef.value$
            .pipe(takeUntil(this._dateDialogRef.close$), takeUntil(this._destroy$))
            .subscribe((value) => {
            this.value = value;
            this.selected$.emit(value);
        });
        this._dateDialogRef.close$
            .pipe(take(1), takeUntil(this._destroy$))
            .subscribe(() => {
            this._dateDialogRef = null;
            this.renderer.removeClass(document.body, 'fs-date-picker-open');
            this._cdRef.markForCheck();
        });
    }
    clearInput() {
        this.elementRef.nativeElement.value = null;
    }
    triggerClick() {
        this.el.focus();
        this.el.select();
        this.open();
    }
    updateValue(date) {
        this._value = date;
        this._onChange(this.value);
        this._onTouch();
        this.change$.emit(this.value);
    }
    setReadonly() {
        setTimeout(() => {
            this.elementRef.nativeElement.setAttribute('readonly', true);
        });
    }
    close() {
        if (this._dateDialogRef) {
            this._dateDialogRef.close();
        }
    }
    validateDate(date) {
        this._lastValueValid = !date || isValid(date);
    }
    _inputKeyup(event, value) {
        if (event.key === 'Enter') {
            this.inputChange(value);
        }
    }
    _inputChange(value, target) {
        var _a;
        if (((_a = this.ngModelOptions) === null || _a === void 0 ? void 0 : _a.updateOn) !== 'blur') {
            this.inputChange(value);
        }
    }
    _inputBlur(value) {
        var _a;
        if (((_a = this.ngModelOptions) === null || _a === void 0 ? void 0 : _a.updateOn) === 'blur') {
            this.inputChange(value);
        }
        this.updateInput(this.value);
        this.blured$.emit(this.value);
    }
    inputChange(value) {
        if (!!value) {
            const lastValueWasValid = this._lastValueValid;
            const date = parseDate(value);
            this.validateDate(date);
            if (!isEqual(date, this._value)) {
                this.updateValue(date);
            }
            else if (lastValueWasValid !== this._lastValueValid) {
                this._validatorOnChange();
            }
        }
        else {
            this.updateValue(null);
        }
    }
}
FsDatePickerBaseComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerBaseComponent, deps: [{ token: i0.Renderer2 }, { token: i0.ElementRef }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Directive });
FsDatePickerBaseComponent.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.16", type: FsDatePickerBaseComponent, inputs: { ngModelOptions: "ngModelOptions", clear: "clear", timezone: "timezone", readonlyState: ["readonly", "readonlyState"] }, outputs: { change$: "change", selected$: "selected", blured$: "blured" }, host: { listeners: { "keyup": "_inputKeyup($event,$event.target.value)", "input": "_inputChange($event.target.value,$event.target)", "blur": "_inputBlur($event.target.value)" }, properties: { "class.fs-input-disabled": "this.disabled", "attr.readonly": "this.readonly", "class.fs-input-readonly": "this.readonly" } }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerBaseComponent, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: i0.Renderer2 }, { type: i0.ElementRef }, { type: i0.ChangeDetectorRef }]; }, propDecorators: { ngModelOptions: [{
                type: Input
            }], clear: [{
                type: Input
            }], timezone: [{
                type: Input
            }], change$: [{
                type: Output,
                args: ['change']
            }], selected$: [{
                type: Output,
                args: ['selected']
            }], blured$: [{
                type: Output,
                args: ['blured']
            }], disabled: [{
                type: HostBinding,
                args: ['class.fs-input-disabled']
            }, {
                type: HostBinding,
                args: ['attr.readonly']
            }], readonlyState: [{
                type: Input,
                args: ['readonly']
            }], readonly: [{
                type: HostBinding,
                args: ['class.fs-input-readonly']
            }, {
                type: HostBinding,
                args: ['attr.readonly']
            }], _inputKeyup: [{
                type: HostListener,
                args: ['keyup', ['$event', '$event.target.value']]
            }], _inputChange: [{
                type: HostListener,
                args: ['input', ['$event.target.value', '$event.target']]
            }], _inputBlur: [{
                type: HostListener,
                args: ['blur', ['$event.target.value']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYXBwL2NsYXNzZXMvYmFzZS1jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsVUFBVSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQWEsV0FBVyxFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQVUsTUFBTSxlQUFlLENBQUM7QUFFL0osT0FBTyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDMUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSTlELE9BQU8sRUFNTCxVQUFVLEVBQ1gsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTdDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7QUFJbEQsTUFBTSxPQUFnQix5QkFBeUI7SUFpRTdDLFlBQ0UsUUFBbUIsRUFDbkIsVUFBc0IsRUFDWixNQUF5QjtRQUF6QixXQUFNLEdBQU4sTUFBTSxDQUFtQjtRQTVDOUIsWUFBTyxHQUFHLElBQUksWUFBWSxFQUFRLENBQUM7UUFHbkMsY0FBUyxHQUFHLElBQUksWUFBWSxFQUFRLENBQUM7UUFHckMsWUFBTyxHQUFHLElBQUksWUFBWSxFQUFRLENBQUM7UUFJbkMsYUFBUSxHQUFHLEtBQUssQ0FBQztRQVNqQixhQUFRLEdBQUcsS0FBSyxDQUFDO1FBRWpCLFdBQU0sR0FBRyxLQUFLLENBQUM7UUFRWixXQUFNLEdBQUcsSUFBSSxDQUFDO1FBSWQsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFFNUIsY0FBUyxHQUFHLENBQUMsS0FBVSxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDaEMsYUFBUSxHQUFHLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNyQix1QkFBa0IsR0FBRyxHQUFHLEVBQUUsR0FBRSxDQUFDLENBQUM7UUFDOUIsV0FBTSxHQUFHLElBQUksQ0FBQztRQUNkLG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBOEpoQywrREFBK0Q7UUFDckQsb0JBQWUsR0FBZ0IsR0FBNEIsRUFBRTtZQUNyRSxPQUFPLElBQUksQ0FBQyxlQUFlO2dCQUN6QixDQUFDLENBQUMsSUFBSTtnQkFDTixDQUFDLENBQUMsRUFBRSxpQkFBaUIsRUFBRSxjQUFjLEVBQUUsQ0FBQztRQUM1QyxDQUFDLENBQUE7UUFFUyxlQUFVLEdBQXVCLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztRQTlKcEYsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7SUFDL0IsQ0FBQztJQTdERCxJQUNXLEtBQUssQ0FBQyxLQUFjO1FBQzdCLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxJQUNXLFFBQVEsQ0FBQyxLQUFhO1FBQy9CLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDO1FBRXZCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFlRCxJQUNXLGFBQWEsQ0FBQyxVQUFrQjtRQUN6QyxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxVQUFVLElBQUksVUFBVSxLQUFLLEVBQUUsQ0FBQztJQUNwRCxDQUFDO0lBT00sZ0JBQWdCLENBQUMsRUFBdUIsSUFBVSxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQSxDQUFDLENBQUM7SUFDdkUsaUJBQWlCLENBQUMsRUFBYSxJQUFVLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFBLENBQUMsQ0FBQztJQUM3RCx5QkFBeUIsQ0FBQyxFQUFjLElBQVUsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUEwQmpGLFFBQVE7UUFDYixTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUM7YUFDMUIsSUFBSSxDQUNILFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQzFCO2FBQ0EsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNaLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDbEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUM7YUFDMUIsSUFBSSxDQUNILEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsRUFDdkIsTUFBTSxDQUFDLENBQUMsS0FBb0IsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsRUFDaEYsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FDMUI7YUFDQSxTQUFTLENBQUMsQ0FBQyxLQUFvQixFQUFFLEVBQUU7WUFDbEMsSUFBSSxLQUFLLENBQUMsR0FBRyxLQUFLLE9BQU8sRUFBRTtnQkFDekIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO2FBQ2pDO1lBRUQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ2IsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxJQUFXLEVBQUU7UUFDWCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxJQUFXLEtBQUs7UUFDZCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDckIsQ0FBQztJQUVELElBQVcsS0FBSztRQUNkLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUNyQixDQUFDO0lBRUQsSUFBVyxRQUFRO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUN4QixDQUFDO0lBRUQsSUFBVyxLQUFLLENBQUMsS0FBSztRQUNwQixJQUFJLEtBQUssSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQzFCLEtBQUssR0FBRyxjQUFjLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM5QztRQUVELElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBRXBCLElBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxLQUFLLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWhELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNCLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTdCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRU0sVUFBVSxDQUFDLEdBQVEsSUFBUyxDQUFDO0lBRXBDLElBQVcsYUFBYTtRQUN0QixPQUFPLElBQUksQ0FBQyxjQUFjLENBQUM7SUFDN0IsQ0FBQztJQUVNLE9BQU8sQ0FBQyxLQUFLO1FBQ2xCLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUN4QixLQUFLLENBQUMsY0FBYyxFQUFFLENBQUM7UUFFdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUM7UUFDbEIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ2xCLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUFFTSxXQUFXO1FBQ2hCLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN0QixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQzVCO1FBRUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFTSxnQkFBZ0IsQ0FBQyxVQUFtQjtRQUN6QyxJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQztRQUUzQixJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFTSxRQUFRLENBQUMsQ0FBa0I7UUFDaEMsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDckQsQ0FBQztJQUVNLElBQUk7UUFDVCxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLHFCQUFxQixDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFFbkIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNO2FBQ3ZCLElBQUksQ0FDSCxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsRUFDckMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FDMUI7YUFDQSxTQUFTLENBQUMsQ0FBQyxLQUFXLEVBQUUsRUFBRTtZQUN6QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztZQUNuQixJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztRQUVMLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTTthQUN2QixJQUFJLENBQ0gsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUNQLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQzFCO2FBQ0EsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1lBQzNCLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUscUJBQXFCLENBQUMsQ0FBQztZQUNoRSxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzdCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVNLFVBQVU7UUFDZixJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO0lBQzdDLENBQUM7SUFFTSxZQUFZO1FBQ2pCLElBQUksQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDaEIsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztRQUVqQixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRVMsV0FBVyxDQUFDLElBQUk7UUFDeEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUM7UUFDbkIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2hCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNoQyxDQUFDO0lBRVMsV0FBVztRQUNuQixVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMvRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFUyxLQUFLO1FBQ2IsSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLENBQUM7U0FDN0I7SUFDSCxDQUFDO0lBV1MsWUFBWSxDQUFDLElBQW9CO1FBQ3pDLElBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxJQUFJLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFHTSxXQUFXLENBQUMsS0FBb0IsRUFBRSxLQUFhO1FBQ3BELElBQUcsS0FBSyxDQUFDLEdBQUcsS0FBSyxPQUFPLEVBQUU7WUFDeEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN6QjtJQUNILENBQUM7SUFHTSxZQUFZLENBQUMsS0FBYSxFQUFFLE1BQU07O1FBQ3ZDLElBQUksQ0FBQSxNQUFBLElBQUksQ0FBQyxjQUFjLDBDQUFFLFFBQVEsTUFBSyxNQUFNLEVBQUc7WUFDN0MsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN6QjtJQUNILENBQUM7SUFHTSxVQUFVLENBQUMsS0FBYTs7UUFDN0IsSUFBSSxDQUFBLE1BQUEsSUFBSSxDQUFDLGNBQWMsMENBQUUsUUFBUSxNQUFLLE1BQU0sRUFBRztZQUM3QyxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3pCO1FBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFN0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFUyxXQUFXLENBQUMsS0FBYTtRQUNqQyxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUU7WUFDWCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxlQUFlLENBQUM7WUFDL0MsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRTlCLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUE7WUFFdkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUMvQixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQ3hCO2lCQUFNLElBQUksaUJBQWlCLEtBQUssSUFBSSxDQUFDLGVBQWUsRUFBRTtnQkFDckQsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7YUFDM0I7U0FDRjthQUFNO1lBQ0wsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QjtJQUNILENBQUM7O3VIQWxSbUIseUJBQXlCOzJHQUF6Qix5QkFBeUI7NEZBQXpCLHlCQUF5QjtrQkFEOUMsU0FBUzt5SkFNUSxjQUFjO3NCQUE3QixLQUFLO2dCQU9LLEtBQUs7c0JBRGYsS0FBSztnQkFNSyxRQUFRO3NCQURsQixLQUFLO2dCQVFDLE9BQU87c0JBRGIsTUFBTTt1QkFBQyxRQUFRO2dCQUlULFNBQVM7c0JBRGYsTUFBTTt1QkFBQyxVQUFVO2dCQUlYLE9BQU87c0JBRGIsTUFBTTt1QkFBQyxRQUFRO2dCQUtULFFBQVE7c0JBRmQsV0FBVzt1QkFBQyx5QkFBeUI7O3NCQUNyQyxXQUFXO3VCQUFDLGVBQWU7Z0JBSWpCLGFBQWE7c0JBRHZCLEtBQUs7dUJBQUMsVUFBVTtnQkFPVixRQUFRO3NCQUZkLFdBQVc7dUJBQUMseUJBQXlCOztzQkFDckMsV0FBVzt1QkFBQyxlQUFlO2dCQWlNckIsV0FBVztzQkFEakIsWUFBWTt1QkFBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLEVBQUUscUJBQXFCLENBQUM7Z0JBUWpELFlBQVk7c0JBRGxCLFlBQVk7dUJBQUMsT0FBTyxFQUFFLENBQUMscUJBQXFCLEVBQUUsZUFBZSxDQUFDO2dCQVF4RCxVQUFVO3NCQURoQixZQUFZO3VCQUFDLE1BQU0sRUFBRSxDQUFDLHFCQUFxQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVuZGVyZXIyLCBIb3N0TGlzdGVuZXIsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBPbkRlc3Ryb3ksIEhvc3RCaW5kaW5nLCBJbnB1dCwgQ2hhbmdlRGV0ZWN0b3JSZWYsIERpcmVjdGl2ZSwgT25Jbml0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IGZyb21FdmVudCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZmlsdGVyLCB0YWtlLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxuaW1wb3J0IHsgRnNEYXRlUGlja2VyRGlhbG9nUmVmIH0gZnJvbSAnLi4vLi4vbGlicy9kaWFsb2cvY2xhc3Nlcy9kaWFsb2ctcmVmJztcblxuaW1wb3J0IHtcbiAgQWJzdHJhY3RDb250cm9sLFxuICBDb250cm9sVmFsdWVBY2Nlc3NvcixcbiAgVmFsaWRhdGlvbkVycm9ycyxcbiAgVmFsaWRhdG9yLFxuICBWYWxpZGF0b3JGbixcbiAgVmFsaWRhdG9yc1xufSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbmltcG9ydCB7IGlzRXF1YWwsIGlzVmFsaWQgfSBmcm9tICdkYXRlLWZucyc7XG5pbXBvcnQgeyB6b25lZFRpbWVUb1V0YyB9IGZyb20gJ2RhdGUtZm5zLXR6JztcblxuaW1wb3J0IHsgcGFyc2VEYXRlIH0gZnJvbSAnLi4vaGVscGVycy9wYXJzZS1kYXRlJztcblxuXG5ARGlyZWN0aXZlKClcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBGc0RhdGVQaWNrZXJCYXNlQ29tcG9uZW50PEQgPSBhbnk+XG4gIGltcGxlbWVudHMgVmFsaWRhdG9yLCBDb250cm9sVmFsdWVBY2Nlc3NvciwgT25EZXN0cm95LCBPbkluaXQge1xuXG4gIGFic3RyYWN0IHVwZGF0ZUlucHV0KHZhbHVlOiBEYXRlKTogdm9pZDtcblxuICBASW5wdXQoKSBwdWJsaWMgbmdNb2RlbE9wdGlvbnM6IHtcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHN0YW5kYWxvbmU/OiBib29sZWFuO1xuICAgIHVwZGF0ZU9uPzogJ2NoYW5nZScgfCAnYmx1cicgfCAnc3VibWl0JztcbiAgfTtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgc2V0IGNsZWFyKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5fY2xlYXIgPSB2YWx1ZTtcbiAgfVxuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBzZXQgdGltZXpvbmUodmFsdWU6IHN0cmluZykge1xuICAgIHRoaXMuX3RpbWV6b25lID0gdmFsdWU7XG5cbiAgICB0aGlzLndyaXRlVmFsdWUodGhpcy5fb3JpZ2luVmFsdWUpO1xuICB9XG5cbiAgQE91dHB1dCgnY2hhbmdlJylcbiAgcHVibGljIGNoYW5nZSQgPSBuZXcgRXZlbnRFbWl0dGVyPERhdGU+KCk7XG5cbiAgQE91dHB1dCgnc2VsZWN0ZWQnKVxuICBwdWJsaWMgc2VsZWN0ZWQkID0gbmV3IEV2ZW50RW1pdHRlcjxEYXRlPigpO1xuXG4gIEBPdXRwdXQoJ2JsdXJlZCcpXG4gIHB1YmxpYyBibHVyZWQkID0gbmV3IEV2ZW50RW1pdHRlcjxEYXRlPigpO1xuXG4gIEBIb3N0QmluZGluZygnY2xhc3MuZnMtaW5wdXQtZGlzYWJsZWQnKVxuICBASG9zdEJpbmRpbmcoJ2F0dHIucmVhZG9ubHknKVxuICBwdWJsaWMgZGlzYWJsZWQgPSBmYWxzZTtcblxuICBASW5wdXQoJ3JlYWRvbmx5JylcbiAgcHVibGljIHNldCByZWFkb25seVN0YXRlKGlzUmVhZG9ubHk6IHN0cmluZykge1xuICAgIHRoaXMucmVhZG9ubHkgPSAhIWlzUmVhZG9ubHkgfHwgaXNSZWFkb25seSA9PT0gJyc7XG4gIH1cblxuICBASG9zdEJpbmRpbmcoJ2NsYXNzLmZzLWlucHV0LXJlYWRvbmx5JylcbiAgQEhvc3RCaW5kaW5nKCdhdHRyLnJlYWRvbmx5JylcbiAgcHVibGljIHJlYWRvbmx5ID0gZmFsc2U7XG5cbiAgcHVibGljIG9wZW5lZCA9IGZhbHNlO1xuICBwdWJsaWMgcmVnaXN0ZXJPbkNoYW5nZShmbjogKHZhbHVlOiBhbnkpID0+IGFueSk6IHZvaWQgeyB0aGlzLl9vbkNoYW5nZSA9IGZuIH1cbiAgcHVibGljIHJlZ2lzdGVyT25Ub3VjaGVkKGZuOiAoKSA9PiBhbnkpOiB2b2lkIHsgdGhpcy5fb25Ub3VjaCA9IGZuIH1cbiAgcHVibGljIHJlZ2lzdGVyT25WYWxpZGF0b3JDaGFuZ2UoZm46ICgpID0+IHZvaWQpOiB2b2lkIHsgdGhpcy5fdmFsaWRhdG9yT25DaGFuZ2UgPSBmbjsgfVxuXG4gIHByb3RlY3RlZCBfdGltZXpvbmU6IHN0cmluZztcbiAgcHJvdGVjdGVkIF9vcmlnaW5WYWx1ZTogRGF0ZSB8IG51bGw7IC8vIGJlZm9yZSB0aW1lem9uZVxuICBwcm90ZWN0ZWQgX3ZhbHVlO1xuICBwcm90ZWN0ZWQgZGlhbG9nID0gbnVsbDtcbiAgcHJvdGVjdGVkIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWY7XG4gIHByb3RlY3RlZCByZW5kZXJlcjtcbiAgcHJvdGVjdGVkIF9kYXRlRGlhbG9nUmVmOiBGc0RhdGVQaWNrZXJEaWFsb2dSZWY7XG4gIHByb3RlY3RlZCBfZGVzdHJveSQgPSBuZXcgU3ViamVjdCgpO1xuXG4gIHByaXZhdGUgX29uQ2hhbmdlID0gKHZhbHVlOiBhbnkpID0+IHsgfTtcbiAgcHJpdmF0ZSBfb25Ub3VjaCA9ICgpID0+IHsgfTtcbiAgcHJpdmF0ZSBfdmFsaWRhdG9yT25DaGFuZ2UgPSAoKSA9PiB7fTtcbiAgcHJpdmF0ZSBfY2xlYXIgPSB0cnVlO1xuICBwcml2YXRlIF9sYXN0VmFsdWVWYWxpZCA9IGZhbHNlO1xuXG4gIHByb3RlY3RlZCBjb25zdHJ1Y3RvcihcbiAgICByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJvdGVjdGVkIF9jZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWZcbiAgKSB7XG4gICAgdGhpcy5yZW5kZXJlciA9IHJlbmRlcmVyO1xuICAgIHRoaXMuZWxlbWVudFJlZiA9IGVsZW1lbnRSZWY7XG4gIH1cblxuICBwdWJsaWMgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgZnJvbUV2ZW50KHRoaXMuZWwsICdmb2N1cycpXG4gICAgLnBpcGUoXG4gICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgIClcbiAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMub3BlbigpO1xuICAgICAgdGhpcy5lbC5mb2N1cygpO1xuICAgIH0pO1xuXG4gICAgZnJvbUV2ZW50KHRoaXMuZWwsICdrZXlkb3duJylcbiAgICAgIC5waXBlKFxuICAgICAgICB0YXAoKCkgPT4gdGhpcy5jbG9zZSgpKSxcbiAgICAgICAgZmlsdGVyKChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4gWydUYWInLCAnRW50ZXInLCAnRXNjYXBlJ10uaW5jbHVkZXMoZXZlbnQua2V5KSksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKChldmVudDogS2V5Ym9hcmRFdmVudCkgPT4ge1xuICAgICAgICBpZiAoZXZlbnQua2V5ID09PSAnRW50ZXInKSB7XG4gICAgICAgICAgdGhpcy5pbnB1dENoYW5nZSh0aGlzLmVsLnZhbHVlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgdGhpcy5lbC5ibHVyKCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZWwoKSB7XG4gICAgcmV0dXJuIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50O1xuICB9XG5cbiAgcHVibGljIGdldCBjbGVhcigpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5fY2xlYXI7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdGltZXpvbmUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fdGltZXpvbmU7XG4gIH1cblxuICBwdWJsaWMgc2V0IHZhbHVlKHZhbHVlKSB7XG4gICAgaWYgKHZhbHVlICYmIHRoaXMudGltZXpvbmUpIHtcbiAgICAgIHZhbHVlID0gem9uZWRUaW1lVG9VdGModmFsdWUsIHRoaXMudGltZXpvbmUpO1xuICAgIH1cblxuICAgIHRoaXMuX3ZhbHVlID0gdmFsdWU7XG5cbiAgICB0aGlzLl9sYXN0VmFsdWVWYWxpZCA9ICF2YWx1ZSB8fCBpc1ZhbGlkKHZhbHVlKTtcblxuICAgIHRoaXMuX29uQ2hhbmdlKHRoaXMudmFsdWUpO1xuICAgIHRoaXMudXBkYXRlSW5wdXQodGhpcy52YWx1ZSk7XG5cbiAgICB0aGlzLmNoYW5nZSQuZW1pdCh0aGlzLnZhbHVlKTtcbiAgfVxuXG4gIHB1YmxpYyB3cml0ZVZhbHVlKG9iajogYW55KTogdm9pZCB7fVxuXG4gIHB1YmxpYyBnZXQgZGF0ZURpYWxvZ1JlZigpIHtcbiAgICByZXR1cm4gdGhpcy5fZGF0ZURpYWxvZ1JlZjtcbiAgfVxuXG4gIHB1YmxpYyBjbGVhcmVkKGV2ZW50KSB7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgIHRoaXMudmFsdWUgPSBudWxsO1xuICAgIHRoaXMuY2xlYXJJbnB1dCgpO1xuICAgIHRoaXMuc2VsZWN0ZWQkLm5leHQobnVsbCk7XG4gIH1cblxuICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMuZGF0ZURpYWxvZ1JlZikge1xuICAgICAgdGhpcy5kYXRlRGlhbG9nUmVmLmNsb3NlKCk7XG4gICAgfVxuXG4gICAgdGhpcy5fZGVzdHJveSQubmV4dCgpO1xuICAgIHRoaXMuX2Rlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwdWJsaWMgc2V0RGlzYWJsZWRTdGF0ZShpc0Rpc2FibGVkOiBib29sZWFuKSB7XG4gICAgdGhpcy5kaXNhYmxlZCA9IGlzRGlzYWJsZWQ7XG5cbiAgICB0aGlzLl9jZFJlZi5tYXJrRm9yQ2hlY2soKTtcbiAgfVxuXG4gIHB1YmxpYyB2YWxpZGF0ZShjOiBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0aW9uRXJyb3JzIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbGlkYXRvciA/IHRoaXMuX3ZhbGlkYXRvcihjKSA6IG51bGw7XG4gIH1cblxuICBwdWJsaWMgb3BlbigpIHtcbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKGRvY3VtZW50LmJvZHksICdmcy1kYXRlLXBpY2tlci1vcGVuJyk7XG4gICAgdGhpcy5vcGVuZWQgPSB0cnVlO1xuXG4gICAgdGhpcy5fZGF0ZURpYWxvZ1JlZi52YWx1ZSRcbiAgICAgIC5waXBlKFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGF0ZURpYWxvZ1JlZi5jbG9zZSQpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgodmFsdWU6IERhdGUpID0+IHtcbiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlO1xuICAgICAgICB0aGlzLnNlbGVjdGVkJC5lbWl0KHZhbHVlKTtcbiAgICAgIH0pO1xuXG4gICAgdGhpcy5fZGF0ZURpYWxvZ1JlZi5jbG9zZSRcbiAgICAgIC5waXBlKFxuICAgICAgICB0YWtlKDEpLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5fZGVzdHJveSQpLFxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgIHRoaXMuX2RhdGVEaWFsb2dSZWYgPSBudWxsO1xuICAgICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKGRvY3VtZW50LmJvZHksICdmcy1kYXRlLXBpY2tlci1vcGVuJyk7XG4gICAgICAgIHRoaXMuX2NkUmVmLm1hcmtGb3JDaGVjaygpO1xuICAgICAgfSk7XG4gIH1cblxuICBwdWJsaWMgY2xlYXJJbnB1dCgpIHtcbiAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC52YWx1ZSA9IG51bGw7XG4gIH1cblxuICBwdWJsaWMgdHJpZ2dlckNsaWNrKCk6IHZvaWQge1xuICAgIHRoaXMuZWwuZm9jdXMoKTtcbiAgICB0aGlzLmVsLnNlbGVjdCgpO1xuXG4gICAgdGhpcy5vcGVuKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdXBkYXRlVmFsdWUoZGF0ZSk6IHZvaWQge1xuICAgIHRoaXMuX3ZhbHVlID0gZGF0ZTtcbiAgICB0aGlzLl9vbkNoYW5nZSh0aGlzLnZhbHVlKTtcbiAgICB0aGlzLl9vblRvdWNoKCk7XG4gICAgdGhpcy5jaGFuZ2UkLmVtaXQodGhpcy52YWx1ZSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgc2V0UmVhZG9ubHkoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ3JlYWRvbmx5JywgdHJ1ZSk7XG4gICAgfSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgY2xvc2UoKSB7XG4gICAgaWYgKHRoaXMuX2RhdGVEaWFsb2dSZWYpIHtcbiAgICAgIHRoaXMuX2RhdGVEaWFsb2dSZWYuY2xvc2UoKTtcbiAgICB9XG4gIH1cblxuICAvKiogVGhlIGZvcm0gY29udHJvbCB2YWxpZGF0b3IgZm9yIHdoZXRoZXIgdGhlIGlucHV0IHBhcnNlcy4gKi9cbiAgcHJvdGVjdGVkIF9wYXJzZVZhbGlkYXRvcjogVmFsaWRhdG9yRm4gPSAoKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwgPT4ge1xuICAgIHJldHVybiB0aGlzLl9sYXN0VmFsdWVWYWxpZFxuICAgICAgPyBudWxsXG4gICAgICA6IHsgZnNEYXRlcGlja2VyUGFyc2U6ICdJbnZhbGlkIERhdGUnIH07XG4gIH1cblxuICBwcm90ZWN0ZWQgX3ZhbGlkYXRvcjogVmFsaWRhdG9yRm4gfCBudWxsID0gVmFsaWRhdG9ycy5jb21wb3NlKFt0aGlzLl9wYXJzZVZhbGlkYXRvcl0pO1xuXG4gIHByb3RlY3RlZCB2YWxpZGF0ZURhdGUoZGF0ZTogRGF0ZSB8IHVua25vd24pIHtcbiAgICB0aGlzLl9sYXN0VmFsdWVWYWxpZCA9ICFkYXRlIHx8IGlzVmFsaWQoZGF0ZSk7XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdrZXl1cCcsIFsnJGV2ZW50JywgJyRldmVudC50YXJnZXQudmFsdWUnXSlcbiAgcHVibGljIF9pbnB1dEtleXVwKGV2ZW50OiBLZXlib2FyZEV2ZW50LCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYoZXZlbnQua2V5ID09PSAnRW50ZXInKSB7XG4gICAgICB0aGlzLmlucHV0Q2hhbmdlKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdpbnB1dCcsIFsnJGV2ZW50LnRhcmdldC52YWx1ZScsICckZXZlbnQudGFyZ2V0J10pXG4gIHB1YmxpYyBfaW5wdXRDaGFuZ2UodmFsdWU6IHN0cmluZywgdGFyZ2V0KTogdm9pZCB7XG4gICAgaWYgKHRoaXMubmdNb2RlbE9wdGlvbnM/LnVwZGF0ZU9uICE9PSAnYmx1cicpICB7XG4gICAgICB0aGlzLmlucHV0Q2hhbmdlKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdibHVyJywgWyckZXZlbnQudGFyZ2V0LnZhbHVlJ10pXG4gIHB1YmxpYyBfaW5wdXRCbHVyKHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5uZ01vZGVsT3B0aW9ucz8udXBkYXRlT24gPT09ICdibHVyJykgIHtcbiAgICAgIHRoaXMuaW5wdXRDaGFuZ2UodmFsdWUpO1xuICAgIH1cblxuICAgIHRoaXMudXBkYXRlSW5wdXQodGhpcy52YWx1ZSk7XG5cbiAgICB0aGlzLmJsdXJlZCQuZW1pdCh0aGlzLnZhbHVlKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBpbnB1dENoYW5nZSh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCEhdmFsdWUpIHtcbiAgICAgIGNvbnN0IGxhc3RWYWx1ZVdhc1ZhbGlkID0gdGhpcy5fbGFzdFZhbHVlVmFsaWQ7XG4gICAgICBjb25zdCBkYXRlID0gcGFyc2VEYXRlKHZhbHVlKTtcblxuICAgICAgdGhpcy52YWxpZGF0ZURhdGUoZGF0ZSlcblxuICAgICAgaWYgKCFpc0VxdWFsKGRhdGUsIHRoaXMuX3ZhbHVlKSkge1xuICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlKGRhdGUpO1xuICAgICAgfSBlbHNlIGlmIChsYXN0VmFsdWVXYXNWYWxpZCAhPT0gdGhpcy5fbGFzdFZhbHVlVmFsaWQpIHtcbiAgICAgICAgdGhpcy5fdmFsaWRhdG9yT25DaGFuZ2UoKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy51cGRhdGVWYWx1ZShudWxsKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==