import { ChangeDetectorRef, Directive, ElementRef, HostBinding, HostListener, Injector, Input } from '@angular/core';
import { NgControl, } from '@angular/forms';
import { Subject } from 'rxjs';
import { filter, map, pairwise, skip, take, takeUntil } from 'rxjs/operators';
import { isDate, isEqual, isValid, subDays } from 'date-fns';
import { zonedTimeToUtc } from 'date-fns-tz';
import { FsDatePickerDialogFactory } from '../../../../libs/dialog/services/dialog-factory.service';
import { PickerViewType } from '../../../../libs/common/enums/picker-view-type.enum';
import { isSameDate } from '../../../../libs/common/helpers/is-same-date';
import { formatDateTime } from '../../../helpers/format-date-time';
import { createDateFromValue } from '../../../helpers/create-date-from-value';
import { parseDate } from '../../../helpers/parse-date';
import * as i0 from "@angular/core";
import * as i1 from "../../../../libs/dialog/services/dialog-factory.service";
import * as i2 from "@angular/forms";
export class RangePickerComponent {
    constructor(_elRef, _injector, _datepickerFactory, _type, _cdRef, _ngControl) {
        this._elRef = _elRef;
        this._injector = _injector;
        this._datepickerFactory = _datepickerFactory;
        this._type = _type;
        this._cdRef = _cdRef;
        this._ngControl = _ngControl;
        this.view = PickerViewType.Date;
        this.minYear = null;
        this.maxYear = null;
        this.minDate = null;
        this.maxDate = null;
        this.clear = true;
        this.disabled = false;
        this.readonly = false;
        this.onTouch = () => { };
        this._destroy$ = new Subject();
        this._lastValueValid = false;
        /** The form control validator for whether the input parses. */
        this._parseValidator = () => {
            return this._lastValueValid
                ? null
                : { fsDatepickerParse: 'Invalid Date' };
        };
        this._ngControl.valueAccessor = this;
        this._elRef.nativeElement.setAttribute('autocomplete', 'off');
    }
    set readonlyState(isReadonly) {
        this.readonly = !!isReadonly || isReadonly === '';
    }
    set timezone(value) {
        this._timezone = value;
        this._tzChanged(this._originValue);
    }
    get name() {
        return this._name;
    }
    get timezone() {
        return this._timezone;
    }
    set value(value) {
        if (this._value !== value) {
            this._value = value;
            this.onChange(value);
            this.onTouch(value);
        }
    }
    ngOnInit() {
        const control = this._ngControl.control;
        const validators = control.validator
            ? [control.validator, this._parseValidator]
            : this._parseValidator;
        control.setValidators(validators);
        control.updateValueAndValidity();
    }
    get value() {
        return this._value;
    }
    get dateDialogRef() {
        return this._dateDialogRef;
    }
    writeValue(value) {
        value = this._processInputDate(value);
        this._originValue = value;
        this.validateDate(value);
        const [valuesAreDates] = this._checkValuesEquality(value, this.value);
        if ((valuesAreDates) || (!valuesAreDates && this.value !== value)) {
            this._value = value;
            this.updateInput(this._value);
            this._cdRef.markForCheck();
        }
    }
    setDisabledState(isDisabled) {
        this.disabled = isDisabled;
    }
    open() {
        if (this._dateDialogRef || this.disabled || this.readonly) {
            return;
        }
        //this._disableInput();
        this._dateDialogRef = this._datepickerFactory.openDatePicker(this._elRef, this._injector, {
            view: this.view,
            minYear: this.minYear,
            maxYear: this.maxYear,
            minDate: this._getPickerStartDate() || this.minDate,
            maxDate: this.maxDate,
            components: this._getDefaultComponents(),
            modelValue: this.value,
            pickerRef: this._pickerRef,
            rangeType: this._type
        });
        this._elRef.nativeElement.focus();
        this._listenDialogValueChanges();
        this._dateDialogRef.close$
            .pipe(take(1), takeUntil(this._destroy$))
            .subscribe(() => {
            this._dateDialogRef = null;
            this._enableInput();
            this._cdRef.markForCheck();
        });
    }
    /**
     * Set value which was selected in dialog
     * @param value
     */
    updateValueFromDialog(value) {
        this.updateValue(value);
        // this.writeValue(value);
    }
    updateValue(value) {
        if (this.view === PickerViewType.Time && isValid(this._value) && isValid(value)) {
            this._value.setHours(value.getHours());
            this._value.setMinutes(value.getMinutes());
            this._value.setSeconds(value.getSeconds());
            value = new Date(this._value);
        }
        this._value = value;
        this.updateInput(this._value);
        if (value && this.timezone) {
            value = zonedTimeToUtc(value, this.timezone);
        }
        this.onChange(value);
        this.onTouch(value);
    }
    updateInput(value) {
        this._elRef.nativeElement.value = formatDateTime(value, this.view, this.format, this.timezone);
    }
    _inputKeyup(event, value) {
        if (event.key === 'Enter') {
            this.inputChange(value);
        }
    }
    _inputChange(value, target) {
        var _a;
        if (((_a = this.ngModelOptions) === null || _a === void 0 ? void 0 : _a.updateOn) !== 'blur') {
            this.inputChange(value);
        }
    }
    inputChange(value) {
        const lastValueWasValid = this._lastValueValid;
        const date = parseDate(value);
        this._lastValueValid = !date || isValid(date);
        if (!isEqual(date, this._value)) {
            this.updateValue(date);
        }
        else if (lastValueWasValid !== this._lastValueValid) {
            this._ngControl.control.updateValueAndValidity();
        }
    }
    _inputBlur(value) {
        var _a;
        if (((_a = this.ngModelOptions) === null || _a === void 0 ? void 0 : _a.updateOn) === 'blur') {
            this.inputChange(value);
        }
        this.updateInput(this.value);
    }
    registerOnChange(fn) { this.onChange = fn; }
    registerOnTouched(fn) { this.onTouch = fn; }
    triggerClick() {
        this._elRef.nativeElement.focus();
        this._elRef.nativeElement.select();
        this.open();
    }
    _processInputDate(date) {
        if (!date) {
            return null;
        }
        return createDateFromValue(date, this.timezone);
    }
    _getDefaultComponents() {
        if (this.view === 'time') {
            return { timeStart: true };
        }
        else {
            return { calendarStart: true, calendarEnd: true };
        }
    }
    _enableInput() {
        this.disabled = false;
    }
    _disableInput() {
        this.disabled = true;
    }
    _tzChanged(originDate) {
        this._value = createDateFromValue(originDate, this.timezone);
        this.updateInput(this._value);
        this._cdRef.markForCheck();
    }
    _listenDialogValueChanges() {
        this._dateDialogRef.value$
            .pipe(takeUntil(this._dateDialogRef.close$), takeUntil(this._destroy$))
            .subscribe((value) => {
            this.updateValueFromDialog(value);
        });
    }
    _checkValuesEquality(newValue, prevValue) {
        const valuesAreDates = isDate(newValue) && isDate(prevValue) && isValid(newValue) && isValid(prevValue);
        const valuesDatesEquals = valuesAreDates
            && isSameDate(newValue, prevValue);
        return [valuesAreDates, valuesDatesEquals];
    }
    /**
     * We need picker start date to be able to limit "Date To" picker
     */
    _getPickerStartDate() {
        if (this.view !== PickerViewType.MonthRange
            && isDate(this._pickerRef.startDate)
            && isValid(this._pickerRef.startDate)) {
            return subDays(this._pickerRef.startDate, 1);
        }
        return false;
    }
    validateDate(date) {
        this._lastValueValid = !date || isValid(date);
    }
    _pickerRefUpdates$(target) {
        return target
            .pipe(skip(1), pairwise(), filter((changes) => {
            var _a, _b, _c;
            const prevValue = (_a = changes[0]) === null || _a === void 0 ? void 0 : _a.getTime();
            const newValue = (_b = changes[1]) === null || _b === void 0 ? void 0 : _b.getTime();
            return prevValue !== newValue
                && ((_c = this.value) === null || _c === void 0 ? void 0 : _c.getTime()) !== newValue;
        }), map((changes) => changes[1]));
    }
}
RangePickerComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: RangePickerComponent, deps: "invalid", target: i0.ɵɵFactoryTarget.Directive });
RangePickerComponent.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "12.2.16", type: RangePickerComponent, inputs: { view: "view", minYear: "minYear", maxYear: "maxYear", minDate: "minDate", maxDate: "maxDate", clear: "clear", format: "format", readonlyState: ["readonly", "readonlyState"], ngModelOptions: "ngModelOptions", timezone: "timezone" }, host: { listeners: { "focus": "open()", "keyup": "_inputKeyup($event,$event.target.value)", "input": "_inputChange($event.target.value,$event.target)", "blur": "_inputBlur($event.target.value)" }, properties: { "class.fs-input-disabled": "this.disabled", "attr.readonly": "this.readonly", "class.fs-input-readonly": "this.readonly" } }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: RangePickerComponent, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: i0.ElementRef }, { type: i0.Injector }, { type: i1.FsDatePickerDialogFactory }, { type: undefined }, { type: i0.ChangeDetectorRef }, { type: i2.NgControl }]; }, propDecorators: { view: [{
                type: Input
            }], minYear: [{
                type: Input
            }], maxYear: [{
                type: Input
            }], minDate: [{
                type: Input
            }], maxDate: [{
                type: Input
            }], clear: [{
                type: Input
            }], format: [{
                type: Input
            }], disabled: [{
                type: HostBinding,
                args: ['class.fs-input-disabled']
            }, {
                type: HostBinding,
                args: ['attr.readonly']
            }], readonlyState: [{
                type: Input,
                args: ['readonly']
            }], ngModelOptions: [{
                type: Input
            }], timezone: [{
                type: Input
            }], readonly: [{
                type: HostBinding,
                args: ['class.fs-input-readonly']
            }, {
                type: HostBinding,
                args: ['attr.readonly']
            }], open: [{
                type: HostListener,
                args: ['focus']
            }], _inputKeyup: [{
                type: HostListener,
                args: ['keyup', ['$event', '$event.target.value']]
            }], _inputChange: [{
                type: HostListener,
                args: ['input', ['$event.target.value', '$event.target']]
            }], _inputBlur: [{
                type: HostListener,
                args: ['blur', ['$event.target.value']]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmFuZ2UtcGlja2VyLWJhc2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9jb21wb25lbnRzL3JhbmdlLXBpY2tlci9iYXNlL3JhbmdlLXBpY2tlci1iYXNlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsV0FBVyxFQUNYLFlBQVksRUFDWixRQUFRLEVBQ1IsS0FBSyxFQUVOLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBd0IsU0FBUyxHQUFrQyxNQUFNLGdCQUFnQixDQUFDO0FBRWpHLE9BQU8sRUFBYyxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDM0MsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUM3RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRTdDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLHlEQUF5RCxDQUFDO0FBRXBHLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxxREFBcUQsQ0FBQztBQUNyRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sOENBQThDLENBQUM7QUFHMUUsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQzlFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQzs7OztBQUl4RCxNQUFNLE9BQWdCLG9CQUFvQjtJQStEeEMsWUFDWSxNQUFrQixFQUNsQixT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T0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQzdCLENBQUM7SUFDTixDQUFDOztrSEFyVm1CLG9CQUFvQjtzR0FBcEIsb0JBQW9COzRGQUFwQixvQkFBb0I7a0JBRHpDLFNBQVM7Nk9BS0QsSUFBSTtzQkFEVixLQUFLO2dCQUlDLE9BQU87c0JBRGIsS0FBSztnQkFJQyxPQUFPO3NCQURiLEtBQUs7Z0JBSUMsT0FBTztzQkFEYixLQUFLO2dCQUlDLE9BQU87c0JBRGIsS0FBSztnQkFJQyxLQUFLO3NCQURYLEtBQUs7Z0JBSUMsTUFBTTtzQkFEWixLQUFLO2dCQUtDLFFBQVE7c0JBRmQsV0FBVzt1QkFBQyx5QkFBeUI7O3NCQUNyQyxXQUFXO3VCQUFDLGVBQWU7Z0JBSWpCLGFBQWE7c0JBRHZCLEtBQUs7dUJBQUMsVUFBVTtnQkFLRCxjQUFjO3NCQUE3QixLQUFLO2dCQU9LLFFBQVE7c0JBRGxCLEtBQUs7Z0JBU0MsUUFBUTtzQkFGZCxXQUFXO3VCQUFDLHlCQUF5Qjs7c0JBQ3JDLFdBQVc7dUJBQUMsZUFBZTtnQkFvRnJCLElBQUk7c0JBRFYsWUFBWTt1QkFBQyxPQUFPO2dCQTJFZCxXQUFXO3NCQURqQixZQUFZO3VCQUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsRUFBRSxxQkFBcUIsQ0FBQztnQkFRakQsWUFBWTtzQkFEbEIsWUFBWTt1QkFBQyxPQUFPLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxlQUFlLENBQUM7Z0JBcUJ4RCxVQUFVO3NCQURoQixZQUFZO3VCQUFDLE1BQU0sRUFBRSxDQUFDLHFCQUFxQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIERpcmVjdGl2ZSxcbiAgRWxlbWVudFJlZixcbiAgSG9zdEJpbmRpbmcsXG4gIEhvc3RMaXN0ZW5lcixcbiAgSW5qZWN0b3IsXG4gIElucHV0LFxuICBPbkluaXRcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb250cm9sVmFsdWVBY2Nlc3NvciwgTmdDb250cm9sLCBWYWxpZGF0aW9uRXJyb3JzLCBWYWxpZGF0b3JGbiwgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBwYWlyd2lzZSwgc2tpcCwgdGFrZSwgdGFrZVVudGlsIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBpc0RhdGUsIGlzRXF1YWwsIGlzVmFsaWQsIHN1YkRheXMgfSBmcm9tICdkYXRlLWZucyc7XG5pbXBvcnQgeyB6b25lZFRpbWVUb1V0YyB9IGZyb20gJ2RhdGUtZm5zLXR6JztcblxuaW1wb3J0IHsgRnNEYXRlUGlja2VyRGlhbG9nRmFjdG9yeSB9IGZyb20gJy4uLy4uLy4uLy4uL2xpYnMvZGlhbG9nL3NlcnZpY2VzL2RpYWxvZy1mYWN0b3J5LnNlcnZpY2UnO1xuaW1wb3J0IHsgRnNEYXRlUGlja2VyRGlhbG9nUmVmIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGlicy9kaWFsb2cvY2xhc3Nlcy9kaWFsb2ctcmVmJztcbmltcG9ydCB7IFBpY2tlclZpZXdUeXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4vbGlicy9jb21tb24vZW51bXMvcGlja2VyLXZpZXctdHlwZS5lbnVtJztcbmltcG9ydCB7IGlzU2FtZURhdGUgfSBmcm9tICcuLi8uLi8uLi8uLi9saWJzL2NvbW1vbi9oZWxwZXJzL2lzLXNhbWUtZGF0ZSc7XG5cbmltcG9ydCB7IFJhbmdlUGlja2VyUmVmIH0gZnJvbSAnLi4vLi4vLi4vY2xhc3Nlcy9yYW5nZS1waWNrZXItcmVmJztcbmltcG9ydCB7IGZvcm1hdERhdGVUaW1lIH0gZnJvbSAnLi4vLi4vLi4vaGVscGVycy9mb3JtYXQtZGF0ZS10aW1lJztcbmltcG9ydCB7IGNyZWF0ZURhdGVGcm9tVmFsdWUgfSBmcm9tICcuLi8uLi8uLi9oZWxwZXJzL2NyZWF0ZS1kYXRlLWZyb20tdmFsdWUnO1xuaW1wb3J0IHsgcGFyc2VEYXRlIH0gZnJvbSAnLi4vLi4vLi4vaGVscGVycy9wYXJzZS1kYXRlJztcblxuXG5ARGlyZWN0aXZlKClcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSYW5nZVBpY2tlckNvbXBvbmVudDxEID0gYW55PlxuICBpbXBsZW1lbnRzIENvbnRyb2xWYWx1ZUFjY2Vzc29yLCBPbkluaXQge1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyB2aWV3ID0gUGlja2VyVmlld1R5cGUuRGF0ZTtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgbWluWWVhcjogbnVtYmVyID0gbnVsbDtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgbWF4WWVhcjogbnVtYmVyID0gbnVsbDtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgbWluRGF0ZTogRGF0ZSA9IG51bGw7XG5cbiAgQElucHV0KClcbiAgcHVibGljIG1heERhdGU6IERhdGUgPSBudWxsO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBjbGVhciA9IHRydWU7XG5cbiAgQElucHV0KClcbiAgcHVibGljIGZvcm1hdDogc3RyaW5nO1xuXG4gIEBIb3N0QmluZGluZygnY2xhc3MuZnMtaW5wdXQtZGlzYWJsZWQnKVxuICBASG9zdEJpbmRpbmcoJ2F0dHIucmVhZG9ubHknKVxuICBwdWJsaWMgZGlzYWJsZWQgPSBmYWxzZTtcblxuICBASW5wdXQoJ3JlYWRvbmx5JylcbiAgcHVibGljIHNldCByZWFkb25seVN0YXRlKGlzUmVhZG9ubHk6IHN0cmluZykge1xuICAgIHRoaXMucmVhZG9ubHkgPSAhIWlzUmVhZG9ubHkgfHwgaXNSZWFkb25seSA9PT0gJyc7XG4gIH1cblxuICBASW5wdXQoKSBwdWJsaWMgbmdNb2RlbE9wdGlvbnM6IHtcbiAgICBuYW1lPzogc3RyaW5nO1xuICAgIHN0YW5kYWxvbmU/OiBib29sZWFuO1xuICAgIHVwZGF0ZU9uPzogJ2NoYW5nZScgfCAnYmx1cicgfCAnc3VibWl0JztcbiAgfTtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgc2V0IHRpbWV6b25lKHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl90aW1lem9uZSA9IHZhbHVlO1xuXG4gICAgdGhpcy5fdHpDaGFuZ2VkKHRoaXMuX29yaWdpblZhbHVlKTtcbiAgfVxuXG4gIEBIb3N0QmluZGluZygnY2xhc3MuZnMtaW5wdXQtcmVhZG9ubHknKVxuICBASG9zdEJpbmRpbmcoJ2F0dHIucmVhZG9ubHknKVxuICBwdWJsaWMgcmVhZG9ubHkgPSBmYWxzZTtcblxuICBwdWJsaWMgb25DaGFuZ2U6IGFueTtcbiAgcHVibGljIG9uVG91Y2g6IGFueSA9ICgpID0+IHt9O1xuXG4gIHByb3RlY3RlZCBfZGF0ZURpYWxvZ1JlZjogRnNEYXRlUGlja2VyRGlhbG9nUmVmO1xuICBwcm90ZWN0ZWQgX3BpY2tlclJlZjogUmFuZ2VQaWNrZXJSZWY7XG4gIHByb3RlY3RlZCBfZGVzdHJveSQgPSBuZXcgU3ViamVjdCgpO1xuICBwcm90ZWN0ZWQgX3ZhbHVlO1xuICBwcm90ZWN0ZWQgX29yaWdpblZhbHVlOiBEYXRlIHwgbnVsbDsgLy8gYmVmb3JlIHRpbWV6b25lXG4gIHByb3RlY3RlZCBfbmFtZTtcbiAgcHJvdGVjdGVkIF90aW1lem9uZTogc3RyaW5nO1xuXG4gIHByaXZhdGUgX2xhc3RWYWx1ZVZhbGlkID0gZmFsc2U7XG5cbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBfZWxSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJvdGVjdGVkIF9pbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJvdGVjdGVkIF9kYXRlcGlja2VyRmFjdG9yeTogRnNEYXRlUGlja2VyRGlhbG9nRmFjdG9yeSxcbiAgICBwcm90ZWN0ZWQgX3R5cGUsXG4gICAgcHJvdGVjdGVkIF9jZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJvdGVjdGVkIF9uZ0NvbnRyb2w6IE5nQ29udHJvbCxcbiAgKSB7XG4gICAgdGhpcy5fbmdDb250cm9sLnZhbHVlQWNjZXNzb3IgPSB0aGlzO1xuICAgIHRoaXMuX2VsUmVmLm5hdGl2ZUVsZW1lbnQuc2V0QXR0cmlidXRlKCdhdXRvY29tcGxldGUnLCAnb2ZmJyk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG5hbWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX25hbWU7XG4gIH1cblxuICBwdWJsaWMgZ2V0IHRpbWV6b25lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX3RpbWV6b25lO1xuICB9XG5cbiAgcHVibGljIHNldCB2YWx1ZSh2YWx1ZSkge1xuICAgIGlmICh0aGlzLl92YWx1ZSAhPT0gdmFsdWUpIHtcbiAgICAgIHRoaXMuX3ZhbHVlID0gdmFsdWU7XG5cbiAgICAgIHRoaXMub25DaGFuZ2UodmFsdWUpO1xuICAgICAgdGhpcy5vblRvdWNoKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgY29uc3QgY29udHJvbCA9IHRoaXMuX25nQ29udHJvbC5jb250cm9sO1xuICAgIGNvbnN0IHZhbGlkYXRvcnMgPSBjb250cm9sLnZhbGlkYXRvclxuICAgICAgPyBbIGNvbnRyb2wudmFsaWRhdG9yLCB0aGlzLl9wYXJzZVZhbGlkYXRvcl1cbiAgICAgIDogdGhpcy5fcGFyc2VWYWxpZGF0b3I7XG4gICAgY29udHJvbC5zZXRWYWxpZGF0b3JzKHZhbGlkYXRvcnMpO1xuICAgIGNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSgpO1xuICB9XG5cbiAgcHVibGljIGdldCB2YWx1ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5fdmFsdWU7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGRhdGVEaWFsb2dSZWYoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2RhdGVEaWFsb2dSZWY7XG4gIH1cblxuICBwdWJsaWMgd3JpdGVWYWx1ZSh2YWx1ZSkge1xuICAgIHZhbHVlID0gdGhpcy5fcHJvY2Vzc0lucHV0RGF0ZSh2YWx1ZSk7XG5cbiAgICB0aGlzLl9vcmlnaW5WYWx1ZSA9IHZhbHVlO1xuXG4gICAgdGhpcy52YWxpZGF0ZURhdGUodmFsdWUpO1xuXG4gICAgY29uc3QgW3ZhbHVlc0FyZURhdGVzXSA9IHRoaXMuX2NoZWNrVmFsdWVzRXF1YWxpdHkodmFsdWUsIHRoaXMudmFsdWUpO1xuXG4gICAgaWYgKCh2YWx1ZXNBcmVEYXRlcykgfHwgKCF2YWx1ZXNBcmVEYXRlcyAmJiB0aGlzLnZhbHVlICE9PSB2YWx1ZSkpIHtcbiAgICAgIHRoaXMuX3ZhbHVlID0gdmFsdWU7XG4gICAgICB0aGlzLnVwZGF0ZUlucHV0KHRoaXMuX3ZhbHVlKTtcblxuICAgICAgdGhpcy5fY2RSZWYubWFya0ZvckNoZWNrKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHNldERpc2FibGVkU3RhdGUoaXNEaXNhYmxlZDogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuZGlzYWJsZWQgPSBpc0Rpc2FibGVkO1xuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignZm9jdXMnKVxuICBwdWJsaWMgb3BlbigpIHtcbiAgICBpZiAodGhpcy5fZGF0ZURpYWxvZ1JlZiB8fCB0aGlzLmRpc2FibGVkIHx8IHRoaXMucmVhZG9ubHkpIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIC8vdGhpcy5fZGlzYWJsZUlucHV0KCk7XG5cbiAgICB0aGlzLl9kYXRlRGlhbG9nUmVmID0gdGhpcy5fZGF0ZXBpY2tlckZhY3Rvcnkub3BlbkRhdGVQaWNrZXIoXG4gICAgICB0aGlzLl9lbFJlZixcbiAgICAgIHRoaXMuX2luamVjdG9yLFxuICAgICAge1xuICAgICAgICB2aWV3OiB0aGlzLnZpZXcsXG4gICAgICAgIG1pblllYXI6IHRoaXMubWluWWVhcixcbiAgICAgICAgbWF4WWVhcjogdGhpcy5tYXhZZWFyLFxuICAgICAgICBtaW5EYXRlOiB0aGlzLl9nZXRQaWNrZXJTdGFydERhdGUoKSB8fCB0aGlzLm1pbkRhdGUsXG4gICAgICAgIG1heERhdGU6IHRoaXMubWF4RGF0ZSxcbiAgICAgICAgY29tcG9uZW50czogdGhpcy5fZ2V0RGVmYXVsdENvbXBvbmVudHMoKSxcbiAgICAgICAgbW9kZWxWYWx1ZTogdGhpcy52YWx1ZSxcbiAgICAgICAgcGlja2VyUmVmOiB0aGlzLl9waWNrZXJSZWYsXG4gICAgICAgIHJhbmdlVHlwZTogdGhpcy5fdHlwZVxuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLl9lbFJlZi5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XG5cbiAgICB0aGlzLl9saXN0ZW5EaWFsb2dWYWx1ZUNoYW5nZXMoKTtcblxuICAgIHRoaXMuX2RhdGVEaWFsb2dSZWYuY2xvc2UkXG4gICAgICAucGlwZShcbiAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuX2Rlc3Ryb3kkKSxcbiAgICAgIClcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICB0aGlzLl9kYXRlRGlhbG9nUmVmID0gbnVsbDtcbiAgICAgICAgdGhpcy5fZW5hYmxlSW5wdXQoKTtcblxuICAgICAgICB0aGlzLl9jZFJlZi5tYXJrRm9yQ2hlY2soKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB2YWx1ZSB3aGljaCB3YXMgc2VsZWN0ZWQgaW4gZGlhbG9nXG4gICAqIEBwYXJhbSB2YWx1ZVxuICAgKi9cbiAgcHVibGljIHVwZGF0ZVZhbHVlRnJvbURpYWxvZyh2YWx1ZTogRGF0ZSkge1xuICAgIHRoaXMudXBkYXRlVmFsdWUodmFsdWUpO1xuICAgIC8vIHRoaXMud3JpdGVWYWx1ZSh2YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgdXBkYXRlVmFsdWUodmFsdWUpOiB2b2lkIHtcbiAgICBpZiAodGhpcy52aWV3ID09PSBQaWNrZXJWaWV3VHlwZS5UaW1lICYmIGlzVmFsaWQodGhpcy5fdmFsdWUpICYmIGlzVmFsaWQodmFsdWUpKSB7XG4gICAgICB0aGlzLl92YWx1ZS5zZXRIb3Vycyh2YWx1ZS5nZXRIb3VycygpKTtcbiAgICAgIHRoaXMuX3ZhbHVlLnNldE1pbnV0ZXModmFsdWUuZ2V0TWludXRlcygpKTtcbiAgICAgIHRoaXMuX3ZhbHVlLnNldFNlY29uZHModmFsdWUuZ2V0U2Vjb25kcygpKTtcblxuICAgICAgdmFsdWUgPSBuZXcgRGF0ZSh0aGlzLl92YWx1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5fdmFsdWUgPSB2YWx1ZTtcbiAgICB0aGlzLnVwZGF0ZUlucHV0KHRoaXMuX3ZhbHVlKTtcblxuICAgIGlmICh2YWx1ZSAmJiB0aGlzLnRpbWV6b25lKSB7XG4gICAgICB2YWx1ZSA9IHpvbmVkVGltZVRvVXRjKHZhbHVlLCB0aGlzLnRpbWV6b25lKTtcbiAgICB9XG5cbiAgICB0aGlzLm9uQ2hhbmdlKHZhbHVlKTtcbiAgICB0aGlzLm9uVG91Y2godmFsdWUpO1xuICB9XG5cbiAgcHVibGljIHVwZGF0ZUlucHV0KHZhbHVlKSB7XG4gICAgdGhpcy5fZWxSZWYubmF0aXZlRWxlbWVudC52YWx1ZSA9IGZvcm1hdERhdGVUaW1lKHZhbHVlLCB0aGlzLnZpZXcsIHRoaXMuZm9ybWF0LCB0aGlzLnRpbWV6b25lKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2tleXVwJywgWyckZXZlbnQnLCAnJGV2ZW50LnRhcmdldC52YWx1ZSddKVxuICBwdWJsaWMgX2lucHV0S2V5dXAoZXZlbnQ6IEtleWJvYXJkRXZlbnQsIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZihldmVudC5rZXkgPT09ICdFbnRlcicpIHtcbiAgICAgIHRoaXMuaW5wdXRDaGFuZ2UodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2lucHV0JywgWyckZXZlbnQudGFyZ2V0LnZhbHVlJywgJyRldmVudC50YXJnZXQnXSlcbiAgcHVibGljIF9pbnB1dENoYW5nZSh2YWx1ZTogc3RyaW5nLCB0YXJnZXQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5uZ01vZGVsT3B0aW9ucz8udXBkYXRlT24gIT09ICdibHVyJykgIHtcbiAgICAgIHRoaXMuaW5wdXRDaGFuZ2UodmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBpbnB1dENoYW5nZSh2YWx1ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgbGFzdFZhbHVlV2FzVmFsaWQgPSB0aGlzLl9sYXN0VmFsdWVWYWxpZDtcbiAgICBjb25zdCBkYXRlID0gcGFyc2VEYXRlKHZhbHVlKTtcblxuICAgIHRoaXMuX2xhc3RWYWx1ZVZhbGlkID0gIWRhdGUgfHwgaXNWYWxpZChkYXRlKTtcblxuICAgIGlmICghaXNFcXVhbChkYXRlLCB0aGlzLl92YWx1ZSkpIHtcbiAgICAgIHRoaXMudXBkYXRlVmFsdWUoZGF0ZSk7XG4gICAgfSBlbHNlIGlmIChsYXN0VmFsdWVXYXNWYWxpZCAhPT0gdGhpcy5fbGFzdFZhbHVlVmFsaWQpIHtcbiAgICAgIHRoaXMuX25nQ29udHJvbC5jb250cm9sLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTtcbiAgICB9XG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdibHVyJywgWyckZXZlbnQudGFyZ2V0LnZhbHVlJ10pXG4gIHB1YmxpYyBfaW5wdXRCbHVyKHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5uZ01vZGVsT3B0aW9ucz8udXBkYXRlT24gPT09ICdibHVyJykgIHtcbiAgICAgIHRoaXMuaW5wdXRDaGFuZ2UodmFsdWUpO1xuICAgIH1cblxuICAgIHRoaXMudXBkYXRlSW5wdXQodGhpcy52YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgcmVnaXN0ZXJPbkNoYW5nZShmbikgeyB0aGlzLm9uQ2hhbmdlID0gZm47ICB9XG4gIHB1YmxpYyByZWdpc3Rlck9uVG91Y2hlZChmbikgeyB0aGlzLm9uVG91Y2ggPSBmbjsgfVxuXG4gIHB1YmxpYyB0cmlnZ2VyQ2xpY2soKTogdm9pZCB7XG4gICAgdGhpcy5fZWxSZWYubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgIHRoaXMuX2VsUmVmLm5hdGl2ZUVsZW1lbnQuc2VsZWN0KCk7XG5cbiAgICB0aGlzLm9wZW4oKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfcHJvY2Vzc0lucHV0RGF0ZShkYXRlOiBEYXRlIHwgbnVsbCk6IERhdGUgfCBudWxsIHtcbiAgICBpZiAoIWRhdGUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBjcmVhdGVEYXRlRnJvbVZhbHVlKGRhdGUsIHRoaXMudGltZXpvbmUpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9nZXREZWZhdWx0Q29tcG9uZW50cygpIHtcbiAgICBpZiAodGhpcy52aWV3ID09PSAndGltZScpIHtcbiAgICAgIHJldHVybiB7IHRpbWVTdGFydDogdHJ1ZSB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4geyBjYWxlbmRhclN0YXJ0OiB0cnVlLCBjYWxlbmRhckVuZDogdHJ1ZSB9O1xuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBfZW5hYmxlSW5wdXQoKSB7XG4gICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9kaXNhYmxlSW5wdXQoKSB7XG4gICAgdGhpcy5kaXNhYmxlZCA9IHRydWU7XG5cbiAgfVxuXG4gIHByb3RlY3RlZCBfdHpDaGFuZ2VkKG9yaWdpbkRhdGU6IERhdGUgfCBudWxsKSB7XG4gICAgdGhpcy5fdmFsdWUgPSBjcmVhdGVEYXRlRnJvbVZhbHVlKG9yaWdpbkRhdGUsIHRoaXMudGltZXpvbmUpO1xuICAgIHRoaXMudXBkYXRlSW5wdXQodGhpcy5fdmFsdWUpO1xuXG4gICAgdGhpcy5fY2RSZWYubWFya0ZvckNoZWNrKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgX2xpc3RlbkRpYWxvZ1ZhbHVlQ2hhbmdlcygpOiB2b2lkIHtcbiAgICB0aGlzLl9kYXRlRGlhbG9nUmVmLnZhbHVlJFxuICAgICAgLnBpcGUoXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kYXRlRGlhbG9nUmVmLmNsb3NlJCksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9kZXN0cm95JCksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCh2YWx1ZTogRGF0ZSkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlRnJvbURpYWxvZyh2YWx1ZSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHByb3RlY3RlZCBfY2hlY2tWYWx1ZXNFcXVhbGl0eShuZXdWYWx1ZSwgcHJldlZhbHVlKSB7XG4gICAgY29uc3QgdmFsdWVzQXJlRGF0ZXMgPSBpc0RhdGUobmV3VmFsdWUpICYmIGlzRGF0ZShwcmV2VmFsdWUpICYmIGlzVmFsaWQobmV3VmFsdWUpICYmIGlzVmFsaWQocHJldlZhbHVlKTtcbiAgICBjb25zdCB2YWx1ZXNEYXRlc0VxdWFscyA9IHZhbHVlc0FyZURhdGVzXG4gICAgICAmJiBpc1NhbWVEYXRlKG5ld1ZhbHVlLCBwcmV2VmFsdWUpO1xuXG4gICAgcmV0dXJuIFt2YWx1ZXNBcmVEYXRlcywgdmFsdWVzRGF0ZXNFcXVhbHNdO1xuICB9XG5cbiAgLyoqXG4gICAqIFdlIG5lZWQgcGlja2VyIHN0YXJ0IGRhdGUgdG8gYmUgYWJsZSB0byBsaW1pdCBcIkRhdGUgVG9cIiBwaWNrZXJcbiAgICovXG4gIHByb3RlY3RlZCBfZ2V0UGlja2VyU3RhcnREYXRlKCkge1xuICAgIGlmIChcbiAgICAgIHRoaXMudmlldyAhPT0gUGlja2VyVmlld1R5cGUuTW9udGhSYW5nZVxuICAgICAgJiYgaXNEYXRlKHRoaXMuX3BpY2tlclJlZi5zdGFydERhdGUpXG4gICAgICAmJiBpc1ZhbGlkKHRoaXMuX3BpY2tlclJlZi5zdGFydERhdGUpXG4gICAgKSB7XG4gICAgICByZXR1cm4gc3ViRGF5cyh0aGlzLl9waWNrZXJSZWYuc3RhcnREYXRlLCAxKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICAvKiogVGhlIGZvcm0gY29udHJvbCB2YWxpZGF0b3IgZm9yIHdoZXRoZXIgdGhlIGlucHV0IHBhcnNlcy4gKi9cbiAgcHJvdGVjdGVkIF9wYXJzZVZhbGlkYXRvcjogVmFsaWRhdG9yRm4gPSAoKTogVmFsaWRhdGlvbkVycm9ycyB8IG51bGwgPT4ge1xuICAgIHJldHVybiB0aGlzLl9sYXN0VmFsdWVWYWxpZFxuICAgICAgPyBudWxsXG4gICAgICA6IHsgZnNEYXRlcGlja2VyUGFyc2U6ICdJbnZhbGlkIERhdGUnIH07XG4gIH1cblxuICBwcm90ZWN0ZWQgdmFsaWRhdGVEYXRlKGRhdGU6IERhdGUgfCB1bmtub3duKSB7XG4gICAgdGhpcy5fbGFzdFZhbHVlVmFsaWQgPSAhZGF0ZSB8fCBpc1ZhbGlkKGRhdGUpO1xuICB9XG5cbiAgcHJvdGVjdGVkIF9waWNrZXJSZWZVcGRhdGVzJCh0YXJnZXQ6IE9ic2VydmFibGU8RGF0ZSB8IG51bGw+KTogT2JzZXJ2YWJsZTxEYXRlIHwgYW55PiB7XG4gICAgcmV0dXJuIHRhcmdldFxuICAgICAgLnBpcGUoXG4gICAgICAgIHNraXAoMSksXG4gICAgICAgIHBhaXJ3aXNlKCksXG4gICAgICAgIGZpbHRlcigoY2hhbmdlczogW0RhdGUgfCBudWxsLCBEYXRlIHwgbnVsbF0pID0+IHtcbiAgICAgICAgICBjb25zdCBwcmV2VmFsdWUgPSBjaGFuZ2VzWzBdPy5nZXRUaW1lKCk7XG4gICAgICAgICAgY29uc3QgbmV3VmFsdWUgPSBjaGFuZ2VzWzFdPy5nZXRUaW1lKCk7XG5cbiAgICAgICAgICByZXR1cm4gcHJldlZhbHVlICE9PSBuZXdWYWx1ZVxuICAgICAgICAgICAgJiYgdGhpcy52YWx1ZT8uZ2V0VGltZSgpICE9PSBuZXdWYWx1ZTtcbiAgICAgICAgfSksXG4gICAgICAgIG1hcCgoY2hhbmdlcykgPT4gY2hhbmdlc1sxXSksXG4gICAgICApO1xuICB9XG5cbn1cbiJdfQ==