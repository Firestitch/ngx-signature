import { ChangeDetectionStrategy, ChangeDetectorRef, Component, ElementRef, EventEmitter, forwardRef, Inject, Injector, Input, Output, Renderer2, } from '@angular/core';
import { NG_VALIDATORS, NG_VALUE_ACCESSOR } from '@angular/forms';
import { isValid } from 'date-fns';
import { PickerViewType } from '../../../libs/common/enums/picker-view-type.enum';
import { FsDatePickerDialogFactory } from '../../../libs/dialog/services/dialog-factory.service';
import { FsDatePickerBaseComponent } from '../../classes/base-component';
import { createDateFromValue } from '../../helpers/create-date-from-value';
import { formatDateTime } from '../../helpers/format-date-time';
import * as i0 from "@angular/core";
import * as i1 from "../../../libs/dialog/services/dialog-factory.service";
import * as i2 from "@firestitch/clear";
import * as i3 from "../date-picker-trigger/date-picker-trigger.component";
export class FsDatePickerComponent extends FsDatePickerBaseComponent {
    constructor(elementRef, renderer, injector, _cdRef, fsDatepickerFactory) {
        super(renderer, elementRef, _cdRef);
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.injector = injector;
        this._cdRef = _cdRef;
        this.fsDatepickerFactory = fsDatepickerFactory;
        this.minYear = null;
        this.maxYear = null;
        this.minDate = null;
        this.maxDate = null;
        this.startOfDay = true;
        this.view = PickerViewType.Date;
        this.minutes = true;
        this.change$ = new EventEmitter();
    }
    writeValue(value) {
        this._originValue = value;
        this._value = createDateFromValue(value, this.timezone);
        this.validateDate(this.value);
        this.updateInput(this.value);
        this._cdRef.markForCheck();
    }
    updateInput(value) {
        if (!this.minutes && value) {
            value.setMinutes(0);
        }
        this.elementRef.nativeElement.value = formatDateTime(value, this.view, this.format, this.timezone);
    }
    open() {
        if (this.disabled || this.readonly || this._dateDialogRef) {
            return;
        }
        const modelValue = isValid(this.value) ? this.value : null;
        this._dateDialogRef = this.fsDatepickerFactory.openDatePicker(this.elementRef, this.injector, {
            modelValue: modelValue,
            view: this.view,
            minutes: this.minutes,
            minYear: this.minYear,
            maxYear: this.maxYear,
            minDate: this.minDate,
            maxDate: this.maxDate,
            startOfDay: this.startOfDay,
            components: this._getDefaultComponents(),
        });
        super.open();
    }
    updateValue(value) {
        if (this.view === PickerViewType.Time && isValid(this._value) && isValid(value)) {
            this._value.setHours(value.getHours());
            this._value.setMinutes(value.getMinutes());
            this._value.setSeconds(value.getSeconds());
            value = new Date(this._value);
        }
        super.updateValue(value);
    }
    _getDefaultComponents() {
        if (this.view === 'time') {
            return { timeStart: true };
        }
        else {
            return { calendarStart: true };
        }
    }
}
FsDatePickerComponent.template = `
    <fs-clear [show]="value && !disabled && !readonly && clear" (clear)="cleared($event)"></fs-clear>
    <fs-datepicker-trigger (click)="triggerClick()" [disabled]="disabled || readonly" [view]="view"></fs-datepicker-trigger>
  `;
FsDatePickerComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerComponent, deps: [{ token: ElementRef }, { token: i0.Renderer2 }, { token: i0.Injector }, { token: i0.ChangeDetectorRef }, { token: i1.FsDatePickerDialogFactory }], target: i0.ɵɵFactoryTarget.Component });
FsDatePickerComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: FsDatePickerComponent, selector: "[fsDatePicker]", inputs: { minYear: "minYear", maxYear: "maxYear", minDate: "minDate", maxDate: "maxDate", startOfDay: "startOfDay", view: "view", format: "format", minutes: "minutes" }, outputs: { change$: "change" }, providers: [
        {
            provide: NG_VALUE_ACCESSOR,
            useExisting: forwardRef(() => FsDatePickerComponent),
            multi: true,
        },
        {
            provide: NG_VALIDATORS,
            useExisting: forwardRef(() => FsDatePickerComponent),
            multi: true,
        }
    ], usesInheritance: true, ngImport: i0, template: "\n    <fs-clear [show]=\"value && !disabled && !readonly && clear\" (clear)=\"cleared($event)\"></fs-clear>\n    <fs-datepicker-trigger (click)=\"triggerClick()\" [disabled]=\"disabled || readonly\" [view]=\"view\"></fs-datepicker-trigger>\n  ", isInline: true, components: [{ type: i2.FsClearElementComponent, selector: "fs-clear", inputs: ["show"], outputs: ["clear"] }, { type: i3.FsDatePickerTriggerComponent, selector: "fs-datepicker-trigger", inputs: ["disabled", "view"], outputs: ["click"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerComponent, decorators: [{
            type: Component,
            args: [{
                    selector: '[fsDatePicker]',
                    template: FsDatePickerComponent.template,
                    providers: [
                        {
                            provide: NG_VALUE_ACCESSOR,
                            useExisting: forwardRef(() => FsDatePickerComponent),
                            multi: true,
                        },
                        {
                            provide: NG_VALIDATORS,
                            useExisting: forwardRef(() => FsDatePickerComponent),
                            multi: true,
                        }
                    ],
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef, decorators: [{
                    type: Inject,
                    args: [ElementRef]
                }] }, { type: i0.Renderer2 }, { type: i0.Injector }, { type: i0.ChangeDetectorRef }, { type: i1.FsDatePickerDialogFactory }]; }, propDecorators: { minYear: [{
                type: Input
            }], maxYear: [{
                type: Input
            }], minDate: [{
                type: Input
            }], maxDate: [{
                type: Input
            }], startOfDay: [{
                type: Input
            }], view: [{
                type: Input
            }], format: [{
                type: Input
            }], minutes: [{
                type: Input
            }], change$: [{
                type: Output,
                args: ['change']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1waWNrZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2FwcC9jb21wb25lbnRzL2RhdGUtcGlja2VyL2RhdGUtcGlja2VyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixVQUFVLEVBQ1YsTUFBTSxFQUNOLFFBQVEsRUFDUixLQUFLLEVBQ0wsTUFBTSxFQUNOLFNBQVMsR0FDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsYUFBYSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFbEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVuQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFDbEYsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sc0RBQXNELENBQUM7QUFDakcsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDekUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFDM0UsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGdDQUFnQyxDQUFDOzs7OztBQW9CaEUsTUFBTSxPQUFPLHFCQUFzQixTQUFRLHlCQUF5QjtJQW1CbEUsWUFDZ0MsVUFBc0IsRUFDMUMsUUFBbUIsRUFDbkIsUUFBa0IsRUFDbEIsTUFBeUIsRUFDekIsbUJBQThDO1FBRXhELEtBQUssQ0FBQyxRQUFRLEVBQUUsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBTk4sZUFBVSxHQUFWLFVBQVUsQ0FBWTtRQUMxQyxhQUFRLEdBQVIsUUFBUSxDQUFXO1FBQ25CLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsV0FBTSxHQUFOLE1BQU0sQ0FBbUI7UUFD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QUFDLFVBQVU7bUtBYkosT0FBTztzQkFBdEIsS0FBSztnQkFDVSxPQUFPO3NCQUF0QixLQUFLO2dCQUNVLE9BQU87c0JBQXRCLEtBQUs7Z0JBQ1UsT0FBTztzQkFBdEIsS0FBSztnQkFDVSxVQUFVO3NCQUF6QixLQUFLO2dCQUNVLElBQUk7c0JBQW5CLEtBQUs7Z0JBQ1UsTUFBTTtzQkFBckIsS0FBSztnQkFDVSxPQUFPO3NCQUF0QixLQUFLO2dCQUdDLE9BQU87c0JBRGIsTUFBTTt1QkFBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENoYW5nZURldGVjdG9yUmVmLFxuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIEV2ZW50RW1pdHRlcixcbiAgZm9yd2FyZFJlZixcbiAgSW5qZWN0LFxuICBJbmplY3RvcixcbiAgSW5wdXQsXG4gIE91dHB1dCxcbiAgUmVuZGVyZXIyLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5HX1ZBTElEQVRPUlMsIE5HX1ZBTFVFX0FDQ0VTU09SIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5pbXBvcnQgeyBpc1ZhbGlkIH0gZnJvbSAnZGF0ZS1mbnMnO1xuXG5pbXBvcnQgeyBQaWNrZXJWaWV3VHlwZSB9IGZyb20gJy4uLy4uLy4uL2xpYnMvY29tbW9uL2VudW1zL3BpY2tlci12aWV3LXR5cGUuZW51bSc7XG5pbXBvcnQgeyBGc0RhdGVQaWNrZXJEaWFsb2dGYWN0b3J5IH0gZnJvbSAnLi4vLi4vLi4vbGlicy9kaWFsb2cvc2VydmljZXMvZGlhbG9nLWZhY3Rvcnkuc2VydmljZSc7XG5pbXBvcnQgeyBGc0RhdGVQaWNrZXJCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vY2xhc3Nlcy9iYXNlLWNvbXBvbmVudCc7XG5pbXBvcnQgeyBjcmVhdGVEYXRlRnJvbVZhbHVlIH0gZnJvbSAnLi4vLi4vaGVscGVycy9jcmVhdGUtZGF0ZS1mcm9tLXZhbHVlJztcbmltcG9ydCB7IGZvcm1hdERhdGVUaW1lIH0gZnJvbSAnLi4vLi4vaGVscGVycy9mb3JtYXQtZGF0ZS10aW1lJztcblxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdbZnNEYXRlUGlja2VyXScsXG4gIHRlbXBsYXRlOiBGc0RhdGVQaWNrZXJDb21wb25lbnQudGVtcGxhdGUsXG4gIHByb3ZpZGVyczogW1xuICAgIHtcbiAgICAgIHByb3ZpZGU6IE5HX1ZBTFVFX0FDQ0VTU09SLFxuICAgICAgdXNlRXhpc3Rpbmc6IGZvcndhcmRSZWYoKCkgPT4gRnNEYXRlUGlja2VyQ29tcG9uZW50KSxcbiAgICAgIG11bHRpOiB0cnVlLFxuICAgIH0sXG4gICAge1xuICAgICAgcHJvdmlkZTogTkdfVkFMSURBVE9SUyxcbiAgICAgIHVzZUV4aXN0aW5nOiBmb3J3YXJkUmVmKCgpID0+IEZzRGF0ZVBpY2tlckNvbXBvbmVudCksXG4gICAgICBtdWx0aTogdHJ1ZSxcbiAgICB9XG4gIF0sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBGc0RhdGVQaWNrZXJDb21wb25lbnQgZXh0ZW5kcyBGc0RhdGVQaWNrZXJCYXNlQ29tcG9uZW50IHtcblxuICBzdGF0aWMgdGVtcGxhdGUgPSBgXG4gICAgPGZzLWNsZWFyIFtzaG93XT1cInZhbHVlICYmICFkaXNhYmxlZCAmJiAhcmVhZG9ubHkgJiYgY2xlYXJcIiAoY2xlYXIpPVwiY2xlYXJlZCgkZXZlbnQpXCI+PC9mcy1jbGVhcj5cbiAgICA8ZnMtZGF0ZXBpY2tlci10cmlnZ2VyIChjbGljayk9XCJ0cmlnZ2VyQ2xpY2soKVwiIFtkaXNhYmxlZF09XCJkaXNhYmxlZCB8fCByZWFkb25seVwiIFt2aWV3XT1cInZpZXdcIj48L2ZzLWRhdGVwaWNrZXItdHJpZ2dlcj5cbiAgYDtcblxuICBASW5wdXQoKSBwdWJsaWMgbWluWWVhciA9IG51bGw7XG4gIEBJbnB1dCgpIHB1YmxpYyBtYXhZZWFyID0gbnVsbDtcbiAgQElucHV0KCkgcHVibGljIG1pbkRhdGUgPSBudWxsO1xuICBASW5wdXQoKSBwdWJsaWMgbWF4RGF0ZSA9IG51bGw7XG4gIEBJbnB1dCgpIHB1YmxpYyBzdGFydE9mRGF5ID0gdHJ1ZTtcbiAgQElucHV0KCkgcHVibGljIHZpZXcgPSBQaWNrZXJWaWV3VHlwZS5EYXRlO1xuICBASW5wdXQoKSBwdWJsaWMgZm9ybWF0OiBzdHJpbmc7XG4gIEBJbnB1dCgpIHB1YmxpYyBtaW51dGVzID0gdHJ1ZTtcblxuICBAT3V0cHV0KCdjaGFuZ2UnKVxuICBwdWJsaWMgY2hhbmdlJCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIEBJbmplY3QoRWxlbWVudFJlZikgcHJvdGVjdGVkIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJvdGVjdGVkIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBwcm90ZWN0ZWQgX2NkUmVmOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcm90ZWN0ZWQgZnNEYXRlcGlja2VyRmFjdG9yeTogRnNEYXRlUGlja2VyRGlhbG9nRmFjdG9yeSxcbiAgKSB7XG4gICAgc3VwZXIocmVuZGVyZXIsIGVsZW1lbnRSZWYsIF9jZFJlZik7XG4gIH1cblxuICBwdWJsaWMgd3JpdGVWYWx1ZSh2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgdGhpcy5fb3JpZ2luVmFsdWUgPSB2YWx1ZTtcbiAgICB0aGlzLl92YWx1ZSA9IGNyZWF0ZURhdGVGcm9tVmFsdWUodmFsdWUsIHRoaXMudGltZXpvbmUpO1xuICAgIHRoaXMudmFsaWRhdGVEYXRlKHRoaXMudmFsdWUpO1xuICAgIHRoaXMudXBkYXRlSW5wdXQodGhpcy52YWx1ZSk7XG5cbiAgICB0aGlzLl9jZFJlZi5tYXJrRm9yQ2hlY2soKTtcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVJbnB1dCh2YWx1ZSkge1xuICAgIGlmICghdGhpcy5taW51dGVzICYmIHZhbHVlKSB7XG4gICAgICB2YWx1ZS5zZXRNaW51dGVzKDApO1xuICAgIH1cblxuICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LnZhbHVlID0gZm9ybWF0RGF0ZVRpbWUodmFsdWUsIHRoaXMudmlldywgdGhpcy5mb3JtYXQsIHRoaXMudGltZXpvbmUpO1xuICB9XG5cbiAgcHVibGljIG9wZW4oKSB7XG4gICAgaWYgKHRoaXMuZGlzYWJsZWQgfHwgdGhpcy5yZWFkb25seSB8fCB0aGlzLl9kYXRlRGlhbG9nUmVmKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbW9kZWxWYWx1ZSA9IGlzVmFsaWQodGhpcy52YWx1ZSkgPyB0aGlzLnZhbHVlIDogbnVsbDtcblxuICAgIHRoaXMuX2RhdGVEaWFsb2dSZWYgPSB0aGlzLmZzRGF0ZXBpY2tlckZhY3Rvcnkub3BlbkRhdGVQaWNrZXIoXG4gICAgdGhpcy5lbGVtZW50UmVmLFxuICAgIHRoaXMuaW5qZWN0b3IsXG4gICAge1xuICAgICAgbW9kZWxWYWx1ZTogbW9kZWxWYWx1ZSxcbiAgICAgIHZpZXc6IHRoaXMudmlldyxcbiAgICAgIG1pbnV0ZXM6IHRoaXMubWludXRlcyxcbiAgICAgIG1pblllYXI6IHRoaXMubWluWWVhcixcbiAgICAgIG1heFllYXI6IHRoaXMubWF4WWVhcixcbiAgICAgIG1pbkRhdGU6IHRoaXMubWluRGF0ZSxcbiAgICAgIG1heERhdGU6IHRoaXMubWF4RGF0ZSxcbiAgICAgIHN0YXJ0T2ZEYXk6IHRoaXMuc3RhcnRPZkRheSxcbiAgICAgIGNvbXBvbmVudHM6IHRoaXMuX2dldERlZmF1bHRDb21wb25lbnRzKCksXG4gICAgfSk7XG5cbiAgICBzdXBlci5vcGVuKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdXBkYXRlVmFsdWUodmFsdWUpIHtcbiAgICBpZiAodGhpcy52aWV3ID09PSBQaWNrZXJWaWV3VHlwZS5UaW1lICYmIGlzVmFsaWQodGhpcy5fdmFsdWUpICYmIGlzVmFsaWQodmFsdWUpKSB7XG4gICAgICB0aGlzLl92YWx1ZS5zZXRIb3Vycyh2YWx1ZS5nZXRIb3VycygpKTtcbiAgICAgIHRoaXMuX3ZhbHVlLnNldE1pbnV0ZXModmFsdWUuZ2V0TWludXRlcygpKTtcbiAgICAgIHRoaXMuX3ZhbHVlLnNldFNlY29uZHModmFsdWUuZ2V0U2Vjb25kcygpKTtcblxuICAgICAgdmFsdWUgPSBuZXcgRGF0ZSh0aGlzLl92YWx1ZSk7XG4gICAgfVxuXG4gICAgc3VwZXIudXBkYXRlVmFsdWUodmFsdWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBfZ2V0RGVmYXVsdENvbXBvbmVudHMoKSB7XG4gICAgaWYgKHRoaXMudmlldyA9PT0gJ3RpbWUnKSB7XG4gICAgICByZXR1cm4geyB0aW1lU3RhcnQ6IHRydWUgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHsgY2FsZW5kYXJTdGFydDogdHJ1ZSB9O1xuICAgIH1cbiAgfVxufVxuIl19