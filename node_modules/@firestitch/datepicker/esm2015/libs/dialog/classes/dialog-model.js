import { isDate, isValid, addMonths, subMonths, setMonth, setYear, startOfDay, isBefore, } from 'date-fns';
import { BehaviorSubject } from 'rxjs';
import { PickerViewType } from '../../common/enums/picker-view-type.enum';
import { getDisabledDays } from '../../dialog/helpers/get-disabled-days';
import { getDisabledTimes } from '../../dialog/helpers/get-disabled-times';
export class FsDatePickerDialogModel {
    constructor(pickerOptions) {
        /**
         * year | month | date
         *
         * Current mode of calendar. For ranges consist values for both: start and end date
         */
        this.dateMode = null;
        this.minDate = null;
        this.maxDate = null;
        this.startOfDay = true;
        this.seedDate = null;
        this.periodWeeks = null;
        this.minutes = true;
        this._minYear = null;
        this._maxYear = null;
        this._model$ = new BehaviorSubject(null);
        this._period$ = new BehaviorSubject(null);
        this._now$ = new BehaviorSubject(new Date());
        this._disabledDays$ = new BehaviorSubject([]);
        this._disabledTimes$ = new BehaviorSubject([]);
        this._calendarDate$ = new BehaviorSubject(this.now);
        this._calendarMode$ = new BehaviorSubject('date');
        this._timeExpanded$ = new BehaviorSubject(false);
        /**
         * date | datetime | time | week
         * View is options selected on init. Can't be changed manually
         */
        this._view$ = new BehaviorSubject('date');
        this._initCalendar(pickerOptions);
        this._updateDisabled();
    }
    get now() {
        return this._now$.value;
    }
    set calendarDate(value) {
        this._calendarDate$.next(value);
    }
    get calendarDate() {
        return this._calendarDate$.value;
    }
    get calendarDate$() {
        return this._calendarDate$;
    }
    get view$() {
        return this._view$.asObservable();
    }
    get view() {
        return this._view$.value;
    }
    set view(view) {
        this._view$.next(view);
    }
    get isDateView() {
        return this.view === PickerViewType.Date;
    }
    get isDateTimeView() {
        return this.view === PickerViewType.DateTime;
    }
    get isTimeView() {
        return this.view === PickerViewType.Time;
    }
    get isWeekView() {
        return this.view === PickerViewType.Week;
    }
    get isMonthRangeView() {
        return this.view === PickerViewType.MonthRange;
    }
    get calendarMode$() {
        return this._calendarMode$;
    }
    get calendarMode() {
        return this._calendarMode$.value;
    }
    set model(value) {
        if (isValid(value)) {
            if (this.isDateView && this.startOfDay) {
                value = startOfDay(value);
            }
            /**
             * For cases when we have datetime view type and have opened "To" date picker.
             * If "From" date is already selected it means that we have some Time range to be disabled.
             * When user select "To" date without time (only clicks on date) we have to pull up time for selected date.
             */
            if (this.isDateTimeView
                && this._pickerOptions.rangeType === 'to'
                && !this.model
                && value) {
                if (isBefore(value, this.rangePickerRef.startDate)) {
                    value = new Date(this.rangePickerRef.startDate);
                }
            }
        }
        else {
            value = null;
        }
        this._model$.next(value);
        this._updateDisabledTimes();
    }
    get model() {
        return this._model$.value;
    }
    get model$() {
        return this._model$;
    }
    set period(value) {
        this._period$.next(value);
    }
    get period() {
        return this._period$.value;
    }
    get period$() {
        return this._period$;
    }
    set disabledDays(value) {
        this._disabledDays$.next(value);
    }
    get disabledDays$() {
        return this._disabledDays$;
    }
    set disabledTimes(value) {
        this._disabledTimes$.next(value);
    }
    get disabledTimes$() {
        return this._disabledTimes$;
    }
    set minYear(minYear) {
        this._minYear = minYear || (new Date().getFullYear() - 100);
    }
    get minYear() {
        return this._minYear;
    }
    set maxYear(maxYear) {
        this._maxYear = maxYear || (new Date().getFullYear() + 100);
    }
    get maxYear() {
        return this._maxYear;
    }
    set _calendarMode(value) {
        this._calendarMode$.next(value);
    }
    get timeExpanded$() {
        return this._timeExpanded$.asObservable();
    }
    get timeExpanded() {
        return this._timeExpanded$.value;
    }
    set timeExpanded(flag) {
        this._timeExpanded$.next(flag);
    }
    get rangePickerRef() {
        return this._pickerOptions.pickerRef;
    }
    setCalendarMonth(month) {
        this.calendarDate = setMonth(this.calendarDate, month);
    }
    setCalendarYear(year) {
        this.calendarDate = setYear(this.calendarDate, year);
        this._updateDisabled();
    }
    nextMonth() {
        this.calendarDate = addMonths(this.calendarDate, 1);
    }
    prevMonth() {
        this.calendarDate = subMonths(this.calendarDate, 1);
    }
    setCalendarMode(mode) {
        this._calendarMode = mode;
    }
    _initCalendar(options) {
        var _a;
        this._pickerOptions = Object.assign({}, options);
        this.view = options.view;
        switch (this.view) {
            case PickerViewType.Week:
                {
                    this.period = options.modelValue;
                    this.calendarDate = ((_a = options.modelValue) === null || _a === void 0 ? void 0 : _a.from) || new Date();
                }
                break;
            case PickerViewType.MonthRange:
                {
                    this.calendarDate = options.modelValue || new Date();
                }
                break;
            default: {
                this.model = options.modelValue;
                this.calendarDate = options.modelValue || new Date();
            }
        }
        this._calendarMode = options.view;
        this.minYear = options.minYear;
        this.maxYear = options.maxYear;
        this.minDate = options.minDate;
        this.maxDate = options.maxDate;
        this.startOfDay = options.startOfDay;
        this.minutes = options.minutes === undefined
            ? true
            : options.minutes;
        if (!isDate(options.seedDate) || !isValid(options.seedDate)) {
            this.seedDate = new Date((new Date().getFullYear()), 0, 1);
        }
        else {
            this.seedDate = options.seedDate;
        }
        this.periodWeeks = options.periodWeeks;
        this._updateDisabledDays();
    }
    _updateDisabled() {
        this._updateDisabledDays();
        this._updateDisabledTimes();
    }
    _updateDisabledDays() {
        if (this._pickerOptions.rangeType) {
            if (this._pickerOptions.rangeType === 'to') {
                this.disabledDays = getDisabledDays(this.minDate, this.maxDate, this.minYear, this.maxYear);
            }
        }
        else {
            this.disabledDays = getDisabledDays(this.minDate, this.maxDate, this.minYear, this.maxYear);
        }
    }
    _updateDisabledTimes() {
        const pickerView = this.view;
        if (pickerView !== PickerViewType.DateTime && pickerView !== PickerViewType.Time) {
            return;
        }
        if (this._pickerOptions.rangeType) {
            if (this._pickerOptions.rangeType === 'to') {
                this.disabledTimes = getDisabledTimes(this.model, this._pickerOptions.pickerRef);
            }
        }
        else {
            this.disabledTimes = getDisabledTimes(this.model, this._pickerOptions.pickerRef);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLW1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYnMvZGlhbG9nL2NsYXNzZXMvZGlhbG9nLW1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxNQUFNLEVBQ04sT0FBTyxFQUNQLFNBQVMsRUFDVCxTQUFTLEVBQ1QsUUFBUSxFQUNSLE9BQU8sRUFDUCxVQUFVLEVBQ1YsUUFBUSxHQUNULE1BQU0sVUFBVSxDQUFDO0FBRWxCLE9BQU8sRUFBRSxlQUFlLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFHbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBQzFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUN6RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQU0zRSxNQUFNLE9BQU8sdUJBQXVCO0lBcUNsQyxZQUNFLGFBQW9DO1FBcEN0Qzs7OztXQUlHO1FBQ0ksYUFBUSxHQUFHLElBQUksQ0FBQztRQUNoQixZQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ2YsWUFBTyxHQUFHLElBQUksQ0FBQztRQUNmLGVBQVUsR0FBRyxJQUFJLENBQUM7UUFDbEIsYUFBUSxHQUFHLElBQUksQ0FBQztRQUNoQixnQkFBVyxHQUFHLElBQUksQ0FBQztRQUNuQixZQUFPLEdBQUcsSUFBSSxDQUFDO1FBRWQsYUFBUSxHQUFHLElBQUksQ0FBQztRQUNoQixhQUFRLEdBQUcsSUFBSSxDQUFDO1FBSWhCLFlBQU8sR0FBRyxJQUFJLGVBQWUsQ0FBYyxJQUFJLENBQUMsQ0FBQztRQUNqRCxhQUFRLEdBQUcsSUFBSSxlQUFlLENBQWlCLElBQUksQ0FBQyxDQUFDO1FBRXJELFVBQUssR0FBRyxJQUFJLGVBQWUsQ0FBTyxJQUFJLElBQUksRUFBRSxDQUFDLENBQUM7UUFFOUMsbUJBQWMsR0FBRyxJQUFJLGVBQWUsQ0FBaUIsRUFB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QUksQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUM3RjtTQUNGO2FBQU07WUFDTCxJQUFJLENBQUMsWUFBWSxHQUFHLGVBQWUsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDN0Y7SUFDSCxDQUFDO0lBRU8sb0JBQW9CO1FBQzFCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7UUFFN0IsSUFBSSxVQUFVLEtBQUssY0FBYyxDQUFDLFFBQVEsSUFBSSxVQUFVLEtBQUssY0FBYyxDQUFDLElBQUksRUFBRTtZQUNoRixPQUFPO1NBQ1I7UUFFRCxJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFO1lBQ2pDLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLEtBQUssSUFBSSxFQUFFO2dCQUMxQyxJQUFJLENBQUMsYUFBYSxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNsRjtTQUNGO2FBQU07WUFDTCxJQUFJLENBQUMsYUFBYSxHQUFHLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNsRjtJQUNILENBQUM7Q0FFRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIGlzRGF0ZSxcbiAgaXNWYWxpZCxcbiAgYWRkTW9udGhzLFxuICBzdWJNb250aHMsXG4gIHNldE1vbnRoLFxuICBzZXRZZWFyLFxuICBzdGFydE9mRGF5LFxuICBpc0JlZm9yZSxcbn0gZnJvbSAnZGF0ZS1mbnMnO1xuXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgSURpYWxvZ0ZhY3RvcnlPcHRpb25zIH0gZnJvbSAnLi4vLi4vZGlhbG9nL2ludGVyZmFjZXMvZGlhbG9nLWZhY3RvcnktZGF0YS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUGlja2VyVmlld1R5cGUgfSBmcm9tICcuLi8uLi9jb21tb24vZW51bXMvcGlja2VyLXZpZXctdHlwZS5lbnVtJztcbmltcG9ydCB7IGdldERpc2FibGVkRGF5cyB9IGZyb20gJy4uLy4uL2RpYWxvZy9oZWxwZXJzL2dldC1kaXNhYmxlZC1kYXlzJztcbmltcG9ydCB7IGdldERpc2FibGVkVGltZXMgfSBmcm9tICcuLi8uLi9kaWFsb2cvaGVscGVycy9nZXQtZGlzYWJsZWQtdGltZXMnO1xuaW1wb3J0IHsgSVBlcmlvZCB9IGZyb20gJy4uLy4uL2NvbW1vbi9pbnRlcmZhY2VzL3BlcmlvZC5pbnRlcmZhY2UnO1xuXG5pbXBvcnQgeyBSYW5nZVBpY2tlclJlZiB9IGZyb20gJy4uLy4uLy4uL2FwcC9jbGFzc2VzL3JhbmdlLXBpY2tlci1yZWYnO1xuXG5cbmV4cG9ydCBjbGFzcyBGc0RhdGVQaWNrZXJEaWFsb2dNb2RlbCB7XG5cbiAgLyoqXG4gICAqIHllYXIgfCBtb250aCB8IGRhdGVcbiAgICpcbiAgICogQ3VycmVudCBtb2RlIG9mIGNhbGVuZGFyLiBGb3IgcmFuZ2VzIGNvbnNpc3QgdmFsdWVzIGZvciBib3RoOiBzdGFydCBhbmQgZW5kIGRhdGVcbiAgICovXG4gIHB1YmxpYyBkYXRlTW9kZSA9IG51bGw7XG4gIHB1YmxpYyBtaW5EYXRlID0gbnVsbDtcbiAgcHVibGljIG1heERhdGUgPSBudWxsO1xuICBwdWJsaWMgc3RhcnRPZkRheSA9IHRydWU7XG4gIHB1YmxpYyBzZWVkRGF0ZSA9IG51bGw7XG4gIHB1YmxpYyBwZXJpb2RXZWVrcyA9IG51bGw7XG4gIHB1YmxpYyBtaW51dGVzID0gdHJ1ZTtcblxuICBwcml2YXRlIF9taW5ZZWFyID0gbnVsbDtcbiAgcHJpdmF0ZSBfbWF4WWVhciA9IG51bGw7XG5cbiAgcHJpdmF0ZSBfcGlja2VyT3B0aW9uczogSURpYWxvZ0ZhY3RvcnlPcHRpb25zO1xuXG4gIHByaXZhdGUgX21vZGVsJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RGF0ZSB8IG51bGw+KG51bGwpO1xuICBwcml2YXRlIF9wZXJpb2QkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxJUGVyaW9kIHwgbnVsbD4obnVsbCk7XG5cbiAgcHJpdmF0ZSBfbm93JCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8RGF0ZT4obmV3IERhdGUoKSk7XG5cbiAgcHJpdmF0ZSBfZGlzYWJsZWREYXlzJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8W0RhdGUsIERhdGVdW10+KFtdKTtcbiAgcHJpdmF0ZSBfZGlzYWJsZWRUaW1lcyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PFtEYXRlLCBEYXRlXVtdPihbXSk7XG4gIHByaXZhdGUgX2NhbGVuZGFyRGF0ZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PERhdGU+KHRoaXMubm93KTtcbiAgcHJpdmF0ZSBfY2FsZW5kYXJNb2RlJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPignZGF0ZScpO1xuICBwcml2YXRlIF90aW1lRXhwYW5kZWQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPihmYWxzZSk7XG5cbiAgLyoqXG4gICAqIGRhdGUgfCBkYXRldGltZSB8IHRpbWUgfCB3ZWVrXG4gICAqIFZpZXcgaXMgb3B0aW9ucyBzZWxlY3RlZCBvbiBpbml0LiBDYW4ndCBiZSBjaGFuZ2VkIG1hbnVhbGx5XG4gICAqL1xuICBwcml2YXRlIF92aWV3JCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8c3RyaW5nPignZGF0ZScpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHBpY2tlck9wdGlvbnM6IElEaWFsb2dGYWN0b3J5T3B0aW9ucyxcbiAgKSB7XG4gICAgdGhpcy5faW5pdENhbGVuZGFyKHBpY2tlck9wdGlvbnMpO1xuICAgIHRoaXMuX3VwZGF0ZURpc2FibGVkKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG5vdygpOiBEYXRlIHtcbiAgICByZXR1cm4gdGhpcy5fbm93JC52YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgY2FsZW5kYXJEYXRlKHZhbHVlOiBEYXRlKSB7XG4gICAgdGhpcy5fY2FsZW5kYXJEYXRlJC5uZXh0KHZhbHVlKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY2FsZW5kYXJEYXRlKCk6IERhdGUge1xuICAgIHJldHVybiB0aGlzLl9jYWxlbmRhckRhdGUkLnZhbHVlO1xuICB9XG5cbiAgcHVibGljIGdldCBjYWxlbmRhckRhdGUkKCk6IE9ic2VydmFibGU8RGF0ZT4ge1xuICAgIHJldHVybiB0aGlzLl9jYWxlbmRhckRhdGUkO1xuICB9XG5cbiAgcHVibGljIGdldCB2aWV3JCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLl92aWV3JC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgdmlldygpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl92aWV3JC52YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgdmlldyh2aWV3KSB7XG4gICAgdGhpcy5fdmlldyQubmV4dCh2aWV3KTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgaXNEYXRlVmlldygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy52aWV3ID09PSBQaWNrZXJWaWV3VHlwZS5EYXRlO1xuICB9XG5cbiAgcHVibGljIGdldCBpc0RhdGVUaW1lVmlldygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy52aWV3ID09PSBQaWNrZXJWaWV3VHlwZS5EYXRlVGltZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgaXNUaW1lVmlldygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy52aWV3ID09PSBQaWNrZXJWaWV3VHlwZS5UaW1lO1xuICB9XG5cbiAgcHVibGljIGdldCBpc1dlZWtWaWV3KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnZpZXcgPT09IFBpY2tlclZpZXdUeXBlLldlZWs7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGlzTW9udGhSYW5nZVZpZXcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMudmlldyA9PT0gUGlja2VyVmlld1R5cGUuTW9udGhSYW5nZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgY2FsZW5kYXJNb2RlJCgpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLl9jYWxlbmRhck1vZGUkO1xuICB9XG5cbiAgcHVibGljIGdldCBjYWxlbmRhck1vZGUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5fY2FsZW5kYXJNb2RlJC52YWx1ZTtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgbW9kZWwodmFsdWU6IERhdGUgfCBudWxsKSB7XG4gICAgaWYgKGlzVmFsaWQodmFsdWUpKSB7XG4gICAgICBpZiAodGhpcy5pc0RhdGVWaWV3ICYmIHRoaXMuc3RhcnRPZkRheSkge1xuICAgICAgICB2YWx1ZSA9IHN0YXJ0T2ZEYXkodmFsdWUpO1xuICAgICAgfVxuXG4gICAgICAvKipcbiAgICAgICAqIEZvciBjYXNlcyB3aGVuIHdlIGhhdmUgZGF0ZXRpbWUgdmlldyB0eXBlIGFuZCBoYXZlIG9wZW5lZCBcIlRvXCIgZGF0ZSBwaWNrZXIuXG4gICAgICAgKiBJZiBcIkZyb21cIiBkYXRlIGlzIGFscmVhZHkgc2VsZWN0ZWQgaXQgbWVhbnMgdGhhdCB3ZSBoYXZlIHNvbWUgVGltZSByYW5nZSB0byBiZSBkaXNhYmxlZC5cbiAgICAgICAqIFdoZW4gdXNlciBzZWxlY3QgXCJUb1wiIGRhdGUgd2l0aG91dCB0aW1lIChvbmx5IGNsaWNrcyBvbiBkYXRlKSB3ZSBoYXZlIHRvIHB1bGwgdXAgdGltZSBmb3Igc2VsZWN0ZWQgZGF0ZS5cbiAgICAgICAqL1xuICAgICAgaWYgKHRoaXMuaXNEYXRlVGltZVZpZXdcbiAgICAgICAgJiYgdGhpcy5fcGlja2VyT3B0aW9ucy5yYW5nZVR5cGUgPT09ICd0bydcbiAgICAgICAgJiYgIXRoaXMubW9kZWxcbiAgICAgICAgJiYgdmFsdWVcbiAgICAgICkge1xuICAgICAgICBpZiAoaXNCZWZvcmUodmFsdWUsIHRoaXMucmFuZ2VQaWNrZXJSZWYuc3RhcnREYXRlKSkge1xuICAgICAgICAgIHZhbHVlID0gbmV3IERhdGUodGhpcy5yYW5nZVBpY2tlclJlZi5zdGFydERhdGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhbHVlID0gbnVsbDtcbiAgICB9XG5cbiAgICB0aGlzLl9tb2RlbCQubmV4dCh2YWx1ZSk7XG5cbiAgICB0aGlzLl91cGRhdGVEaXNhYmxlZFRpbWVzKCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1vZGVsKCk6IERhdGUgfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5fbW9kZWwkLnZhbHVlO1xuICB9XG5cbiAgcHVibGljIGdldCBtb2RlbCQoKTogT2JzZXJ2YWJsZTxEYXRlIHwgbnVsbD4ge1xuICAgIHJldHVybiB0aGlzLl9tb2RlbCQ7XG4gIH1cblxuICBwdWJsaWMgc2V0IHBlcmlvZCh2YWx1ZTogSVBlcmlvZCB8IG51bGwpIHtcbiAgICB0aGlzLl9wZXJpb2QkLm5leHQodmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGdldCBwZXJpb2QoKTogSVBlcmlvZCB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLl9wZXJpb2QkLnZhbHVlO1xuICB9XG5cbiAgcHVibGljIGdldCBwZXJpb2QkKCk6IE9ic2VydmFibGU8SVBlcmlvZCB8IG51bGw+IHtcbiAgICByZXR1cm4gdGhpcy5fcGVyaW9kJDtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgZGlzYWJsZWREYXlzKHZhbHVlOiBbRGF0ZSwgRGF0ZV1bXSkge1xuICAgIHRoaXMuX2Rpc2FibGVkRGF5cyQubmV4dCh2YWx1ZSk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGRpc2FibGVkRGF5cyQoKTogT2JzZXJ2YWJsZTxbRGF0ZSwgRGF0ZV1bXT4ge1xuICAgIHJldHVybiB0aGlzLl9kaXNhYmxlZERheXMkO1xuICB9XG5cbiAgcHVibGljIHNldCBkaXNhYmxlZFRpbWVzKHZhbHVlOiBbRGF0ZSwgRGF0ZV1bXSkge1xuICAgIHRoaXMuX2Rpc2FibGVkVGltZXMkLm5leHQodmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGdldCBkaXNhYmxlZFRpbWVzJCgpOiBPYnNlcnZhYmxlPFtEYXRlLCBEYXRlXVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuX2Rpc2FibGVkVGltZXMkO1xuICB9XG5cbiAgcHVibGljIHNldCBtaW5ZZWFyKG1pblllYXIpIHtcbiAgICB0aGlzLl9taW5ZZWFyID0gbWluWWVhciB8fCAobmV3IERhdGUoKS5nZXRGdWxsWWVhcigpIC0gMTAwKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgbWluWWVhcigpIHtcbiAgICByZXR1cm4gdGhpcy5fbWluWWVhcjtcbiAgfVxuXG4gIHB1YmxpYyBzZXQgbWF4WWVhcihtYXhZZWFyKSB7XG4gICAgdGhpcy5fbWF4WWVhciA9IG1heFllYXIgfHwgKG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSArIDEwMCk7XG4gIH1cblxuICBwdWJsaWMgZ2V0IG1heFllYXIoKSB7XG4gICAgcmV0dXJuIHRoaXMuX21heFllYXI7XG4gIH1cblxuICBwcml2YXRlIHNldCBfY2FsZW5kYXJNb2RlKHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9jYWxlbmRhck1vZGUkLm5leHQodmFsdWUpO1xuICB9XG5cbiAgcHVibGljIGdldCB0aW1lRXhwYW5kZWQkKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xuICAgIHJldHVybiB0aGlzLl90aW1lRXhwYW5kZWQkLmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgcHVibGljIGdldCB0aW1lRXhwYW5kZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX3RpbWVFeHBhbmRlZCQudmFsdWU7XG4gIH1cblxuICBwdWJsaWMgc2V0IHRpbWVFeHBhbmRlZChmbGFnOiBib29sZWFuKSB7XG4gICAgdGhpcy5fdGltZUV4cGFuZGVkJC5uZXh0KGZsYWcpO1xuICB9XG5cbiAgcHVibGljIGdldCByYW5nZVBpY2tlclJlZigpOiBSYW5nZVBpY2tlclJlZiB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLl9waWNrZXJPcHRpb25zLnBpY2tlclJlZjtcbiAgfVxuXG4gIHB1YmxpYyBzZXRDYWxlbmRhck1vbnRoKG1vbnRoOiBudW1iZXIpIHtcbiAgICB0aGlzLmNhbGVuZGFyRGF0ZSA9IHNldE1vbnRoKHRoaXMuY2FsZW5kYXJEYXRlLCBtb250aCk7XG4gIH1cblxuICBwdWJsaWMgc2V0Q2FsZW5kYXJZZWFyKHllYXI6IG51bWJlcikge1xuICAgIHRoaXMuY2FsZW5kYXJEYXRlID0gc2V0WWVhcih0aGlzLmNhbGVuZGFyRGF0ZSwgeWVhcik7XG4gICAgdGhpcy5fdXBkYXRlRGlzYWJsZWQoKTtcbiAgfVxuXG4gIHB1YmxpYyBuZXh0TW9udGgoKSB7XG4gICAgdGhpcy5jYWxlbmRhckRhdGUgPSBhZGRNb250aHModGhpcy5jYWxlbmRhckRhdGUsIDEpO1xuICB9XG5cbiAgcHVibGljIHByZXZNb250aCgpIHtcbiAgICB0aGlzLmNhbGVuZGFyRGF0ZSA9IHN1Yk1vbnRocyh0aGlzLmNhbGVuZGFyRGF0ZSwgMSk7XG4gIH1cblxuICBwdWJsaWMgc2V0Q2FsZW5kYXJNb2RlKG1vZGU6IHN0cmluZykge1xuICAgIHRoaXMuX2NhbGVuZGFyTW9kZSA9IG1vZGU7XG4gIH1cblxuICBwcml2YXRlIF9pbml0Q2FsZW5kYXIob3B0aW9uczogSURpYWxvZ0ZhY3RvcnlPcHRpb25zKSB7XG4gICAgdGhpcy5fcGlja2VyT3B0aW9ucyA9IHsgLi4ub3B0aW9ucyB9O1xuXG4gICAgdGhpcy52aWV3ID0gb3B0aW9ucy52aWV3O1xuXG4gICAgc3dpdGNoICh0aGlzLnZpZXcpIHtcbiAgICAgIGNhc2UgUGlja2VyVmlld1R5cGUuV2Vlazoge1xuICAgICAgICB0aGlzLnBlcmlvZCA9IChvcHRpb25zLm1vZGVsVmFsdWUgYXMgSVBlcmlvZCk7XG4gICAgICAgIHRoaXMuY2FsZW5kYXJEYXRlID0gKG9wdGlvbnMubW9kZWxWYWx1ZSBhcyBJUGVyaW9kKT8uZnJvbSB8fCBuZXcgRGF0ZSgpO1xuICAgICAgfSBicmVhaztcblxuICAgICAgY2FzZSBQaWNrZXJWaWV3VHlwZS5Nb250aFJhbmdlOiB7XG4gICAgICAgIHRoaXMuY2FsZW5kYXJEYXRlID0gKG9wdGlvbnMubW9kZWxWYWx1ZSBhcyBEYXRlKSB8fCBuZXcgRGF0ZSgpO1xuICAgICAgfSBicmVhaztcblxuICAgICAgZGVmYXVsdDoge1xuICAgICAgICB0aGlzLm1vZGVsID0gKG9wdGlvbnMubW9kZWxWYWx1ZSBhcyBEYXRlKTtcbiAgICAgICAgdGhpcy5jYWxlbmRhckRhdGUgPSAob3B0aW9ucy5tb2RlbFZhbHVlIGFzIERhdGUpIHx8IG5ldyBEYXRlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5fY2FsZW5kYXJNb2RlID0gb3B0aW9ucy52aWV3O1xuICAgIHRoaXMubWluWWVhciA9IG9wdGlvbnMubWluWWVhcjtcbiAgICB0aGlzLm1heFllYXIgPSBvcHRpb25zLm1heFllYXI7XG4gICAgdGhpcy5taW5EYXRlID0gb3B0aW9ucy5taW5EYXRlO1xuICAgIHRoaXMubWF4RGF0ZSA9IG9wdGlvbnMubWF4RGF0ZTtcbiAgICB0aGlzLnN0YXJ0T2ZEYXkgPSBvcHRpb25zLnN0YXJ0T2ZEYXk7XG4gICAgdGhpcy5taW51dGVzID0gb3B0aW9ucy5taW51dGVzID09PSB1bmRlZmluZWRcbiAgICAgID8gdHJ1ZVxuICAgICAgOiBvcHRpb25zLm1pbnV0ZXM7XG5cblxuICAgIGlmICghaXNEYXRlKG9wdGlvbnMuc2VlZERhdGUpIHx8ICFpc1ZhbGlkKG9wdGlvbnMuc2VlZERhdGUpKSB7XG4gICAgICB0aGlzLnNlZWREYXRlID0gbmV3IERhdGUoKG5ldyBEYXRlKCkuZ2V0RnVsbFllYXIoKSksIDAsIDEpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNlZWREYXRlID0gb3B0aW9ucy5zZWVkRGF0ZTtcbiAgICB9XG5cbiAgICB0aGlzLnBlcmlvZFdlZWtzID0gb3B0aW9ucy5wZXJpb2RXZWVrcztcblxuICAgIHRoaXMuX3VwZGF0ZURpc2FibGVkRGF5cygpO1xuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlRGlzYWJsZWQoKSB7XG4gICAgdGhpcy5fdXBkYXRlRGlzYWJsZWREYXlzKCk7XG4gICAgdGhpcy5fdXBkYXRlRGlzYWJsZWRUaW1lcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlRGlzYWJsZWREYXlzKCkge1xuICAgIGlmICh0aGlzLl9waWNrZXJPcHRpb25zLnJhbmdlVHlwZSkge1xuICAgICAgaWYgKHRoaXMuX3BpY2tlck9wdGlvbnMucmFuZ2VUeXBlID09PSAndG8nKSB7XG4gICAgICAgIHRoaXMuZGlzYWJsZWREYXlzID0gZ2V0RGlzYWJsZWREYXlzKHRoaXMubWluRGF0ZSwgdGhpcy5tYXhEYXRlLCB0aGlzLm1pblllYXIsIHRoaXMubWF4WWVhcik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGlzYWJsZWREYXlzID0gZ2V0RGlzYWJsZWREYXlzKHRoaXMubWluRGF0ZSwgdGhpcy5tYXhEYXRlLCB0aGlzLm1pblllYXIsIHRoaXMubWF4WWVhcik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBfdXBkYXRlRGlzYWJsZWRUaW1lcygpIHtcbiAgICBjb25zdCBwaWNrZXJWaWV3ID0gdGhpcy52aWV3O1xuXG4gICAgaWYgKHBpY2tlclZpZXcgIT09IFBpY2tlclZpZXdUeXBlLkRhdGVUaW1lICYmIHBpY2tlclZpZXcgIT09IFBpY2tlclZpZXdUeXBlLlRpbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fcGlja2VyT3B0aW9ucy5yYW5nZVR5cGUpIHtcbiAgICAgIGlmICh0aGlzLl9waWNrZXJPcHRpb25zLnJhbmdlVHlwZSA9PT0gJ3RvJykge1xuICAgICAgICB0aGlzLmRpc2FibGVkVGltZXMgPSBnZXREaXNhYmxlZFRpbWVzKHRoaXMubW9kZWwsIHRoaXMuX3BpY2tlck9wdGlvbnMucGlja2VyUmVmKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5kaXNhYmxlZFRpbWVzID0gZ2V0RGlzYWJsZWRUaW1lcyh0aGlzLm1vZGVsLCB0aGlzLl9waWNrZXJPcHRpb25zLnBpY2tlclJlZik7XG4gICAgfVxuICB9XG5cbn1cbiJdfQ==