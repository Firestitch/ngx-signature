import { Injectable, Inject } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { BreakpointObserver } from '@angular/cdk/layout';
import { ComponentPortal, PortalInjector } from '@angular/cdk/portal';
import { Overlay, OverlayConfig, } from '@angular/cdk/overlay';
import { MatBottomSheet } from '@angular/material/bottom-sheet';
import { fromEvent } from 'rxjs';
import { debounceTime, takeUntil, take, tap, map, switchMap, skip, distinctUntilChanged, filter, finalize, } from 'rxjs/operators';
import { FsMobileCalendarDialogComponent } from '../../dialog/modules/mobile-dialog-container/components/mobile-dialog/mobile-dialog.component';
import { FsDateScrollPickerDesktopComponent } from '../../dialog/modules/scroll-picker-dialog-container/components/date-scroll-picker-desktop/date-scroll-picker-desktop.component';
import { FsDateScrollPickerMobileDialogComponent } from '../../dialog/modules/scroll-picker-dialog-container/components/date-scroll-picker-mobile-dialog/date-scroll-picker-mobile-dialog.component';
import { FsDesktopCalendarDialogComponent } from '../../dialog/modules/desktop-dialog-container/components/desktop-dialog/desktop-dialog.component';
import { FsDatePickerDialogRef } from '../classes/dialog-ref';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
import * as i2 from "@angular/cdk/layout";
import * as i3 from "@angular/material/bottom-sheet";
const MOBILE_BREAKPOINT = '(max-width: 737px)';
export class FsDatePickerDialogFactory {
    constructor(_overlay, _breakpointObserver, _bottomSheet, _document) {
        this._overlay = _overlay;
        this._breakpointObserver = _breakpointObserver;
        this._bottomSheet = _bottomSheet;
        this._document = _document;
        this._resolutionChanged = false;
    }
    get _ESCKeyPressed$() {
        return fromEvent(this._document, 'keydown')
            .pipe(filter((event) => {
            return event.code === 'Escape';
        }));
    }
    openDatePicker(el, injector, options) {
        this._targetElRef = el;
        const dateDialogRef = new FsDatePickerDialogRef(options);
        this._openDatePicker(injector, 'date', dateDialogRef);
        return dateDialogRef;
    }
    openDateScrollPicker(el, injector, options) {
        this._targetElRef = el;
        const dateDialogRef = new FsDatePickerDialogRef(options);
        this._openDatePicker(injector, 'scroll', dateDialogRef);
        return dateDialogRef;
    }
    _openDatePicker(injector, type, dialogRef) {
        const layoutChanges = this._breakpointObserver
            .observe([
            MOBILE_BREAKPOINT,
        ])
            .pipe(map((result) => {
            return result.breakpoints[MOBILE_BREAKPOINT];
        }));
        layoutChanges
            .pipe(map((mobile) => {
            return this._openDatePickerComponent(mobile, injector, type, dialogRef);
        }), tap((ref) => {
            dialogRef.pickerOverlayRef.setActiveOverlay(ref);
        }), take(1), switchMap(() => {
            return layoutChanges
                .pipe(skip(1));
        }), debounceTime(100), distinctUntilChanged(), tap(() => {
            this._resolutionChanged = true;
        }), tap(() => {
            dialogRef.pickerOverlayRef.close();
        }), map((mobile) => {
            return this._openDatePickerComponent(mobile, injector, type, dialogRef);
        }), tap((ref) => {
            dialogRef.pickerOverlayRef.setActiveOverlay(ref);
        }), tap(() => {
            this._resolutionChanged = false;
        }), finalize(() => {
            dialogRef.close();
        }), takeUntil(dialogRef.pickerOverlayRef.destroy$
            .pipe(filter(() => !this._resolutionChanged))), takeUntil(dialogRef.close$), takeUntil(this._ESCKeyPressed$))
            .subscribe();
    }
    _openDatePickerComponent(mobile, injector, type, dialogRef) {
        if (mobile) {
            if (type === 'date') {
                return this._openDatePickerMobile(dialogRef);
            }
            else {
                return this._openDateScrollPickerMobile(dialogRef);
            }
        }
        else {
            if (type === 'date') {
                return this._openDatePickerDesktop(injector, dialogRef);
            }
            else {
                return this._openDateScrollPickerDesktop(injector, dialogRef);
            }
        }
    }
    _createOverlay(el, config = {}) {
        config = Object.assign(Object.assign({}, config), { positionStrategy: this._createPopupPositionStrategy(el), scrollStrategy: this._overlay.scrollStrategies.reposition(), hasBackdrop: true, backdropClass: [], panelClass: 'fs-datepicker-overlay-pane' });
        const overlayConfig = new OverlayConfig(config);
        return this._overlay.create(overlayConfig);
    }
    _createInjector(parentInjector, previewRef) {
        const injectionTokens = new WeakMap([
            [FsDatePickerDialogRef, previewRef],
        ]);
        return new PortalInjector(parentInjector, injectionTokens);
    }
    _createPopupPositionStrategy(el) {
        return this._createBasePopupPositionStrategy(el)
            .withPositions([
            {
                originX: 'start',
                originY: 'bottom',
                overlayX: 'start',
                overlayY: 'top',
                offsetY: 10,
                offsetX: -29
            },
            {
                originX: 'end',
                originY: 'top',
                overlayX: 'start',
                overlayY: 'bottom',
            },
            {
                originX: 'end',
                originY: 'top',
                overlayX: 'start',
                overlayY: 'center',
            },
            {
                originX: 'end',
                originY: 'bottom',
                overlayX: 'start',
                overlayY: 'bottom',
            },
            {
                originX: 'start',
                originY: 'bottom',
                overlayX: 'end',
                overlayY: 'top',
                offsetX: -29,
            },
            {
                originX: 'start',
                originY: 'bottom',
                overlayX: 'end',
                overlayY: 'center',
                offsetX: -29,
            },
        ]);
    }
    _createBasePopupPositionStrategy(el) {
        return this._overlay.position()
            .flexibleConnectedTo(el)
            .withGrowAfterOpen(false)
            .withFlexibleDimensions(false)
            .withPush(false);
    }
    _openDatePickerDesktop(parentInjector, previewRef) {
        const overlayRef = this._createOverlay(this._targetElRef, {
            positionStrategy: this._createBasePopupPositionStrategy(this._targetElRef),
        });
        const injector = this._createInjector(parentInjector, previewRef);
        const containerPortal = new ComponentPortal(FsDesktopCalendarDialogComponent, undefined, injector);
        overlayRef.attach(containerPortal);
        return overlayRef;
    }
    _openDatePickerMobile(dialogRef) {
        return this._bottomSheet.open(FsMobileCalendarDialogComponent, {
            data: {
                dateDialogRef: dialogRef,
            },
            restoreFocus: false,
        });
    }
    _openDateScrollPickerDesktop(parentInjector, previewRef) {
        const overlayRef = this._createOverlay(this._targetElRef, { scrollStrategy: this._overlay.scrollStrategies.block() });
        const injector = this._createInjector(parentInjector, previewRef);
        const containerPortal = new ComponentPortal(FsDateScrollPickerDesktopComponent, undefined, injector);
        overlayRef.attach(containerPortal);
        return overlayRef;
    }
    _openDateScrollPickerMobile(dialogRef) {
        return this._bottomSheet.open(FsDateScrollPickerMobileDialogComponent, {
            data: {
                dateDialogRef: dialogRef,
            }
        });
    }
}
FsDatePickerDialogFactory.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerDialogFactory, deps: [{ token: i1.Overlay }, { token: i2.BreakpointObserver }, { token: i3.MatBottomSheet }, { token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
FsDatePickerDialogFactory.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerDialogFactory });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerDialogFactory, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Overlay }, { type: i2.BreakpointObserver }, { type: i3.MatBottomSheet }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLWZhY3Rvcnkuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWJzL2RpYWxvZy9zZXJ2aWNlcy9kaWFsb2ctZmFjdG9yeS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxVQUFVLEVBQVksTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3pFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsZUFBZSxFQUFFLGNBQWMsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3RFLE9BQU8sRUFDTCxPQUFPLEVBRVAsYUFBYSxHQUdkLE1BQU0sc0JBQXNCLENBQUM7QUFFOUIsT0FBTyxFQUFFLGNBQWMsRUFBcUIsTUFBTSxnQ0FBZ0MsQ0FBQztBQUVuRixPQUFPLEVBQUUsU0FBUyxFQUFjLE1BQU0sTUFBTSxDQUFDO0FBQzdDLE9BQU8sRUFDTCxZQUFZLEVBQ1osU0FBUyxFQUNULElBQUksRUFDSixHQUFHLEVBQ0gsR0FBRyxFQUNILFNBQVMsRUFDVCxJQUFJLEVBQ0osb0JBQW9CLEVBQ3BCLE1BQU0sRUFDTixRQUFRLEdBQ1QsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4QixPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSwrRkFBK0YsQ0FBQztBQUNoSixPQUFPLEVBQUUsa0NBQWtDLEVBQUUsTUFBTSxnSUFBZ0ksQ0FBQztBQUNwTCxPQUFPLEVBQUUsdUNBQXVDLEVBQUUsTUFBTSw0SUFBNEksQ0FBQztBQUNyTSxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSxrR0FBa0csQ0FBQztBQUVwSixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQzs7Ozs7QUFHOUQsTUFBTSxpQkFBaUIsR0FBRyxvQkFBb0IsQ0FBQztBQUkv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c0NvbnRlbnQiOlsiaW1wb3J0IHsgRWxlbWVudFJlZiwgSW5qZWN0YWJsZSwgSW5qZWN0b3IsIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuXG5pbXBvcnQgeyBCcmVha3BvaW50T2JzZXJ2ZXIgfSBmcm9tICdAYW5ndWxhci9jZGsvbGF5b3V0JztcbmltcG9ydCB7IENvbXBvbmVudFBvcnRhbCwgUG9ydGFsSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jZGsvcG9ydGFsJztcbmltcG9ydCB7XG4gIE92ZXJsYXksXG4gIE92ZXJsYXlSZWYsXG4gIE92ZXJsYXlDb25maWcsXG4gIFBvc2l0aW9uU3RyYXRlZ3ksXG4gIEZsZXhpYmxlQ29ubmVjdGVkUG9zaXRpb25TdHJhdGVneSxcbn0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuXG5pbXBvcnQgeyBNYXRCb3R0b21TaGVldCwgTWF0Qm90dG9tU2hlZXRSZWYgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9ib3R0b20tc2hlZXQnO1xuXG5pbXBvcnQgeyBmcm9tRXZlbnQsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7XG4gIGRlYm91bmNlVGltZSxcbiAgdGFrZVVudGlsLFxuICB0YWtlLFxuICB0YXAsXG4gIG1hcCxcbiAgc3dpdGNoTWFwLFxuICBza2lwLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgZmlsdGVyLFxuICBmaW5hbGl6ZSxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBGc01vYmlsZUNhbGVuZGFyRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZGlhbG9nL21vZHVsZXMvbW9iaWxlLWRpYWxvZy1jb250YWluZXIvY29tcG9uZW50cy9tb2JpbGUtZGlhbG9nL21vYmlsZS1kaWFsb2cuY29tcG9uZW50JztcbmltcG9ydCB7IEZzRGF0ZVNjcm9sbFBpY2tlckRlc2t0b3BDb21wb25lbnQgfSBmcm9tICcuLi8uLi9kaWFsb2cvbW9kdWxlcy9zY3JvbGwtcGlja2VyLWRpYWxvZy1jb250YWluZXIvY29tcG9uZW50cy9kYXRlLXNjcm9sbC1waWNrZXItZGVza3RvcC9kYXRlLXNjcm9sbC1waWNrZXItZGVza3RvcC5jb21wb25lbnQnO1xuaW1wb3J0IHsgRnNEYXRlU2Nyb2xsUGlja2VyTW9iaWxlRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZGlhbG9nL21vZHVsZXMvc2Nyb2xsLXBpY2tlci1kaWFsb2ctY29udGFpbmVyL2NvbXBvbmVudHMvZGF0ZS1zY3JvbGwtcGlja2VyLW1vYmlsZS1kaWFsb2cvZGF0ZS1zY3JvbGwtcGlja2VyLW1vYmlsZS1kaWFsb2cuY29tcG9uZW50JztcbmltcG9ydCB7IEZzRGVza3RvcENhbGVuZGFyRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZGlhbG9nL21vZHVsZXMvZGVza3RvcC1kaWFsb2ctY29udGFpbmVyL2NvbXBvbmVudHMvZGVza3RvcC1kaWFsb2cvZGVza3RvcC1kaWFsb2cuY29tcG9uZW50JztcblxuaW1wb3J0IHsgRnNEYXRlUGlja2VyRGlhbG9nUmVmIH0gZnJvbSAnLi4vY2xhc3Nlcy9kaWFsb2ctcmVmJztcbmltcG9ydCB7IElEaWFsb2dGYWN0b3J5T3B0aW9ucyB9IGZyb20gJy4uL2ludGVyZmFjZXMvZGlhbG9nLWZhY3RvcnktZGF0YS5pbnRlcmZhY2UnO1xuXG5jb25zdCBNT0JJTEVfQlJFQUtQT0lOVCA9ICcobWF4LXdpZHRoOiA3MzdweCknO1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBGc0RhdGVQaWNrZXJEaWFsb2dGYWN0b3J5IHtcblxuICBwcml2YXRlIF90YXJnZXRFbFJlZjogRWxlbWVudFJlZjtcbiAgcHJpdmF0ZSBfcmVzb2x1dGlvbkNoYW5nZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIF9vdmVybGF5OiBPdmVybGF5LFxuICAgIHByaXZhdGUgX2JyZWFrcG9pbnRPYnNlcnZlcjogQnJlYWtwb2ludE9ic2VydmVyLFxuICAgIHByaXZhdGUgX2JvdHRvbVNoZWV0OiBNYXRCb3R0b21TaGVldCxcbiAgICBASW5qZWN0KERPQ1VNRU5UKVxuICAgIHByaXZhdGUgX2RvY3VtZW50LFxuICApIHt9XG5cbiAgcHJpdmF0ZSBnZXQgX0VTQ0tleVByZXNzZWQkKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIGZyb21FdmVudCh0aGlzLl9kb2N1bWVudCwgJ2tleWRvd24nKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcigoZXZlbnQ6IGFueSkgPT4ge1xuICAgICAgICAgIHJldHVybiBldmVudC5jb2RlID09PSAnRXNjYXBlJztcbiAgICAgICAgfSlcbiAgICAgIClcbiAgfVxuXG5cbiAgcHVibGljIG9wZW5EYXRlUGlja2VyKFxuICAgIGVsOiBFbGVtZW50UmVmLFxuICAgIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBvcHRpb25zOiBJRGlhbG9nRmFjdG9yeU9wdGlvbnMsXG4gICk6IEZzRGF0ZVBpY2tlckRpYWxvZ1JlZiB7XG4gICAgdGhpcy5fdGFyZ2V0RWxSZWYgPSBlbDtcblxuICAgIGNvbnN0IGRhdGVEaWFsb2dSZWYgPSBuZXcgRnNEYXRlUGlja2VyRGlhbG9nUmVmKG9wdGlvbnMpO1xuXG4gICAgdGhpcy5fb3BlbkRhdGVQaWNrZXIoaW5qZWN0b3IsICdkYXRlJywgZGF0ZURpYWxvZ1JlZik7XG5cbiAgICByZXR1cm4gZGF0ZURpYWxvZ1JlZjtcbiAgfVxuXG4gIHB1YmxpYyBvcGVuRGF0ZVNjcm9sbFBpY2tlcihcbiAgICBlbDogRWxlbWVudFJlZixcbiAgICBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgb3B0aW9uczogSURpYWxvZ0ZhY3RvcnlPcHRpb25zLFxuICApOiBGc0RhdGVQaWNrZXJEaWFsb2dSZWYge1xuICAgIHRoaXMuX3RhcmdldEVsUmVmID0gZWw7XG5cbiAgICBjb25zdCBkYXRlRGlhbG9nUmVmID0gbmV3IEZzRGF0ZVBpY2tlckRpYWxvZ1JlZihvcHRpb25zKTtcblxuICAgIHRoaXMuX29wZW5EYXRlUGlja2VyKGluamVjdG9yLCAnc2Nyb2xsJywgZGF0ZURpYWxvZ1JlZik7XG5cbiAgICByZXR1cm4gZGF0ZURpYWxvZ1JlZjtcbiAgfVxuXG4gIHByaXZhdGUgX29wZW5EYXRlUGlja2VyKFxuICAgIGluamVjdG9yOiBJbmplY3RvcixcbiAgICB0eXBlOiAnZGF0ZScgfCAnc2Nyb2xsJyxcbiAgICBkaWFsb2dSZWY6IEZzRGF0ZVBpY2tlckRpYWxvZ1JlZixcbiAgKTogdm9pZCB7XG4gICAgY29uc3QgbGF5b3V0Q2hhbmdlcyA9IHRoaXMuX2JyZWFrcG9pbnRPYnNlcnZlclxuICAgICAgLm9ic2VydmUoW1xuICAgICAgICBNT0JJTEVfQlJFQUtQT0lOVCxcbiAgICAgIF0pXG4gICAgICAucGlwZShcbiAgICAgICAgbWFwKChyZXN1bHQpID0+IHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0LmJyZWFrcG9pbnRzW01PQklMRV9CUkVBS1BPSU5UXTtcbiAgICAgICAgfSksXG4gICAgICApO1xuXG4gICAgbGF5b3V0Q2hhbmdlc1xuICAgICAgLnBpcGUoXG4gICAgICAgIG1hcCgobW9iaWxlKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX29wZW5EYXRlUGlja2VyQ29tcG9uZW50KFxuICAgICAgICAgICAgbW9iaWxlLFxuICAgICAgICAgICAgaW5qZWN0b3IsXG4gICAgICAgICAgICB0eXBlLFxuICAgICAgICAgICAgZGlhbG9nUmVmLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICAgICB0YXAoKHJlZikgPT4ge1xuICAgICAgICAgIGRpYWxvZ1JlZi5waWNrZXJPdmVybGF5UmVmLnNldEFjdGl2ZU92ZXJsYXkocmVmKTtcbiAgICAgICAgfSksXG4gICAgICAgIHRha2UoMSksXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGxheW91dENoYW5nZXNcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICBza2lwKDEpLFxuICAgICAgICAgICAgKVxuICAgICAgICB9KSxcbiAgICAgICAgZGVib3VuY2VUaW1lKDEwMCksXG4gICAgICAgIGRpc3RpbmN0VW50aWxDaGFuZ2VkKCksXG4gICAgICAgIHRhcCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5fcmVzb2x1dGlvbkNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9KSxcbiAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICBkaWFsb2dSZWYucGlja2VyT3ZlcmxheVJlZi5jbG9zZSgpO1xuICAgICAgICB9KSxcbiAgICAgICAgbWFwKChtb2JpbGUpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5fb3BlbkRhdGVQaWNrZXJDb21wb25lbnQoXG4gICAgICAgICAgICBtb2JpbGUsXG4gICAgICAgICAgICBpbmplY3RvcixcbiAgICAgICAgICAgIHR5cGUsXG4gICAgICAgICAgICBkaWFsb2dSZWYsXG4gICAgICAgICAgKTtcbiAgICAgICAgfSksXG4gICAgICAgIHRhcCgocmVmKSA9PiB7XG4gICAgICAgICAgZGlhbG9nUmVmLnBpY2tlck92ZXJsYXlSZWYuc2V0QWN0aXZlT3ZlcmxheShyZWYpO1xuICAgICAgICB9KSxcbiAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICB0aGlzLl9yZXNvbHV0aW9uQ2hhbmdlZCA9IGZhbHNlO1xuICAgICAgICB9KSxcbiAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgIGRpYWxvZ1JlZi5jbG9zZSgpO1xuICAgICAgICB9KSxcbiAgICAgICAgdGFrZVVudGlsKFxuICAgICAgICAgIGRpYWxvZ1JlZi5waWNrZXJPdmVybGF5UmVmLmRlc3Ryb3kkXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgZmlsdGVyKCgpID0+ICF0aGlzLl9yZXNvbHV0aW9uQ2hhbmdlZCksXG4gICAgICAgICAgICApLFxuICAgICAgICApLFxuICAgICAgICB0YWtlVW50aWwoZGlhbG9nUmVmLmNsb3NlJCksXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLl9FU0NLZXlQcmVzc2VkJCksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBwcml2YXRlIF9vcGVuRGF0ZVBpY2tlckNvbXBvbmVudChcbiAgICBtb2JpbGU6IGJvb2xlYW4sXG4gICAgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHR5cGU6ICdkYXRlJyB8ICdzY3JvbGwnLFxuICAgIGRpYWxvZ1JlZjogRnNEYXRlUGlja2VyRGlhbG9nUmVmLFxuICApOiBPdmVybGF5UmVmIHwgTWF0Qm90dG9tU2hlZXRSZWYge1xuICAgIGlmIChtb2JpbGUpIHtcbiAgICAgIGlmICh0eXBlID09PSAnZGF0ZScpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX29wZW5EYXRlUGlja2VyTW9iaWxlKGRpYWxvZ1JlZik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5fb3BlbkRhdGVTY3JvbGxQaWNrZXJNb2JpbGUoZGlhbG9nUmVmKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHR5cGUgPT09ICdkYXRlJykge1xuICAgICAgICByZXR1cm4gdGhpcy5fb3BlbkRhdGVQaWNrZXJEZXNrdG9wKGluamVjdG9yLCBkaWFsb2dSZWYpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX29wZW5EYXRlU2Nyb2xsUGlja2VyRGVza3RvcChpbmplY3RvciwgZGlhbG9nUmVmKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIF9jcmVhdGVPdmVybGF5KGVsOiBFbGVtZW50UmVmLCBjb25maWc6IE92ZXJsYXlDb25maWcgPSB7fSkge1xuICAgIGNvbmZpZyA9IHtcbiAgICAgIC4uLmNvbmZpZyxcbiAgICAgIHBvc2l0aW9uU3RyYXRlZ3k6IHRoaXMuX2NyZWF0ZVBvcHVwUG9zaXRpb25TdHJhdGVneShlbCksXG4gICAgICBzY3JvbGxTdHJhdGVneTogdGhpcy5fb3ZlcmxheS5zY3JvbGxTdHJhdGVnaWVzLnJlcG9zaXRpb24oKSxcbiAgICAgIGhhc0JhY2tkcm9wOiB0cnVlLFxuICAgICAgYmFja2Ryb3BDbGFzczogW10sXG4gICAgICBwYW5lbENsYXNzOiAnZnMtZGF0ZXBpY2tlci1vdmVybGF5LXBhbmUnLFxuICAgIH07XG5cbiAgICBjb25zdCBvdmVybGF5Q29uZmlnID0gbmV3IE92ZXJsYXlDb25maWcoY29uZmlnKTtcblxuICAgIHJldHVybiB0aGlzLl9vdmVybGF5LmNyZWF0ZShvdmVybGF5Q29uZmlnKTtcbiAgfVxuXG4gIHByaXZhdGUgX2NyZWF0ZUluamVjdG9yKFxuICAgIHBhcmVudEluamVjdG9yOiBJbmplY3RvcixcbiAgICBwcmV2aWV3UmVmOiBGc0RhdGVQaWNrZXJEaWFsb2dSZWYsXG4gICk6IFBvcnRhbEluamVjdG9yIHtcbiAgICBjb25zdCBpbmplY3Rpb25Ub2tlbnMgPSBuZXcgV2Vha01hcDxhbnksIGFueT4oW1xuICAgICAgW0ZzRGF0ZVBpY2tlckRpYWxvZ1JlZiwgcHJldmlld1JlZl0sXG4gICAgXSk7XG5cbiAgICByZXR1cm4gbmV3IFBvcnRhbEluamVjdG9yKHBhcmVudEluamVjdG9yLCBpbmplY3Rpb25Ub2tlbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBfY3JlYXRlUG9wdXBQb3NpdGlvblN0cmF0ZWd5KGVsOiBFbGVtZW50UmVmKTogUG9zaXRpb25TdHJhdGVneSB7XG4gICAgcmV0dXJuIHRoaXMuX2NyZWF0ZUJhc2VQb3B1cFBvc2l0aW9uU3RyYXRlZ3koZWwpXG4gICAgICAud2l0aFBvc2l0aW9ucyhbXG4gICAgICAgIHtcbiAgICAgICAgICBvcmlnaW5YOiAnc3RhcnQnLFxuICAgICAgICAgIG9yaWdpblk6ICdib3R0b20nLFxuICAgICAgICAgIG92ZXJsYXlYOiAnc3RhcnQnLFxuICAgICAgICAgIG92ZXJsYXlZOiAndG9wJyxcbiAgICAgICAgICBvZmZzZXRZOiAxMCxcbiAgICAgICAgICBvZmZzZXRYOiAtMjlcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIG9yaWdpblg6ICdlbmQnLFxuICAgICAgICAgIG9yaWdpblk6ICd0b3AnLFxuICAgICAgICAgIG92ZXJsYXlYOiAnc3RhcnQnLFxuICAgICAgICAgIG92ZXJsYXlZOiAnYm90dG9tJyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIG9yaWdpblg6ICdlbmQnLFxuICAgICAgICAgIG9yaWdpblk6ICd0b3AnLFxuICAgICAgICAgIG92ZXJsYXlYOiAnc3RhcnQnLFxuICAgICAgICAgIG92ZXJsYXlZOiAnY2VudGVyJyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIG9yaWdpblg6ICdlbmQnLFxuICAgICAgICAgIG9yaWdpblk6ICdib3R0b20nLFxuICAgICAgICAgIG92ZXJsYXlYOiAnc3RhcnQnLFxuICAgICAgICAgIG92ZXJsYXlZOiAnYm90dG9tJyxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIG9yaWdpblg6ICdzdGFydCcsXG4gICAgICAgICAgb3JpZ2luWTogJ2JvdHRvbScsXG4gICAgICAgICAgb3ZlcmxheVg6ICdlbmQnLFxuICAgICAgICAgIG92ZXJsYXlZOiAndG9wJyxcbiAgICAgICAgICBvZmZzZXRYOiAtMjksXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBvcmlnaW5YOiAnc3RhcnQnLFxuICAgICAgICAgIG9yaWdpblk6ICdib3R0b20nLFxuICAgICAgICAgIG92ZXJsYXlYOiAnZW5kJyxcbiAgICAgICAgICBvdmVybGF5WTogJ2NlbnRlcicsXG4gICAgICAgICAgb2Zmc2V0WDogLTI5LFxuICAgICAgICB9LFxuICAgICAgXSk7XG4gIH1cblxuICBwcml2YXRlIF9jcmVhdGVCYXNlUG9wdXBQb3NpdGlvblN0cmF0ZWd5KGVsOiBFbGVtZW50UmVmKTogRmxleGlibGVDb25uZWN0ZWRQb3NpdGlvblN0cmF0ZWd5IHtcbiAgICByZXR1cm4gdGhpcy5fb3ZlcmxheS5wb3NpdGlvbigpXG4gICAgICAuZmxleGlibGVDb25uZWN0ZWRUbyhlbClcbiAgICAgIC53aXRoR3Jvd0FmdGVyT3BlbihmYWxzZSlcbiAgICAgIC53aXRoRmxleGlibGVEaW1lbnNpb25zKGZhbHNlKVxuICAgICAgLndpdGhQdXNoKGZhbHNlKVxuICB9XG5cbiAgcHJpdmF0ZSBfb3BlbkRhdGVQaWNrZXJEZXNrdG9wIChcbiAgICBwYXJlbnRJbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJldmlld1JlZjogRnNEYXRlUGlja2VyRGlhbG9nUmVmLFxuICApOiBPdmVybGF5UmVmIHtcbiAgICBjb25zdCBvdmVybGF5UmVmID0gdGhpcy5fY3JlYXRlT3ZlcmxheShcbiAgICAgIHRoaXMuX3RhcmdldEVsUmVmLFxuICAgICAge1xuICAgICAgICBwb3NpdGlvblN0cmF0ZWd5OiB0aGlzLl9jcmVhdGVCYXNlUG9wdXBQb3NpdGlvblN0cmF0ZWd5KHRoaXMuX3RhcmdldEVsUmVmKSxcbiAgICAgIH1cbiAgICApO1xuICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5fY3JlYXRlSW5qZWN0b3IocGFyZW50SW5qZWN0b3IsIHByZXZpZXdSZWYpO1xuICAgIGNvbnN0IGNvbnRhaW5lclBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwoRnNEZXNrdG9wQ2FsZW5kYXJEaWFsb2dDb21wb25lbnQsIHVuZGVmaW5lZCwgaW5qZWN0b3IpO1xuICAgIG92ZXJsYXlSZWYuYXR0YWNoKGNvbnRhaW5lclBvcnRhbCk7XG5cbiAgICByZXR1cm4gb3ZlcmxheVJlZjtcbiAgfVxuXG5cbiAgcHJpdmF0ZSBfb3BlbkRhdGVQaWNrZXJNb2JpbGUoZGlhbG9nUmVmOiBGc0RhdGVQaWNrZXJEaWFsb2dSZWYpOiBNYXRCb3R0b21TaGVldFJlZiB7XG4gICAgcmV0dXJuIHRoaXMuX2JvdHRvbVNoZWV0Lm9wZW4oRnNNb2JpbGVDYWxlbmRhckRpYWxvZ0NvbXBvbmVudCwge1xuICAgICAgZGF0YToge1xuICAgICAgICBkYXRlRGlhbG9nUmVmOiBkaWFsb2dSZWYsXG4gICAgICB9LFxuICAgICAgcmVzdG9yZUZvY3VzOiBmYWxzZSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgX29wZW5EYXRlU2Nyb2xsUGlja2VyRGVza3RvcCAoXG4gICAgcGFyZW50SW5qZWN0b3I6IEluamVjdG9yLFxuICAgIHByZXZpZXdSZWY6IEZzRGF0ZVBpY2tlckRpYWxvZ1JlZixcbiAgKTogT3ZlcmxheVJlZiB7XG4gICAgY29uc3Qgb3ZlcmxheVJlZiA9IHRoaXMuX2NyZWF0ZU92ZXJsYXkoXG4gICAgICB0aGlzLl90YXJnZXRFbFJlZixcbiAgICAgIHsgc2Nyb2xsU3RyYXRlZ3k6IHRoaXMuX292ZXJsYXkuc2Nyb2xsU3RyYXRlZ2llcy5ibG9jaygpIH1cbiAgICApO1xuICAgIGNvbnN0IGluamVjdG9yID0gdGhpcy5fY3JlYXRlSW5qZWN0b3IocGFyZW50SW5qZWN0b3IsIHByZXZpZXdSZWYpO1xuICAgIGNvbnN0IGNvbnRhaW5lclBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWwoRnNEYXRlU2Nyb2xsUGlja2VyRGVza3RvcENvbXBvbmVudCwgdW5kZWZpbmVkLCBpbmplY3Rvcik7XG4gICAgb3ZlcmxheVJlZi5hdHRhY2goY29udGFpbmVyUG9ydGFsKTtcblxuICAgIHJldHVybiBvdmVybGF5UmVmO1xuICB9XG5cblxuICBwcml2YXRlIF9vcGVuRGF0ZVNjcm9sbFBpY2tlck1vYmlsZShkaWFsb2dSZWY6IEZzRGF0ZVBpY2tlckRpYWxvZ1JlZik6IE1hdEJvdHRvbVNoZWV0UmVmIHtcbiAgICByZXR1cm4gdGhpcy5fYm90dG9tU2hlZXQub3BlbihGc0RhdGVTY3JvbGxQaWNrZXJNb2JpbGVEaWFsb2dDb21wb25lbnQsIHtcbiAgICAgIGRhdGE6IHtcbiAgICAgICAgZGF0ZURpYWxvZ1JlZjogZGlhbG9nUmVmLFxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbn1cbiJdfQ==