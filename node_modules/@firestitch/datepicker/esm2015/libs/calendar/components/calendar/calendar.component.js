import { ChangeDetectionStrategy, Component, ElementRef, EventEmitter, Input, Output, } from '@angular/core';
import { eachDayOfInterval, format, isAfter, lightFormat, startOfDay, } from 'date-fns';
import { getStartDayDate } from '../../../common/helpers/get-start-day-date';
import { splitDateByComponents } from '../../../common/helpers/split-date-by-components';
import { WEEKDAYS } from '../../consts/week-days';
import { Month } from '../../models/month';
import { Period } from '../../models/period';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export class FsDatePickerCalendarComponent {
    constructor(element) {
        this.element = element;
        this.date = null;
        this.period = null;
        this.rangeFrom = null;
        this.rangeTo = null;
        this.highlightStartDate = null;
        this.highlightEndDate = null;
        this.dateMode = null;
        this.disabledDays = null;
        this.drawMonth = null;
        this.hideExtraDays = false;
        this.change = new EventEmitter();
        this.rangeChange = new EventEmitter();
        this.periodChange = new EventEmitter();
        this.hoverDay = new EventEmitter();
        this.selected = {};
        this.selectedRange = {};
        this.month = null;
        this.weekDaysList = [];
        this.currentDate = new Date();
        this.today = {
            date: format(this.currentDate, 'yyyy-MM-dd'),
            month: this.currentDate.getMonth(),
            year: this.currentDate.getFullYear()
        };
        this.highlightedRangeDays = null;
        // date | datetime | week
        this._calendarMode = 'date';
    }
    ngOnInit() {
        this._calendarMode = this.dateMode;
        if (this.dateMode === 'week') {
            if (this.period && this.seedDate) {
                this.selectedPeriod = new Period(this.period.period, this.period.from, this.seedDate, this.periodWeeks, true);
                this.selectedPeriod.year = this.period.from.getFullYear();
                const selectedPeriod = this.month.updateSelectionForPeriod(this.selectedPeriod);
                if (selectedPeriod) {
                    this.selectedPeriod = selectedPeriod;
                }
            }
        }
        else if (this.date) {
            this.selected = splitDateByComponents(this.date);
        }
    }
    ngOnChanges(changes) {
        if (changes) {
            if (changes.date) {
                this.selected = splitDateByComponents(this.date);
                this.updateDaysHighlighted();
            }
            else if (changes.highlightStartDate || changes.highlightEndDate) {
                this.updateDaysHighlighted();
            }
            if (changes.drawMonth) {
                if (changes.drawMonth.currentValue) {
                    this.drawMonths(changes.drawMonth.currentValue);
                }
            }
            if (changes.rangeFrom || changes.rangeTo) {
                this.selectedRange = {
                    from: this.rangeFrom && lightFormat(this.rangeFrom, 'yyyy-MM-dd') || null,
                    to: this.rangeTo && lightFormat(this.rangeTo, 'yyyy-MM-dd') || null,
                };
            }
        }
    }
    onMouseEnterDay(day) {
        this.hoverDay.emit(day);
    }
    mouseEnterWeek(week) {
        if (this.dateMode === 'week') {
            week.period.mouseOver = true;
        }
    }
    mouseLeaveWeek(week) {
        if (this.dateMode === 'week') {
            week.period.mouseOver = false;
        }
    }
    updateDaysHighlighted() {
        this.highlightedRangeDays = {
            data: {},
            min: null,
            max: null
        };
        let start = null;
        let end = null;
        if (this.highlightStartDate && this.highlightEndDate) {
            if (isAfter(this.highlightStartDate, this.highlightEndDate)) {
                start = this.highlightEndDate;
                end = this.highlightStartDate;
            }
            else {
                start = this.highlightStartDate;
                end = this.highlightEndDate;
            }
            start = startOfDay(start);
            end = startOfDay(end);
            const range = Array.from(eachDayOfInterval({ start, end }));
            if (!range.length) {
                return;
            }
            for (const day of range) {
                this.highlightedRangeDays.data[lightFormat(day, 'yyyy-MM-dd')] = true;
            }
            this.highlightedRangeDays.min = lightFormat(range[0], 'yyyy-MM-dd');
            this.highlightedRangeDays.max = lightFormat(range[range.length - 1], 'yyyy-MM-dd');
        }
    }
    createModel() {
        if (!this.date) {
            this.date = getStartDayDate();
        }
    }
    setDate(date) {
        this.date = date;
        this.change.emit(date);
    }
    /**
     *
     * @param day
     * @param week
     * @param event
     */
    dayClick(day, week, event) {
        if (this.dateMode === 'week') {
            this.selectPeriod(week.period);
        }
        else if (this.dateMode === 'monthrange') {
            this.selectMonthRange(day);
        }
        else {
            this.selectDay(day);
        }
    }
    selectDay(day) {
        if (day.disabled) {
            return;
        }
        if (!this.date) {
            this.createModel();
        }
        const date = new Date(day.year, day.month, day.number, this.date.getHours(), this.date.getMinutes(), this.date.getSeconds());
        this.setDate(date);
    }
    selectMonthRange(day) {
        const date = new Date(day.year, day.month, +day.number, 0, 0, 0);
        this.setDate(date);
    }
    selectPeriod(period) {
        if (this.selectedPeriod) {
            if (this.selectedPeriod === period) {
                this.selectedPeriod.selected = !this.selectedPeriod.selected;
            }
            else {
                this.selectedPeriod.selected = false;
                period.selected = true;
                this.selectedPeriod = period;
            }
        }
        else {
            period.selected = true;
            this.selectedPeriod = period;
        }
        if (this.selectedPeriod.selected) {
            this.periodChange.emit({
                period: this.selectedPeriod.periodId,
                from: this.selectedPeriod.from,
                to: this.selectedPeriod.to,
            });
        }
        else {
            this.periodChange.emit(null);
        }
    }
    drawMonths(date) {
        this.month = this.createMonth(date);
    }
    createMonth(date) {
        const month = new Month(date, this.seedDate, this.periodWeeks, this.disabledDays, this.hideExtraDays);
        if (this.dateMode === 'week') {
            this.weekDaysList = WEEKDAYS.map((_, i, arr) => {
                return arr[(i + month.seedDay) % 7];
            });
        }
        else {
            this.weekDaysList = WEEKDAYS.slice();
        }
        month.renderDays();
        if (this.dateMode === 'week' && this.selectedPeriod) {
            const selectedPeriod = month.updateSelectionForPeriod(this.selectedPeriod);
            if (selectedPeriod) {
                this.selectedPeriod = selectedPeriod;
            }
        }
        return month;
    }
}
FsDatePickerCalendarComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerCalendarComponent, deps: [{ token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Component });
FsDatePickerCalendarComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "12.2.16", type: FsDatePickerCalendarComponent, selector: "fs-date-picker-calendar", inputs: { date: "date", period: "period", rangeFrom: "rangeFrom", rangeTo: "rangeTo", highlightStartDate: "highlightStartDate", highlightEndDate: "highlightEndDate", dateMode: "dateMode", disabledDays: "disabledDays", drawMonth: "drawMonth", seedDate: "seedDate", periodWeeks: "periodWeeks", hideExtraDays: "hideExtraDays" }, outputs: { change: "change", rangeChange: "rangeChange", periodChange: "periodChange", hoverDay: "hoverDay" }, host: { classAttribute: "fs-date-picker-calendar" }, usesOnChanges: true, ngImport: i0, template: "<table\n  [class.month-range]=\"dateMode === 'monthrange'\"\n  [class.range-selected]=\"!!selectedRange.from && !!selectedRange.to\">\n  <thead>\n    <tr>\n      <th *ngIf=\"seedDate && periodWeeks\">#</th>\n      <th *ngFor=\"let wd of weekDaysList\">{{wd}}</th>\n    </tr>\n  </thead>\n\n  <tbody class=\"calendar calendar-{{ month.monthAndYear }}\" >\n    <ng-container *ngFor=\"let week of month.weeks\">\n      <tr class=\"week\"\n          [class.first-period-week]=\"week.firstWeekInPeriod\"\n          [class.last-period-week]=\"week.lastWeekInPeriod\"\n          [class.hover]=\"week.period?.mouseOver\"\n          (mouseenter)=\"mouseEnterWeek(week)\"\n          (mouseleave)=\"mouseLeaveWeek(week)\"\n      >\n        <ng-container *ngIf=\"week.periodLableVisible\">\n          <td class=\"period\"\n              [rowSpan]=\"week.period.countOfWeeks\"\n              [class.selected]=\"week.period.selected\"\n              (click)=\"selectPeriod(week.period)\">\n            {{ week.period.periodId }}\n          </td>\n        </ng-container>\n\n        <ng-container *ngFor=\"let day of week.days\">\n          <td class=\"tile day\"\n              [class.hidden-day]=\"hideExtraDays && day.mute\"\n              [class.now]=\"today.date == day.date\"\n              [class.mute]=\"day.mute\"\n              [class.selected]=\"(day.selected || day.date == selected.date && !day.mute)\"\n              [class.range-from]=\"day.date === selectedRange.from && !day.mute && selectedRange.from !== selectedRange.to\"\n              [class.range-to]=\"day.date === selectedRange.to && !day.mute && selectedRange.from !== selectedRange.to\"\n              [class.same-range-dates]=\"(hideExtraDays && !day.mute) && selectedRange.from === day.date && selectedRange.from === selectedRange.to\"\n              [class.highlighted]=\"!day.disabled && !day.mute && !!highlightedRangeDays.data[day.date]\"\n              [class.highlight-min-date]=\"day.date === highlightedRangeDays.min\"\n              [class.highlight-max-date]=\"day.date === highlightedRangeDays.max\"\n              [class.week-mode]=\"dateMode === 'week'\"\n              [class.disabled]=\"day.disabled\"\n              (click)=\"dayClick(day, week, $event)\"\n              (mouseenter)=\"onMouseEnterDay(day)\">\n            <div class=\"tile-content\">\n              <div class=\"tile-day-label\">\n                {{ day.number }}\n              </div>\n            </div>\n          </td>\n        </ng-container>\n      </tr>\n    </ng-container>\n\n  <!--<tr *ngIf=\"month.weeks.length < 6\">\n    <td colspan=\"7\" class=\"tile\"></td>\n  </tr>-->\n  </tbody>\n</table>\n", styles: [""], directives: [{ type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { type: i1.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "12.2.16", ngImport: i0, type: FsDatePickerCalendarComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'fs-date-picker-calendar',
                    templateUrl: './calendar.component.html',
                    styleUrls: ['./calendar.component.scss'],
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    host: {
                        'class': 'fs-date-picker-calendar',
                    },
                }]
        }], ctorParameters: function () { return [{ type: i0.ElementRef }]; }, propDecorators: { date: [{
                type: Input
            }], period: [{
                type: Input
            }], rangeFrom: [{
                type: Input
            }], rangeTo: [{
                type: Input
            }], highlightStartDate: [{
                type: Input
            }], highlightEndDate: [{
                type: Input
            }], dateMode: [{
                type: Input
            }], disabledDays: [{
                type: Input
            }], drawMonth: [{
                type: Input
            }], seedDate: [{
                type: Input
            }], periodWeeks: [{
                type: Input
            }], hideExtraDays: [{
                type: Input
            }], change: [{
                type: Output
            }], rangeChange: [{
                type: Output
            }], periodChange: [{
                type: Output
            }], hoverDay: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FsZW5kYXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vc3JjL2xpYnMvY2FsZW5kYXIvY29tcG9uZW50cy9jYWxlbmRhci9jYWxlbmRhci5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGlicy9jYWxlbmRhci9jb21wb25lbnRzL2NhbGVuZGFyL2NhbGVuZGFyLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsU0FBUyxFQUNULFVBQVUsRUFDVixZQUFZLEVBQ1osS0FBSyxFQUdMLE1BQU0sR0FDUCxNQUFNLGVBQWUsQ0FBQztBQUd2QixPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLE1BQU0sRUFDTixPQUFPLEVBQ1AsV0FBVyxFQUNYLFVBQVUsR0FDWCxNQUFNLFVBQVUsQ0FBQztBQUVsQixPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDN0UsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sa0RBQWtELENBQUM7QUFHekYsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ2xELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0scUJBQXFCLENBQUM7OztBQWM3QyxNQUFNLE9BQU8sNkJBQTZCO0lBcUV4QyxZQUNTLE9BQW1CO1FBQW5CLFlBQU8sR0FBUCxPQUFPLENBQVk7UUFuRXJCLFNBQUksR0FBUyxJQUFJLENBQUM7UUFHbEIsV0FBTSxHQUFZLElBQUksQ0FBQztRQUd2QixjQUFTLEdBQVMsSUFBSSxDQUFDO1FBR3ZCLFlBQU8sR0FBUyxJQUFJLENBQUM7UUFHckIsdUJBQWtCLEdBQVMsSUFBSSxDQUFDO1FBR2hDLHFCQUFnQixHQUFTLElBQUksQ0FBQztRQUc5QixhQUFRLEdBQVcsSUFB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c0JBRHhCLEtBQUs7Z0JBSUMsZ0JBQWdCO3NCQUR0QixLQUFLO2dCQUlDLFFBQVE7c0JBRGQsS0FBSztnQkFJQyxZQUFZO3NCQURsQixLQUFLO2dCQUlDLFNBQVM7c0JBRGYsS0FBSztnQkFJQyxRQUFRO3NCQURkLEtBQUs7Z0JBSUMsV0FBVztzQkFEakIsS0FBSztnQkFJQyxhQUFhO3NCQURuQixLQUFLO2dCQUlDLE1BQU07c0JBRFosTUFBTTtnQkFJQSxXQUFXO3NCQURqQixNQUFNO2dCQUlBLFlBQVk7c0JBRGxCLE1BQU07Z0JBSUEsUUFBUTtzQkFEZCxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgT25DaGFuZ2VzLFxuICBPbkluaXQsXG4gIE91dHB1dCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cblxuaW1wb3J0IHtcbiAgZWFjaERheU9mSW50ZXJ2YWwsXG4gIGZvcm1hdCxcbiAgaXNBZnRlcixcbiAgbGlnaHRGb3JtYXQsXG4gIHN0YXJ0T2ZEYXksXG59IGZyb20gJ2RhdGUtZm5zJztcblxuaW1wb3J0IHsgZ2V0U3RhcnREYXlEYXRlIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2hlbHBlcnMvZ2V0LXN0YXJ0LWRheS1kYXRlJztcbmltcG9ydCB7IHNwbGl0RGF0ZUJ5Q29tcG9uZW50cyB9IGZyb20gJy4uLy4uLy4uL2NvbW1vbi9oZWxwZXJzL3NwbGl0LWRhdGUtYnktY29tcG9uZW50cyc7XG5pbXBvcnQgeyBJUGVyaW9kIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2ludGVyZmFjZXMvcGVyaW9kLmludGVyZmFjZSc7XG5cbmltcG9ydCB7IFdFRUtEQVlTIH0gZnJvbSAnLi4vLi4vY29uc3RzL3dlZWstZGF5cyc7XG5pbXBvcnQgeyBNb250aCB9IGZyb20gJy4uLy4uL21vZGVscy9tb250aCc7XG5pbXBvcnQgeyBQZXJpb2QgfSBmcm9tICcuLi8uLi9tb2RlbHMvcGVyaW9kJztcbmltcG9ydCB7IFdlZWsgfSBmcm9tICcuLi8uLi9tb2RlbHMvd2Vlayc7XG5pbXBvcnQgeyBEYXlJdGVtIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9kYXktaXRlbS5pbnRlcmZhY2UnO1xuXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2ZzLWRhdGUtcGlja2VyLWNhbGVuZGFyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2NhbGVuZGFyLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vY2FsZW5kYXIuY29tcG9uZW50LnNjc3MnXSxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIGhvc3Q6IHtcbiAgICAnY2xhc3MnOiAnZnMtZGF0ZS1waWNrZXItY2FsZW5kYXInLFxuICB9LFxufSlcbmV4cG9ydCBjbGFzcyBGc0RhdGVQaWNrZXJDYWxlbmRhckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25DaGFuZ2VzIHtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgZGF0ZTogRGF0ZSA9IG51bGw7XG5cbiAgQElucHV0KClcbiAgcHVibGljIHBlcmlvZDogSVBlcmlvZCA9IG51bGw7XG5cbiAgQElucHV0KClcbiAgcHVibGljIHJhbmdlRnJvbTogRGF0ZSA9IG51bGw7XG5cbiAgQElucHV0KClcbiAgcHVibGljIHJhbmdlVG86IERhdGUgPSBudWxsO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBoaWdobGlnaHRTdGFydERhdGU6IERhdGUgPSBudWxsO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBoaWdobGlnaHRFbmREYXRlOiBEYXRlID0gbnVsbDtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgZGF0ZU1vZGU6IHN0cmluZyA9IG51bGw7XG5cbiAgQElucHV0KClcbiAgcHVibGljIGRpc2FibGVkRGF5czogW0RhdGUsIERhdGVdW10gPSBudWxsO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBkcmF3TW9udGg6IERhdGUgPSBudWxsO1xuXG4gIEBJbnB1dCgpXG4gIHB1YmxpYyBzZWVkRGF0ZTtcblxuICBASW5wdXQoKVxuICBwdWJsaWMgcGVyaW9kV2Vla3M7XG5cbiAgQElucHV0KClcbiAgcHVibGljIGhpZGVFeHRyYURheXMgPSBmYWxzZTtcblxuICBAT3V0cHV0KClcbiAgcHVibGljIGNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8RGF0ZT4oKTtcblxuICBAT3V0cHV0KClcbiAgcHVibGljIHJhbmdlQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxEYXRlPigpO1xuXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgcGVyaW9kQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxJUGVyaW9kPigpO1xuXG4gIEBPdXRwdXQoKVxuICBwdWJsaWMgaG92ZXJEYXkgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBwdWJsaWMgc2VsZWN0ZWQ6IGFueSA9IHt9O1xuICBwdWJsaWMgc2VsZWN0ZWRQZXJpb2Q6IFBlcmlvZDtcbiAgcHVibGljIHNlbGVjdGVkUmFuZ2U6IHsgZnJvbT86IHN0cmluZywgdG8/OiBzdHJpbmcgfSA9IHt9XG4gIHB1YmxpYyBtb250aDogTW9udGggPSBudWxsO1xuXG4gIHB1YmxpYyB3ZWVrRGF5c0xpc3QgPSBbXTtcblxuICBwdWJsaWMgY3VycmVudERhdGUgPSBuZXcgRGF0ZSgpO1xuICBwdWJsaWMgdG9kYXk6IGFueSA9IHtcbiAgICBkYXRlOiBmb3JtYXQodGhpcy5jdXJyZW50RGF0ZSwgJ3l5eXktTU0tZGQnKSxcbiAgICBtb250aDogdGhpcy5jdXJyZW50RGF0ZS5nZXRNb250aCgpLFxuICAgIHllYXI6IHRoaXMuY3VycmVudERhdGUuZ2V0RnVsbFllYXIoKVxuICB9O1xuXG4gIHB1YmxpYyBoaWdobGlnaHRlZFJhbmdlRGF5cyA9IG51bGw7XG5cbiAgLy8gZGF0ZSB8IGRhdGV0aW1lIHwgd2Vla1xuICBwcml2YXRlIF9jYWxlbmRhck1vZGUgPSAnZGF0ZSc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHVibGljIGVsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICkge31cblxuICBwdWJsaWMgbmdPbkluaXQoKSB7XG5cbiAgICB0aGlzLl9jYWxlbmRhck1vZGUgPSB0aGlzLmRhdGVNb2RlO1xuXG4gICAgaWYgKHRoaXMuZGF0ZU1vZGUgPT09ICd3ZWVrJykge1xuICAgICAgaWYgKHRoaXMucGVyaW9kICYmIHRoaXMuc2VlZERhdGUpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFBlcmlvZCA9IG5ldyBQZXJpb2QodGhpcy5wZXJpb2QucGVyaW9kLCB0aGlzLnBlcmlvZC5mcm9tLCB0aGlzLnNlZWREYXRlLCB0aGlzLnBlcmlvZFdlZWtzLCB0cnVlKTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFBlcmlvZC55ZWFyID0gdGhpcy5wZXJpb2QuZnJvbS5nZXRGdWxsWWVhcigpO1xuXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkUGVyaW9kID0gdGhpcy5tb250aC51cGRhdGVTZWxlY3Rpb25Gb3JQZXJpb2QodGhpcy5zZWxlY3RlZFBlcmlvZCk7XG5cbiAgICAgICAgaWYgKHNlbGVjdGVkUGVyaW9kKSB7XG4gICAgICAgICAgdGhpcy5zZWxlY3RlZFBlcmlvZCA9IHNlbGVjdGVkUGVyaW9kO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmICh0aGlzLmRhdGUpIHtcbiAgICAgIHRoaXMuc2VsZWN0ZWQgPSBzcGxpdERhdGVCeUNvbXBvbmVudHModGhpcy5kYXRlKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbmdPbkNoYW5nZXMoY2hhbmdlcykge1xuICAgIGlmIChjaGFuZ2VzKSB7XG5cbiAgICAgIGlmIChjaGFuZ2VzLmRhdGUpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZCA9IHNwbGl0RGF0ZUJ5Q29tcG9uZW50cyh0aGlzLmRhdGUpO1xuICAgICAgICB0aGlzLnVwZGF0ZURheXNIaWdobGlnaHRlZCgpO1xuICAgICAgfSBlbHNlIGlmIChjaGFuZ2VzLmhpZ2hsaWdodFN0YXJ0RGF0ZSB8fCBjaGFuZ2VzLmhpZ2hsaWdodEVuZERhdGUpIHtcbiAgICAgICAgdGhpcy51cGRhdGVEYXlzSGlnaGxpZ2h0ZWQoKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNoYW5nZXMuZHJhd01vbnRoKSB7XG4gICAgICAgIGlmIChjaGFuZ2VzLmRyYXdNb250aC5jdXJyZW50VmFsdWUpIHtcbiAgICAgICAgICB0aGlzLmRyYXdNb250aHMoY2hhbmdlcy5kcmF3TW9udGguY3VycmVudFZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoY2hhbmdlcy5yYW5nZUZyb20gfHwgY2hhbmdlcy5yYW5nZVRvKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRSYW5nZSA9IHtcbiAgICAgICAgICBmcm9tOiB0aGlzLnJhbmdlRnJvbSAmJiBsaWdodEZvcm1hdCh0aGlzLnJhbmdlRnJvbSwgJ3l5eXktTU0tZGQnKSB8fCBudWxsLFxuICAgICAgICAgIHRvOiB0aGlzLnJhbmdlVG8gJiYgbGlnaHRGb3JtYXQodGhpcy5yYW5nZVRvLCAneXl5eS1NTS1kZCcpIHx8IG51bGwsXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgb25Nb3VzZUVudGVyRGF5KGRheSkge1xuICAgIHRoaXMuaG92ZXJEYXkuZW1pdChkYXkpO1xuICB9XG5cbiAgcHVibGljIG1vdXNlRW50ZXJXZWVrKHdlZWs6IFdlZWspIHtcbiAgICBpZiAodGhpcy5kYXRlTW9kZSA9PT0gJ3dlZWsnKSB7XG4gICAgICB3ZWVrLnBlcmlvZC5tb3VzZU92ZXIgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBtb3VzZUxlYXZlV2Vlayh3ZWVrOiBXZWVrKSB7XG4gICAgaWYgKHRoaXMuZGF0ZU1vZGUgPT09ICd3ZWVrJykge1xuICAgICAgd2Vlay5wZXJpb2QubW91c2VPdmVyID0gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHVwZGF0ZURheXNIaWdobGlnaHRlZCgpIHtcbiAgICB0aGlzLmhpZ2hsaWdodGVkUmFuZ2VEYXlzID0ge1xuICAgICAgZGF0YToge30sXG4gICAgICBtaW46IG51bGwsXG4gICAgICBtYXg6IG51bGxcbiAgICB9O1xuXG4gICAgbGV0IHN0YXJ0ID0gbnVsbDtcbiAgICBsZXQgZW5kID0gbnVsbDtcblxuICAgIGlmICh0aGlzLmhpZ2hsaWdodFN0YXJ0RGF0ZSAmJiB0aGlzLmhpZ2hsaWdodEVuZERhdGUpIHtcbiAgICAgIGlmIChpc0FmdGVyKHRoaXMuaGlnaGxpZ2h0U3RhcnREYXRlLCB0aGlzLmhpZ2hsaWdodEVuZERhdGUpKSB7XG4gICAgICAgIHN0YXJ0ID0gdGhpcy5oaWdobGlnaHRFbmREYXRlO1xuICAgICAgICBlbmQgPSB0aGlzLmhpZ2hsaWdodFN0YXJ0RGF0ZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHN0YXJ0ID0gdGhpcy5oaWdobGlnaHRTdGFydERhdGU7XG4gICAgICAgIGVuZCA9IHRoaXMuaGlnaGxpZ2h0RW5kRGF0ZTtcbiAgICAgIH1cblxuICAgICAgc3RhcnQgPSBzdGFydE9mRGF5KHN0YXJ0KTtcbiAgICAgIGVuZCA9IHN0YXJ0T2ZEYXkoZW5kKTtcblxuICAgICAgY29uc3QgcmFuZ2UgPSBBcnJheS5mcm9tKGVhY2hEYXlPZkludGVydmFsKHsgc3RhcnQsIGVuZCB9KSk7XG5cbiAgICAgIGlmICghcmFuZ2UubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgZm9yIChjb25zdCBkYXkgb2YgcmFuZ2UpIHtcbiAgICAgICAgdGhpcy5oaWdobGlnaHRlZFJhbmdlRGF5cy5kYXRhW2xpZ2h0Rm9ybWF0KGRheSwgJ3l5eXktTU0tZGQnKV0gPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmhpZ2hsaWdodGVkUmFuZ2VEYXlzLm1pbiA9IGxpZ2h0Rm9ybWF0KHJhbmdlWzBdLCAneXl5eS1NTS1kZCcpO1xuICAgICAgdGhpcy5oaWdobGlnaHRlZFJhbmdlRGF5cy5tYXggPSBsaWdodEZvcm1hdChyYW5nZVtyYW5nZS5sZW5ndGggLSAxXSwgJ3l5eXktTU0tZGQnKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgY3JlYXRlTW9kZWwoKSB7XG4gICAgaWYgKCF0aGlzLmRhdGUpIHtcbiAgICAgIHRoaXMuZGF0ZSA9IGdldFN0YXJ0RGF5RGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzZXREYXRlKGRhdGUpIHtcbiAgICB0aGlzLmRhdGUgPSBkYXRlO1xuICAgIHRoaXMuY2hhbmdlLmVtaXQoZGF0ZSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogQHBhcmFtIGRheVxuICAgKiBAcGFyYW0gd2Vla1xuICAgKiBAcGFyYW0gZXZlbnRcbiAgICovXG4gIHB1YmxpYyBkYXlDbGljayhkYXksIHdlZWssIGV2ZW50KSB7XG4gICAgaWYgKHRoaXMuZGF0ZU1vZGUgPT09ICd3ZWVrJykge1xuICAgICAgdGhpcy5zZWxlY3RQZXJpb2Qod2Vlay5wZXJpb2QpO1xuICAgIH0gZWxzZSBpZiAodGhpcy5kYXRlTW9kZSA9PT0gJ21vbnRocmFuZ2UnKSB7XG4gICAgICB0aGlzLnNlbGVjdE1vbnRoUmFuZ2UoZGF5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZWxlY3REYXkoZGF5KTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc2VsZWN0RGF5KGRheSkge1xuICAgIGlmIChkYXkuZGlzYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuZGF0ZSkge1xuICAgICAgdGhpcy5jcmVhdGVNb2RlbCgpO1xuICAgIH1cblxuXG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKFxuICAgICAgZGF5LnllYXIsXG4gICAgICBkYXkubW9udGgsXG4gICAgICBkYXkubnVtYmVyLFxuICAgICAgdGhpcy5kYXRlLmdldEhvdXJzKCksXG4gICAgICB0aGlzLmRhdGUuZ2V0TWludXRlcygpLFxuICAgICAgdGhpcy5kYXRlLmdldFNlY29uZHMoKVxuICAgICk7XG5cbiAgICB0aGlzLnNldERhdGUoZGF0ZSk7XG4gIH1cblxuICBwdWJsaWMgc2VsZWN0TW9udGhSYW5nZShkYXk6IERheUl0ZW0pIHtcbiAgICBjb25zdCBkYXRlID0gbmV3IERhdGUoXG4gICAgICBkYXkueWVhcixcbiAgICAgIGRheS5tb250aCxcbiAgICAgICtkYXkubnVtYmVyLFxuICAgICAgMCxcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICk7XG5cbiAgICB0aGlzLnNldERhdGUoZGF0ZSk7XG4gIH1cblxuICBwdWJsaWMgc2VsZWN0UGVyaW9kKHBlcmlvZDogUGVyaW9kKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0ZWRQZXJpb2QpIHtcbiAgICAgIGlmICh0aGlzLnNlbGVjdGVkUGVyaW9kID09PSBwZXJpb2QpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFBlcmlvZC5zZWxlY3RlZCA9ICF0aGlzLnNlbGVjdGVkUGVyaW9kLnNlbGVjdGVkO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFBlcmlvZC5zZWxlY3RlZCA9IGZhbHNlO1xuICAgICAgICBwZXJpb2Quc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLnNlbGVjdGVkUGVyaW9kID0gcGVyaW9kO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBwZXJpb2Quc2VsZWN0ZWQgPSB0cnVlO1xuICAgICAgdGhpcy5zZWxlY3RlZFBlcmlvZCA9IHBlcmlvZDtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zZWxlY3RlZFBlcmlvZC5zZWxlY3RlZCkge1xuICAgICAgdGhpcy5wZXJpb2RDaGFuZ2UuZW1pdCh7XG4gICAgICAgIHBlcmlvZDogdGhpcy5zZWxlY3RlZFBlcmlvZC5wZXJpb2RJZCxcbiAgICAgICAgZnJvbTogdGhpcy5zZWxlY3RlZFBlcmlvZC5mcm9tLFxuICAgICAgICB0bzogdGhpcy5zZWxlY3RlZFBlcmlvZC50byxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnBlcmlvZENoYW5nZS5lbWl0KG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBkcmF3TW9udGhzKGRhdGUpIHtcbiAgICB0aGlzLm1vbnRoID0gdGhpcy5jcmVhdGVNb250aChkYXRlKTtcbiAgfVxuXG4gIHB1YmxpYyBjcmVhdGVNb250aChkYXRlOiBEYXRlKSB7XG4gICAgY29uc3QgbW9udGggPSBuZXcgTW9udGgoXG4gICAgICBkYXRlLFxuICAgICAgdGhpcy5zZWVkRGF0ZSxcbiAgICAgIHRoaXMucGVyaW9kV2Vla3MsXG4gICAgICB0aGlzLmRpc2FibGVkRGF5cyxcbiAgICAgIHRoaXMuaGlkZUV4dHJhRGF5cyxcbiAgICApO1xuXG4gICAgaWYgKHRoaXMuZGF0ZU1vZGUgPT09ICd3ZWVrJykge1xuICAgICAgdGhpcy53ZWVrRGF5c0xpc3QgPSBXRUVLREFZUy5tYXAoKF8sIGksIGFycikgPT4ge1xuICAgICAgICByZXR1cm4gYXJyWyhpICsgbW9udGguc2VlZERheSkgJSA3XTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndlZWtEYXlzTGlzdCA9IFdFRUtEQVlTLnNsaWNlKCk7XG4gICAgfVxuXG4gICAgbW9udGgucmVuZGVyRGF5cygpO1xuXG4gICAgaWYgKHRoaXMuZGF0ZU1vZGUgPT09ICd3ZWVrJyAmJiB0aGlzLnNlbGVjdGVkUGVyaW9kKSB7XG4gICAgICBjb25zdCBzZWxlY3RlZFBlcmlvZCA9IG1vbnRoLnVwZGF0ZVNlbGVjdGlvbkZvclBlcmlvZCh0aGlzLnNlbGVjdGVkUGVyaW9kKTtcblxuICAgICAgaWYgKHNlbGVjdGVkUGVyaW9kKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRQZXJpb2QgPSBzZWxlY3RlZFBlcmlvZDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbW9udGg7XG4gIH1cblxufVxuIiwiPHRhYmxlXG4gIFtjbGFzcy5tb250aC1yYW5nZV09XCJkYXRlTW9kZSA9PT0gJ21vbnRocmFuZ2UnXCJcbiAgW2NsYXNzLnJhbmdlLXNlbGVjdGVkXT1cIiEhc2VsZWN0ZWRSYW5nZS5mcm9tICYmICEhc2VsZWN0ZWRSYW5nZS50b1wiPlxuICA8dGhlYWQ+XG4gICAgPHRyPlxuICAgICAgPHRoICpuZ0lmPVwic2VlZERhdGUgJiYgcGVyaW9kV2Vla3NcIj4jPC90aD5cbiAgICAgIDx0aCAqbmdGb3I9XCJsZXQgd2Qgb2Ygd2Vla0RheXNMaXN0XCI+e3t3ZH19PC90aD5cbiAgICA8L3RyPlxuICA8L3RoZWFkPlxuXG4gIDx0Ym9keSBjbGFzcz1cImNhbGVuZGFyIGNhbGVuZGFyLXt7IG1vbnRoLm1vbnRoQW5kWWVhciB9fVwiID5cbiAgICA8bmctY29udGFpbmVyICpuZ0Zvcj1cImxldCB3ZWVrIG9mIG1vbnRoLndlZWtzXCI+XG4gICAgICA8dHIgY2xhc3M9XCJ3ZWVrXCJcbiAgICAgICAgICBbY2xhc3MuZmlyc3QtcGVyaW9kLXdlZWtdPVwid2Vlay5maXJzdFdlZWtJblBlcmlvZFwiXG4gICAgICAgICAgW2NsYXNzLmxhc3QtcGVyaW9kLXdlZWtdPVwid2Vlay5sYXN0V2Vla0luUGVyaW9kXCJcbiAgICAgICAgICBbY2xhc3MuaG92ZXJdPVwid2Vlay5wZXJpb2Q/Lm1vdXNlT3ZlclwiXG4gICAgICAgICAgKG1vdXNlZW50ZXIpPVwibW91c2VFbnRlcldlZWsod2VlaylcIlxuICAgICAgICAgIChtb3VzZWxlYXZlKT1cIm1vdXNlTGVhdmVXZWVrKHdlZWspXCJcbiAgICAgID5cbiAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cIndlZWsucGVyaW9kTGFibGVWaXNpYmxlXCI+XG4gICAgICAgICAgPHRkIGNsYXNzPVwicGVyaW9kXCJcbiAgICAgICAgICAgICAgW3Jvd1NwYW5dPVwid2Vlay5wZXJpb2QuY291bnRPZldlZWtzXCJcbiAgICAgICAgICAgICAgW2NsYXNzLnNlbGVjdGVkXT1cIndlZWsucGVyaW9kLnNlbGVjdGVkXCJcbiAgICAgICAgICAgICAgKGNsaWNrKT1cInNlbGVjdFBlcmlvZCh3ZWVrLnBlcmlvZClcIj5cbiAgICAgICAgICAgIHt7IHdlZWsucGVyaW9kLnBlcmlvZElkIH19XG4gICAgICAgICAgPC90ZD5cbiAgICAgICAgPC9uZy1jb250YWluZXI+XG5cbiAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdGb3I9XCJsZXQgZGF5IG9mIHdlZWsuZGF5c1wiPlxuICAgICAgICAgIDx0ZCBjbGFzcz1cInRpbGUgZGF5XCJcbiAgICAgICAgICAgICAgW2NsYXNzLmhpZGRlbi1kYXldPVwiaGlkZUV4dHJhRGF5cyAmJiBkYXkubXV0ZVwiXG4gICAgICAgICAgICAgIFtjbGFzcy5ub3ddPVwidG9kYXkuZGF0ZSA9PSBkYXkuZGF0ZVwiXG4gICAgICAgICAgICAgIFtjbGFzcy5tdXRlXT1cImRheS5tdXRlXCJcbiAgICAgICAgICAgICAgW2NsYXNzLnNlbGVjdGVkXT1cIihkYXkuc2VsZWN0ZWQgfHwgZGF5LmRhdGUgPT0gc2VsZWN0ZWQuZGF0ZSAmJiAhZGF5Lm11dGUpXCJcbiAgICAgICAgICAgICAgW2NsYXNzLnJhbmdlLWZyb21dPVwiZGF5LmRhdGUgPT09IHNlbGVjdGVkUmFuZ2UuZnJvbSAmJiAhZGF5Lm11dGUgJiYgc2VsZWN0ZWRSYW5nZS5mcm9tICE9PSBzZWxlY3RlZFJhbmdlLnRvXCJcbiAgICAgICAgICAgICAgW2NsYXNzLnJhbmdlLXRvXT1cImRheS5kYXRlID09PSBzZWxlY3RlZFJhbmdlLnRvICYmICFkYXkubXV0ZSAmJiBzZWxlY3RlZFJhbmdlLmZyb20gIT09IHNlbGVjdGVkUmFuZ2UudG9cIlxuICAgICAgICAgICAgICBbY2xhc3Muc2FtZS1yYW5nZS1kYXRlc109XCIoaGlkZUV4dHJhRGF5cyAmJiAhZGF5Lm11dGUpICYmIHNlbGVjdGVkUmFuZ2UuZnJvbSA9PT0gZGF5LmRhdGUgJiYgc2VsZWN0ZWRSYW5nZS5mcm9tID09PSBzZWxlY3RlZFJhbmdlLnRvXCJcbiAgICAgICAgICAgICAgW2NsYXNzLmhpZ2hsaWdodGVkXT1cIiFkYXkuZGlzYWJsZWQgJiYgIWRheS5tdXRlICYmICEhaGlnaGxpZ2h0ZWRSYW5nZURheXMuZGF0YVtkYXkuZGF0ZV1cIlxuICAgICAgICAgICAgICBbY2xhc3MuaGlnaGxpZ2h0LW1pbi1kYXRlXT1cImRheS5kYXRlID09PSBoaWdobGlnaHRlZFJhbmdlRGF5cy5taW5cIlxuICAgICAgICAgICAgICBbY2xhc3MuaGlnaGxpZ2h0LW1heC1kYXRlXT1cImRheS5kYXRlID09PSBoaWdobGlnaHRlZFJhbmdlRGF5cy5tYXhcIlxuICAgICAgICAgICAgICBbY2xhc3Mud2Vlay1tb2RlXT1cImRhdGVNb2RlID09PSAnd2VlaydcIlxuICAgICAgICAgICAgICBbY2xhc3MuZGlzYWJsZWRdPVwiZGF5LmRpc2FibGVkXCJcbiAgICAgICAgICAgICAgKGNsaWNrKT1cImRheUNsaWNrKGRheSwgd2VlaywgJGV2ZW50KVwiXG4gICAgICAgICAgICAgIChtb3VzZWVudGVyKT1cIm9uTW91c2VFbnRlckRheShkYXkpXCI+XG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwidGlsZS1jb250ZW50XCI+XG4gICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJ0aWxlLWRheS1sYWJlbFwiPlxuICAgICAgICAgICAgICAgIHt7IGRheS5udW1iZXIgfX1cbiAgICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8L3RkPlxuICAgICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICAgIDwvdHI+XG4gICAgPC9uZy1jb250YWluZXI+XG5cbiAgPCEtLTx0ciAqbmdJZj1cIm1vbnRoLndlZWtzLmxlbmd0aCA8IDZcIj5cbiAgICA8dGQgY29sc3Bhbj1cIjdcIiBjbGFzcz1cInRpbGVcIj48L3RkPlxuICA8L3RyPi0tPlxuICA8L3Rib2R5PlxuPC90YWJsZT5cbiJdfQ==