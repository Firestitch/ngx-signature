import { addDays, format, getDaysInMonth, lightFormat, subDays } from 'date-fns';
import { isDayDisabled } from '../../common/helpers/is-day-disabled';
import { Week } from './week';
import { Period } from './period';
const CALENDAR_DAYS_NUMBER = 42;
export class Month {
    constructor(date, seedDate, periodWeeks, _disabledDays, _hideExtraDays) {
        this.date = date;
        this.seedDate = seedDate;
        this.periodWeeks = periodWeeks;
        this._disabledDays = _disabledDays;
        this._hideExtraDays = _hideExtraDays;
        this.weeks = [];
        this._initMonth(date);
        if (this.seedDate && this.periodWeeks) {
            this._seedDay = seedDate.getDay();
            this._countTotalDaysInMonth(this._seedDay);
        }
        else {
            this._countTotalDaysInMonth(0);
        }
    }
    get seedDay() {
        return this._seedDay;
    }
    /**
     * Render days and weeks
     */
    renderDays() {
        let currentDate = subDays(this.date, this._prevMonthDaysCount);
        let daysToBeRendered = this._hideExtraDays
            ? getDaysInMonth(this.date) + this._prevMonthDaysCount
            : CALENDAR_DAYS_NUMBER;
        // only for week mode in mobile view!
        if (this._hideExtraDays && this.periodWeeks) {
            daysToBeRendered += 7 - (daysToBeRendered % 7);
        }
        let week;
        for (let d = 0; d < daysToBeRendered; d++) {
            const dayNumber = lightFormat(currentDate, 'd');
            if (d % 7 == 0) {
                week = new Week(currentDate, this.seedDate, this.periodWeeks);
                this.weeks.push(week);
            }
            const dayMuted = d - this._prevMonthDaysCount < 0
                || d >= this._daysInMonth + this._prevMonthDaysCount;
            week.addDay({
                mute: dayMuted,
                date: lightFormat(currentDate, 'yyyy-MM-dd'),
                number: dayNumber,
                month: currentDate.getMonth(),
                year: currentDate.getFullYear(),
                disabled: isDayDisabled(this._disabledDays, currentDate),
            });
            currentDate = addDays(currentDate, 1);
        }
        if (this.seedDate && this.periodWeeks) {
            this._groupWeeks();
            this._markFirstAndLastWeeks();
        }
    }
    getPeriodById(id) {
        if (!this.weeksByPeriod.has(id)) {
            return false;
        }
        return this.weeksByPeriod.get(id);
    }
    /**
     * Input period means that instance of period is not same instance
     * that was created for month.
     * It means that period and weeksByPeriod can have same periodIds but different object refs
     * @param period
     */
    updateSelectionForPeriod(period) {
        const p = this.getPeriodById(period.periodId);
        if (p && p.year === period.year) {
            p.selected = period.selected;
            return p;
        }
        else {
            return false;
        }
    }
    /**
     * Init base month field
     * @param date
     */
    _initMonth(date) {
        this.date = new Date(date);
        this.date.setDate(1);
        this._monthStartDay = this.date.getDay();
        this._daysInMonth = getDaysInMonth(this.date);
        this.name = format(this.date, 'MMMM');
        this.number = this.date.getMonth();
        this.year = this.date.getFullYear();
        this.monthAndYear = `${this.date.getFullYear()}-${this.date.getMonth()}`;
        this.months = [{ name: format(this.date, 'MMMM'), value: this.date.getMonth() }];
        this.years = [this.date.getFullYear()];
    }
    /**
     * Depends on week day start it counts total number of days in month
     * @param seedDay
     */
    _countTotalDaysInMonth(seedDay) {
        if (this._monthStartDay >= seedDay) {
            this._prevMonthDaysCount = this._monthStartDay - seedDay;
        }
        else {
            this._prevMonthDaysCount = 7 - (seedDay - this._monthStartDay);
        }
        // const totalDays = this._daysInMonth + this._prevMonthDaysCount;
        // this._totalDaysInMonth = Math.ceil(totalDays / 7) * 7;
    }
    /**
     * Just for easy usage
     */
    _groupWeeks() {
        this.weeksByPeriod = new Map();
        this.weeks.forEach((week) => {
            if (!this.weeksByPeriod.has(week.periodId)) {
                const newPeriod = new Period(week.periodId, week.dateStart, this.seedDate, this.periodWeeks);
                this.weeksByPeriod.set(week.periodId, newPeriod);
            }
            const period = this.weeksByPeriod
                .get(week.periodId);
            period.addWeek(week);
            week.addPeriod(period);
        });
    }
    _markFirstAndLastWeeks() {
        this.weeksByPeriod.forEach((period) => {
            period.markFirstLastWeeks();
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9udGguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGlicy9jYWxlbmRhci9tb2RlbHMvbW9udGgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE9BQU8sRUFBYSxNQUFNLEVBQUUsY0FBYyxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFNUYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBRXJFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDOUIsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVsQyxNQUFNLG9CQUFvQixHQUFHLEVBQUUsQ0FBQztBQUVoQyxNQUFNLE9BQU8sS0FBSztJQWtCaEIsWUFBbUIsSUFBVSxFQUNWLFFBQWMsRUFDZCxXQUFtQixFQUNsQixhQUFhLEVBQ2IsY0FBdUI7UUFKeEIsU0FBSSxHQUFKLElBQUksQ0FBTTtRQUNWLGFBQVEsR0FBUixRQUFRLENBQU07UUFDZCxnQkFBVyxHQUFYLFdBQVcsQ0FBUTtRQUNsQixrQkFBYSxHQUFiLGFBQWEsQ0FBQTtRQUNiLG1CQUFjLEdBQWQsY0FBYyxDQUFTO1FBZHBDLFVBQUssR0FBVyxFQUFFLENBQUM7UUFnQnhCLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFdEIsSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDckMsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM1QzthQUFNO1lBQ0wsSUFBSSxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2hDO0lBQ0gsQ0FBQztJQUVELElBQVcsT0FBTztRQUNoQixPQUFP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QUMsR0FBRyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7U0FDaEU7UUFFRCxrRUFBa0U7UUFDbEUseURBQXlEO0lBQzNELENBQUM7SUFFRDs7T0FFRztJQUNLLFdBQVc7UUFDakIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBRS9CLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDMUMsTUFBTSxTQUFTLEdBQUcsSUFBSSxNQUFNLENBQzFCLElBQUksQ0FBQyxRQUFRLEVBQ2IsSUFBSSxDQUFDLFNBQVMsRUFDZCxJQUFJLENBQUMsUUFBUSxFQUNiLElBQUksQ0FBQyxXQUFXLENBQ2pCLENBQUM7Z0JBRUYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQzthQUNsRDtZQUVELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhO2lCQUM5QixHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBRXRCLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFTyxzQkFBc0I7UUFDNUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtZQUNwQyxNQUFNLENBQUMsa0JBQWtCLEVBQUUsQ0FBQTtRQUM3QixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFkZERheXMsIGFkZE1vbnRocywgZm9ybWF0LCBnZXREYXlzSW5Nb250aCwgbGlnaHRGb3JtYXQsIHN1YkRheXMgfSBmcm9tICdkYXRlLWZucyc7XG5cbmltcG9ydCB7IGlzRGF5RGlzYWJsZWQgfSBmcm9tICcuLi8uLi9jb21tb24vaGVscGVycy9pcy1kYXktZGlzYWJsZWQnO1xuXG5pbXBvcnQgeyBXZWVrIH0gZnJvbSAnLi93ZWVrJztcbmltcG9ydCB7IFBlcmlvZCB9IGZyb20gJy4vcGVyaW9kJztcblxuY29uc3QgQ0FMRU5EQVJfREFZU19OVU1CRVIgPSA0MjtcblxuZXhwb3J0IGNsYXNzIE1vbnRoIHtcblxuICBwdWJsaWMgbmFtZTtcbiAgcHVibGljIG51bWJlcjtcbiAgcHVibGljIHllYXI7XG4gIHB1YmxpYyBtb250aEFuZFllYXI7XG4gIHB1YmxpYyBtb250aHM7XG4gIHB1YmxpYyB5ZWFycztcbiAgcHVibGljIHdlZWtzOiBXZWVrW10gPSBbXTtcbiAgcHVibGljIHdlZWtzQnlQZXJpb2Q6IE1hcDxudW1iZXIsIFBlcmlvZD47XG5cbiAgcHJpdmF0ZSBfcHJldk1vbnRoRGF5c0NvdW50OiBudW1iZXI7XG5cbiAgcHJpdmF0ZSBfbW9udGhTdGFydERheTogbnVtYmVyO1xuICBwcml2YXRlIF9kYXlzSW5Nb250aDogbnVtYmVyO1xuICBwcml2YXRlIF9zZWVkRGF5OiBudW1iZXI7XG5cblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgZGF0ZTogRGF0ZSxcbiAgICAgICAgICAgICAgcHVibGljIHNlZWREYXRlOiBEYXRlLFxuICAgICAgICAgICAgICBwdWJsaWMgcGVyaW9kV2Vla3M6IG51bWJlcixcbiAgICAgICAgICAgICAgcHJpdmF0ZSBfZGlzYWJsZWREYXlzLFxuICAgICAgICAgICAgICBwcml2YXRlIF9oaWRlRXh0cmFEYXlzOiBib29sZWFuLFxuICApIHtcbiAgICB0aGlzLl9pbml0TW9udGgoZGF0ZSk7XG5cbiAgICBpZiAodGhpcy5zZWVkRGF0ZSAmJiB0aGlzLnBlcmlvZFdlZWtzKSB7XG4gICAgICB0aGlzLl9zZWVkRGF5ID0gc2VlZERhdGUuZ2V0RGF5KCk7XG4gICAgICB0aGlzLl9jb3VudFRvdGFsRGF5c0luTW9udGgodGhpcy5fc2VlZERheSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2NvdW50VG90YWxEYXlzSW5Nb250aCgwKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0IHNlZWREYXkoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3NlZWREYXk7XG4gIH1cblxuICAvKipcbiAgICogUmVuZGVyIGRheXMgYW5kIHdlZWtzXG4gICAqL1xuICBwdWJsaWMgcmVuZGVyRGF5cygpIHtcbiAgICBsZXQgY3VycmVudERhdGUgPSBzdWJEYXlzKHRoaXMuZGF0ZSwgdGhpcy5fcHJldk1vbnRoRGF5c0NvdW50KTtcbiAgICBsZXQgZGF5c1RvQmVSZW5kZXJlZCA9IHRoaXMuX2hpZGVFeHRyYURheXNcbiAgICAgID8gZ2V0RGF5c0luTW9udGgodGhpcy5kYXRlKSArIHRoaXMuX3ByZXZNb250aERheXNDb3VudFxuICAgICAgOiBDQUxFTkRBUl9EQVlTX05VTUJFUjtcblxuICAgIC8vIG9ubHkgZm9yIHdlZWsgbW9kZSBpbiBtb2JpbGUgdmlldyFcbiAgICBpZiAodGhpcy5faGlkZUV4dHJhRGF5cyAmJiB0aGlzLnBlcmlvZFdlZWtzKSB7XG4gICAgICBkYXlzVG9CZVJlbmRlcmVkICs9IDcgLSAoZGF5c1RvQmVSZW5kZXJlZCAlIDcpO1xuICAgIH1cblxuICAgIGxldCB3ZWVrO1xuXG4gICAgZm9yIChsZXQgZCA9IDA7IGQgPCBkYXlzVG9CZVJlbmRlcmVkOyBkKyspIHtcbiAgICAgIGNvbnN0IGRheU51bWJlciA9IGxpZ2h0Rm9ybWF0KGN1cnJlbnREYXRlLCAnZCcpO1xuXG4gICAgICBpZiAoZCAlIDcgPT0gMCkge1xuICAgICAgICB3ZWVrID0gbmV3IFdlZWsoY3VycmVudERhdGUsIHRoaXMuc2VlZERhdGUsIHRoaXMucGVyaW9kV2Vla3MpO1xuXG4gICAgICAgIHRoaXMud2Vla3MucHVzaCh3ZWVrKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZGF5TXV0ZWQgPSBkIC0gdGhpcy5fcHJldk1vbnRoRGF5c0NvdW50IDwgMFxuICAgICAgICB8fCBkID49IHRoaXMuX2RheXNJbk1vbnRoICsgdGhpcy5fcHJldk1vbnRoRGF5c0NvdW50O1xuXG4gICAgICB3ZWVrLmFkZERheSh7XG4gICAgICAgIG11dGU6IGRheU11dGVkLFxuICAgICAgICBkYXRlOiBsaWdodEZvcm1hdChjdXJyZW50RGF0ZSwgJ3l5eXktTU0tZGQnKSxcbiAgICAgICAgbnVtYmVyOiBkYXlOdW1iZXIsXG4gICAgICAgIG1vbnRoOiBjdXJyZW50RGF0ZS5nZXRNb250aCgpLFxuICAgICAgICB5ZWFyOiBjdXJyZW50RGF0ZS5nZXRGdWxsWWVhcigpLFxuICAgICAgICBkaXNhYmxlZDogaXNEYXlEaXNhYmxlZCh0aGlzLl9kaXNhYmxlZERheXMsIGN1cnJlbnREYXRlKSxcbiAgICAgIH0pO1xuXG4gICAgICBjdXJyZW50RGF0ZSA9IGFkZERheXMoY3VycmVudERhdGUsIDEpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNlZWREYXRlICYmIHRoaXMucGVyaW9kV2Vla3MpIHtcbiAgICAgIHRoaXMuX2dyb3VwV2Vla3MoKTtcbiAgICAgIHRoaXMuX21hcmtGaXJzdEFuZExhc3RXZWVrcygpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBnZXRQZXJpb2RCeUlkKGlkOiBudW1iZXIpIHtcbiAgICBpZiAoIXRoaXMud2Vla3NCeVBlcmlvZC5oYXMoaWQpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMud2Vla3NCeVBlcmlvZC5nZXQoaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIElucHV0IHBlcmlvZCBtZWFucyB0aGF0IGluc3RhbmNlIG9mIHBlcmlvZCBpcyBub3Qgc2FtZSBpbnN0YW5jZVxuICAgKiB0aGF0IHdhcyBjcmVhdGVkIGZvciBtb250aC5cbiAgICogSXQgbWVhbnMgdGhhdCBwZXJpb2QgYW5kIHdlZWtzQnlQZXJpb2QgY2FuIGhhdmUgc2FtZSBwZXJpb2RJZHMgYnV0IGRpZmZlcmVudCBvYmplY3QgcmVmc1xuICAgKiBAcGFyYW0gcGVyaW9kXG4gICAqL1xuICBwdWJsaWMgdXBkYXRlU2VsZWN0aW9uRm9yUGVyaW9kKHBlcmlvZDogUGVyaW9kKSB7XG4gICAgY29uc3QgcCA9IHRoaXMuZ2V0UGVyaW9kQnlJZChwZXJpb2QucGVyaW9kSWQpO1xuXG4gICAgaWYgKHAgJiYgcC55ZWFyID09PSBwZXJpb2QueWVhcikge1xuICAgICAgcC5zZWxlY3RlZCA9IHBlcmlvZC5zZWxlY3RlZDtcblxuICAgICAgcmV0dXJuIHA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW5pdCBiYXNlIG1vbnRoIGZpZWxkXG4gICAqIEBwYXJhbSBkYXRlXG4gICAqL1xuICBwcml2YXRlIF9pbml0TW9udGgoZGF0ZTogRGF0ZSkge1xuICAgIHRoaXMuZGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xuICAgIHRoaXMuZGF0ZS5zZXREYXRlKDEpO1xuXG4gICAgdGhpcy5fbW9udGhTdGFydERheSA9IHRoaXMuZGF0ZS5nZXREYXkoKTtcbiAgICB0aGlzLl9kYXlzSW5Nb250aCA9IGdldERheXNJbk1vbnRoKHRoaXMuZGF0ZSk7XG5cbiAgICB0aGlzLm5hbWUgPSBmb3JtYXQodGhpcy5kYXRlLCAnTU1NTScpO1xuICAgIHRoaXMubnVtYmVyID0gdGhpcy5kYXRlLmdldE1vbnRoKCk7XG4gICAgdGhpcy55ZWFyID0gdGhpcy5kYXRlLmdldEZ1bGxZZWFyKCk7XG4gICAgdGhpcy5tb250aEFuZFllYXIgPSBgJHt0aGlzLmRhdGUuZ2V0RnVsbFllYXIoKX0tJHt0aGlzLmRhdGUuZ2V0TW9udGgoKX1gO1xuICAgIHRoaXMubW9udGhzID0gW3sgbmFtZTogZm9ybWF0KHRoaXMuZGF0ZSwgJ01NTU0nKSwgdmFsdWU6IHRoaXMuZGF0ZS5nZXRNb250aCgpIH1dO1xuICAgIHRoaXMueWVhcnMgPSBbIHRoaXMuZGF0ZS5nZXRGdWxsWWVhcigpIF07XG4gIH1cblxuICAvKipcbiAgICogRGVwZW5kcyBvbiB3ZWVrIGRheSBzdGFydCBpdCBjb3VudHMgdG90YWwgbnVtYmVyIG9mIGRheXMgaW4gbW9udGhcbiAgICogQHBhcmFtIHNlZWREYXlcbiAgICovXG4gIHByaXZhdGUgX2NvdW50VG90YWxEYXlzSW5Nb250aChzZWVkRGF5KSB7XG4gICAgaWYgKHRoaXMuX21vbnRoU3RhcnREYXkgPj0gc2VlZERheSkge1xuICAgICAgdGhpcy5fcHJldk1vbnRoRGF5c0NvdW50ID0gdGhpcy5fbW9udGhTdGFydERheSAtIHNlZWREYXk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX3ByZXZNb250aERheXNDb3VudCA9IDcgLSAoc2VlZERheSAtIHRoaXMuX21vbnRoU3RhcnREYXkpO1xuICAgIH1cblxuICAgIC8vIGNvbnN0IHRvdGFsRGF5cyA9IHRoaXMuX2RheXNJbk1vbnRoICsgdGhpcy5fcHJldk1vbnRoRGF5c0NvdW50O1xuICAgIC8vIHRoaXMuX3RvdGFsRGF5c0luTW9udGggPSBNYXRoLmNlaWwodG90YWxEYXlzIC8gNykgKiA3O1xuICB9XG5cbiAgLyoqXG4gICAqIEp1c3QgZm9yIGVhc3kgdXNhZ2VcbiAgICovXG4gIHByaXZhdGUgX2dyb3VwV2Vla3MoKSB7XG4gICAgdGhpcy53ZWVrc0J5UGVyaW9kID0gbmV3IE1hcCgpO1xuXG4gICAgdGhpcy53ZWVrcy5mb3JFYWNoKCh3ZWVrKSA9PiB7XG4gICAgICBpZiAoIXRoaXMud2Vla3NCeVBlcmlvZC5oYXMod2Vlay5wZXJpb2RJZCkpIHtcbiAgICAgICAgY29uc3QgbmV3UGVyaW9kID0gbmV3IFBlcmlvZChcbiAgICAgICAgICB3ZWVrLnBlcmlvZElkLFxuICAgICAgICAgIHdlZWsuZGF0ZVN0YXJ0LFxuICAgICAgICAgIHRoaXMuc2VlZERhdGUsXG4gICAgICAgICAgdGhpcy5wZXJpb2RXZWVrcyxcbiAgICAgICAgKTtcblxuICAgICAgICB0aGlzLndlZWtzQnlQZXJpb2Quc2V0KHdlZWsucGVyaW9kSWQsIG5ld1BlcmlvZCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBlcmlvZCA9IHRoaXMud2Vla3NCeVBlcmlvZFxuICAgICAgICAuZ2V0KHdlZWsucGVyaW9kSWQpO1xuXG4gICAgICBwZXJpb2QuYWRkV2Vlayh3ZWVrKTtcbiAgICAgIHdlZWsuYWRkUGVyaW9kKHBlcmlvZCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIF9tYXJrRmlyc3RBbmRMYXN0V2Vla3MoKSB7XG4gICAgdGhpcy53ZWVrc0J5UGVyaW9kLmZvckVhY2goKHBlcmlvZCkgPT4ge1xuICAgICAgcGVyaW9kLm1hcmtGaXJzdExhc3RXZWVrcygpXG4gICAgfSlcbiAgfVxufVxuIl19